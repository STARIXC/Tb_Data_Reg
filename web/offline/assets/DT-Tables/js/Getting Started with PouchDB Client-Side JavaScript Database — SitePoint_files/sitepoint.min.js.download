// ad project revision: 1.62.1
try {
/**
 * https://github.com/csnover/TraceKit
 * @license MIT
 * @namespace TraceKit
 */
(function(window, undefined) {
if (!window) {
    return;
}

var TraceKit = {};
var _oldTraceKit = window.top.TraceKit;

// global reference to slice
var _slice = [].slice;
var UNKNOWN_FUNCTION = '?';

// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error#Error_types
var ERROR_TYPES_RE = /^(?:[Uu]ncaught (?:exception: )?)?(?:((?:Eval|Internal|Range|Reference|Syntax|Type|URI|)Error): )?(.*)$/;

/**
 * A better form of hasOwnProperty<br/>
 * Example: `_has(MainHostObject, property) === true/false`
 *
 * @param {Object} object to check property
 * @param {string} key to check
 * @return {Boolean} true if the object has the key and it is not inherited
 */
function _has(object, key) {
    return Object.prototype.hasOwnProperty.call(object, key);
}

/**
 * Returns true if the parameter is undefined<br/>
 * Example: `_isUndefined(val) === true/false`
 *
 * @param {*} what Value to check
 * @return {Boolean} true if undefined and false otherwise
 */
function _isUndefined(what) {
    return typeof what === 'undefined';
}

/**
 * Export TraceKit out to another variable<br/>
 * Example: `var TK = TraceKit.noConflict()`
 * @return {Object} The TraceKit object
 * @memberof TraceKit
 */
TraceKit.noConflict = function noConflict() {
    window.top.TraceKit = _oldTraceKit;
    return TraceKit;
};

/**
 * Wrap any function in a TraceKit reporter<br/>
 * Example: `func = TraceKit.wrap(func);`
 *
 * @param {Function} func Function to be wrapped
 * @return {Function} The wrapped func
 * @memberof TraceKit
 */
TraceKit.wrap = function traceKitWrapper(func) {
    function wrapped() {
        try {
            return func.apply(this, arguments);
        } catch (e) {
            TraceKit.report(e);
            throw e;
        }
    }
    return wrapped;
};

/**
 * Cross-browser processing of unhandled exceptions
 *
 * Syntax:
 * ```js
 *   TraceKit.report.subscribe(function(stackInfo) { ... })
 *   TraceKit.report.unsubscribe(function(stackInfo) { ... })
 *   TraceKit.report(exception)
 *   try { ...code... } catch(ex) { TraceKit.report(ex); }
 * ```
 *
 * Supports:
 *   - Firefox: full stack trace with line numbers, plus column number
 *     on top frame; column number is not guaranteed
 *   - Opera: full stack trace with line and column numbers
 *   - Chrome: full stack trace with line and column numbers
 *   - Safari: line and column number for the top frame only; some frames
 *     may be missing, and column number is not guaranteed
 *   - IE: line and column number for the top frame only; some frames
 *     may be missing, and column number is not guaranteed
 *
 * In theory, TraceKit should work on all of the following versions:
 *   - IE5.5+ (only 8.0 tested)
 *   - Firefox 0.9+ (only 3.5+ tested)
 *   - Opera 7+ (only 10.50 tested; versions 9 and earlier may require
 *     Exceptions Have Stacktrace to be enabled in opera:config)
 *   - Safari 3+ (only 4+ tested)
 *   - Chrome 1+ (only 5+ tested)
 *   - Konqueror 3.5+ (untested)
 *
 * Requires TraceKit.computeStackTrace.
 *
 * Tries to catch all unhandled exceptions and report them to the
 * subscribed handlers. Please note that TraceKit.report will rethrow the
 * exception. This is REQUIRED in order to get a useful stack trace in IE.
 * If the exception does not reach the top of the browser, you will only
 * get a stack trace from the point where TraceKit.report was called.
 *
 * Handlers receive a TraceKit.StackTrace object as described in the
 * TraceKit.computeStackTrace docs.
 *
 * @memberof TraceKit
 * @namespace
 */
TraceKit.report = (function reportModuleWrapper() {
    var handlers = [],
        lastException = null,
        lastExceptionStack = null;

    /**
     * Add a crash handler.
     * @param {Function} handler
     * @memberof TraceKit.report
     */
    function subscribe(handler) {
        installGlobalHandler();
        installGlobalUnhandledRejectionHandler();
        handlers.push(handler);
    }

    /**
     * Remove a crash handler.
     * @param {Function} handler
     * @memberof TraceKit.report
     */
    function unsubscribe(handler) {
        for (var i = handlers.length - 1; i >= 0; --i) {
            if (handlers[i] === handler) {
                handlers.splice(i, 1);
            }
        }

        if (handlers.length === 0) {
            uninstallGlobalHandler();
            uninstallGlobalUnhandledRejectionHandler();
        }
    }

    /**
     * Dispatch stack information to all handlers.
     * @param {TraceKit.StackTrace} stack
     * @param {boolean} isWindowError Is this a top-level window error?
     * @param {Error=} error The error that's being handled (if available, null otherwise)
     * @memberof TraceKit.report
     * @throws An exception if an error occurs while calling an handler.
     */
    function notifyHandlers(stack, isWindowError, error) {
        var exception = null;
        if (isWindowError && !TraceKit.collectWindowErrors) {
          return;
        }
        for (var i in handlers) {
            if (_has(handlers, i)) {
                try {
                    handlers[i](stack, isWindowError, error);
                } catch (inner) {
                    exception = inner;
                }
            }
        }

        if (exception) {
            throw exception;
        }
    }

    var _oldOnerrorHandler, _onErrorHandlerInstalled;
    var _oldOnunhandledrejectionHandler, _onUnhandledRejectionHandlerInstalled;

    /**
     * Ensures all global unhandled exceptions are recorded.
     * Supported by Gecko and IE.
     * @param {string} message Error message.
     * @param {string} url URL of script that generated the exception.
     * @param {(number|string)} lineNo The line number at which the error occurred.
     * @param {(number|string)=} columnNo The column number at which the error occurred.
     * @param {Error=} errorObj The actual Error object.
     * @memberof TraceKit.report
     */
    function traceKitWindowOnError(message, url, lineNo, columnNo, errorObj) {
        var stack = null;

        if (lastExceptionStack) {
            TraceKit.computeStackTrace.augmentStackTraceWithInitialElement(lastExceptionStack, url, lineNo, message);
    	    processLastException();
        } else if (errorObj) {
            stack = TraceKit.computeStackTrace(errorObj);
            notifyHandlers(stack, true, errorObj);
        } else {
            var location = {
              'url': url,
              'line': lineNo,
              'column': columnNo
            };

            var name;
            var msg = message; // must be new var or will modify original `arguments`
            if ({}.toString.call(message) === '[object String]') {
                var groups = message.match(ERROR_TYPES_RE);
                if (groups) {
                    name = groups[1];
                    msg = groups[2];
                }
            }

            location.func = TraceKit.computeStackTrace.guessFunctionName(location.url, location.line);
            location.context = TraceKit.computeStackTrace.gatherContext(location.url, location.line);
            stack = {
                'name': name,
                'message': msg,
                'mode': 'onerror',
                'stack': [location]
            };

            notifyHandlers(stack, true, null);
        }

        if (_oldOnerrorHandler) {
            return _oldOnerrorHandler.apply(this, arguments);
        }

        return false;
    }

    /**
     * Ensures all unhandled rejections are recorded.
     * @param {PromiseRejectionEvent} e event.
     * @memberof TraceKit.report
     * @see https://developer.mozilla.org/en-US/docs/Web/API/WindowEventHandlers/onunhandledrejection
     * @see https://developer.mozilla.org/en-US/docs/Web/API/PromiseRejectionEvent
     */
    function traceKitWindowOnUnhandledRejection(e) {
        var stack = TraceKit.computeStackTrace(e.reason);
        notifyHandlers(stack, true, e.reason);
    }

    /**
     * Install a global onerror handler
     * @memberof TraceKit.report
     */
    function installGlobalHandler() {
        if (_onErrorHandlerInstalled === true) {
            return;
        }

        _oldOnerrorHandler = window.onerror;
        window.onerror = traceKitWindowOnError;
        _onErrorHandlerInstalled = true;
    }

    /**
     * Uninstall the global onerror handler
     * @memberof TraceKit.report
     */
    function uninstallGlobalHandler() {
        if (_onErrorHandlerInstalled) {
            window.onerror = _oldOnerrorHandler;
            _onErrorHandlerInstalled = false;
        }
    }

    /**
     * Install a global onunhandledrejection handler
     * @memberof TraceKit.report
     */
    function installGlobalUnhandledRejectionHandler() {
        if (_onUnhandledRejectionHandlerInstalled === true) {
            return;
        }

        _oldOnunhandledrejectionHandler = window.onunhandledrejection;
        window.onunhandledrejection = traceKitWindowOnUnhandledRejection;
        _onUnhandledRejectionHandlerInstalled = true;
    }

    /**
     * Uninstall the global onunhandledrejection handler
     * @memberof TraceKit.report
     */
    function uninstallGlobalUnhandledRejectionHandler() {
        if (_onUnhandledRejectionHandlerInstalled) {
            window.onerror = _oldOnunhandledrejectionHandler;
            _onUnhandledRejectionHandlerInstalled = false;
        }
    }

    /**
     * Process the most recent exception
     * @memberof TraceKit.report
     */
    function processLastException() {
        var _lastExceptionStack = lastExceptionStack,
            _lastException = lastException;
        lastExceptionStack = null;
        lastException = null;
        notifyHandlers(_lastExceptionStack, false, _lastException);
    }

    /**
     * Reports an unhandled Error to TraceKit.
     * @param {Error} ex
     * @memberof TraceKit.report
     * @throws An exception if an incomplete stack trace is detected (old IE browsers).
     */
    function report(ex) {
        if (lastExceptionStack) {
            if (lastException === ex) {
                return; // already caught by an inner catch block, ignore
            } else {
              processLastException();
            }
        }

        var stack = TraceKit.computeStackTrace(ex);
        lastExceptionStack = stack;
        lastException = ex;

        // If the stack trace is incomplete, wait for 2 seconds for
        // slow slow IE to see if onerror occurs or not before reporting
        // this exception; otherwise, we will end up with an incomplete
        // stack trace
        setTimeout(function () {
            if (lastException === ex) {
                processLastException();
            }
        }, (stack.incomplete ? 2000 : 0));

        throw ex; // re-throw to propagate to the top level (and cause window.onerror)
    }

    report.subscribe = subscribe;
    report.unsubscribe = unsubscribe;
    return report;
}());

/**
 * An object representing a single stack frame.
 * @typedef {Object} StackFrame
 * @property {string} url The JavaScript or HTML file URL.
 * @property {string} func The function name, or empty for anonymous functions (if guessing did not work).
 * @property {string[]?} args The arguments passed to the function, if known.
 * @property {number=} line The line number, if known.
 * @property {number=} column The column number, if known.
 * @property {string[]} context An array of source code lines; the middle element corresponds to the correct line#.
 * @memberof TraceKit
 */

/**
 * An object representing a JavaScript stack trace.
 * @typedef {Object} StackTrace
 * @property {string} name The name of the thrown exception.
 * @property {string} message The exception error message.
 * @property {TraceKit.StackFrame[]} stack An array of stack frames.
 * @property {string} mode 'stack', 'stacktrace', 'multiline', 'callers', 'onerror', or 'failed' -- method used to collect the stack trace.
 * @memberof TraceKit
 */

/**
 * TraceKit.computeStackTrace: cross-browser stack traces in JavaScript
 *
 * Syntax:
 *   ```js
 *   s = TraceKit.computeStackTrace.ofCaller([depth])
 *   s = TraceKit.computeStackTrace(exception) // consider using TraceKit.report instead (see below)
 *   ```
 *
 * Supports:
 *   - Firefox:  full stack trace with line numbers and unreliable column
 *               number on top frame
 *   - Opera 10: full stack trace with line and column numbers
 *   - Opera 9-: full stack trace with line numbers
 *   - Chrome:   full stack trace with line and column numbers
 *   - Safari:   line and column number for the topmost stacktrace element
 *               only
 *   - IE:       no line numbers whatsoever
 *
 * Tries to guess names of anonymous functions by looking for assignments
 * in the source code. In IE and Safari, we have to guess source file names
 * by searching for function bodies inside all page scripts. This will not
 * work for scripts that are loaded cross-domain.
 * Here be dragons: some function names may be guessed incorrectly, and
 * duplicate functions may be mismatched.
 *
 * TraceKit.computeStackTrace should only be used for tracing purposes.
 * Logging of unhandled exceptions should be done with TraceKit.report,
 * which builds on top of TraceKit.computeStackTrace and provides better
 * IE support by utilizing the window.onerror event to retrieve information
 * about the top of the stack.
 *
 * Note: In IE and Safari, no stack trace is recorded on the Error object,
 * so computeStackTrace instead walks its *own* chain of callers.
 * This means that:
 *  * in Safari, some methods may be missing from the stack trace;
 *  * in IE, the topmost function in the stack trace will always be the
 *    caller of computeStackTrace.
 *
 * This is okay for tracing (because you are likely to be calling
 * computeStackTrace from the function you want to be the topmost element
 * of the stack trace anyway), but not okay for logging unhandled
 * exceptions (because your catch block will likely be far away from the
 * inner function that actually caused the exception).
 *
 * Tracing example:
 *  ```js
 *     function trace(message) {
 *         var stackInfo = TraceKit.computeStackTrace.ofCaller();
 *         var data = message + "\n";
 *         for(var i in stackInfo.stack) {
 *             var item = stackInfo.stack[i];
 *             data += (item.func || '[anonymous]') + "() in " + item.url + ":" + (item.line || '0') + "\n";
 *         }
 *         if (window.console)
 *             console.info(data);
 *         else
 *             alert(data);
 *     }
 * ```
 * @memberof TraceKit
 * @namespace
 */
TraceKit.computeStackTrace = (function computeStackTraceWrapper() {
    var debug = false,
        sourceCache = {};

    /**
     * Attempts to retrieve source code via XMLHttpRequest, which is used
     * to look up anonymous function names.
     * @param {string} url URL of source code.
     * @return {string} Source contents.
     * @memberof TraceKit.computeStackTrace
     */
    function loadSource(url) {
        if (!TraceKit.remoteFetching) { //Only attempt request if remoteFetching is on.
            return '';
        }
        try {
            var getXHR = function() {
                try {
                    return new window.XMLHttpRequest();
                } catch (e) {
                    // explicitly bubble up the exception if not found
                    return new window.ActiveXObject('Microsoft.XMLHTTP');
                }
            };

            var request = getXHR();
            request.open('GET', url, false);
            request.send('');
            return request.responseText;
        } catch (e) {
            return '';
        }
    }

    /**
     * Retrieves source code from the source code cache.
     * @param {string} url URL of source code.
     * @return {Array.<string>} Source contents.
     * @memberof TraceKit.computeStackTrace
     */
    function getSource(url) {
        if (typeof url !== 'string') {
            return [];
        }

        if (!_has(sourceCache, url)) {
            // URL needs to be able to fetched within the acceptable domain.  Otherwise,
            // cross-domain errors will be triggered.
            /*
                Regex matches:
                0 - Full Url
                1 - Protocol
                2 - Domain
                3 - Port (Useful for internal applications)
                4 - Path
            */
            var source = '';
            var domain = '';
            try { domain = window.document.domain; } catch (e) { }
            var match = /(.*)\:\/\/([^:\/]+)([:\d]*)\/{0,1}([\s\S]*)/.exec(url);
            if (match && match[2] === domain) {
                source = loadSource(url);
            }
            sourceCache[url] = source ? source.split('\n') : [];
        }

        return sourceCache[url];
    }

    /**
     * Tries to use an externally loaded copy of source code to determine
     * the name of a function by looking at the name of the variable it was
     * assigned to, if any.
     * @param {string} url URL of source code.
     * @param {(string|number)} lineNo Line number in source code.
     * @return {string} The function name, if discoverable.
     * @memberof TraceKit.computeStackTrace
     */
    function guessFunctionName(url, lineNo) {
        var reFunctionArgNames = /function ([^(]*)\(([^)]*)\)/,
            reGuessFunction = /['"]?([0-9A-Za-z$_]+)['"]?\s*[:=]\s*(function|eval|new Function)/,
            line = '',
            maxLines = 10,
            source = getSource(url),
            m;

        if (!source.length) {
            return UNKNOWN_FUNCTION;
        }

        // Walk backwards from the first line in the function until we find the line which
        // matches the pattern above, which is the function definition
        for (var i = 0; i < maxLines; ++i) {
            line = source[lineNo - i] + line;

            if (!_isUndefined(line)) {
                if ((m = reGuessFunction.exec(line))) {
                    return m[1];
                } else if ((m = reFunctionArgNames.exec(line))) {
                    return m[1];
                }
            }
        }

        return UNKNOWN_FUNCTION;
    }

    /**
     * Retrieves the surrounding lines from where an exception occurred.
     * @param {string} url URL of source code.
     * @param {(string|number)} line Line number in source code to center around for context.
     * @return {?Array.<string>} Lines of source code.
     * @memberof TraceKit.computeStackTrace
     */
    function gatherContext(url, line) {
        var source = getSource(url);

        if (!source.length) {
            return null;
        }

        var context = [],
            // linesBefore & linesAfter are inclusive with the offending line.
            // if linesOfContext is even, there will be one extra line
            //   *before* the offending line.
            linesBefore = Math.floor(TraceKit.linesOfContext / 2),
            // Add one extra line if linesOfContext is odd
            linesAfter = linesBefore + (TraceKit.linesOfContext % 2),
            start = Math.max(0, line - linesBefore - 1),
            end = Math.min(source.length, line + linesAfter - 1);

        line -= 1; // convert to 0-based index

        for (var i = start; i < end; ++i) {
            if (!_isUndefined(source[i])) {
                context.push(source[i]);
            }
        }

        return context.length > 0 ? context : null;
    }

    /**
     * Escapes special characters, except for whitespace, in a string to be
     * used inside a regular expression as a string literal.
     * @param {string} text The string.
     * @return {string} The escaped string literal.
     * @memberof TraceKit.computeStackTrace
     */
    function escapeRegExp(text) {
        return text.replace(/[\-\[\]{}()*+?.,\\\^$|#]/g, '\\$&');
    }

    /**
     * Escapes special characters in a string to be used inside a regular
     * expression as a string literal. Also ensures that HTML entities will
     * be matched the same as their literal friends.
     * @param {string} body The string.
     * @return {string} The escaped string.
     * @memberof TraceKit.computeStackTrace
     */
    function escapeCodeAsRegExpForMatchingInsideHTML(body) {
        return escapeRegExp(body).replace('<', '(?:<|&lt;)').replace('>', '(?:>|&gt;)').replace('&', '(?:&|&amp;)').replace('"', '(?:"|&quot;)').replace(/\s+/g, '\\s+');
    }

    /**
     * Determines where a code fragment occurs in the source code.
     * @param {RegExp} re The function definition.
     * @param {Array.<string>} urls A list of URLs to search.
     * @return {?Object.<string, (string|number)>} An object containing
     * the url, line, and column number of the defined function.
     * @memberof TraceKit.computeStackTrace
     */
    function findSourceInUrls(re, urls) {
        var source, m;
        for (var i = 0, j = urls.length; i < j; ++i) {
            if ((source = getSource(urls[i])).length) {
                source = source.join('\n');
                if ((m = re.exec(source))) {

                    return {
                        'url': urls[i],
                        'line': source.substring(0, m.index).split('\n').length,
                        'column': m.index - source.lastIndexOf('\n', m.index) - 1
                    };
                }
            }
        }

        return null;
    }

    /**
     * Determines at which column a code fragment occurs on a line of the
     * source code.
     * @param {string} fragment The code fragment.
     * @param {string} url The URL to search.
     * @param {(string|number)} line The line number to examine.
     * @return {?number} The column number.
     * @memberof TraceKit.computeStackTrace
     */
    function findSourceInLine(fragment, url, line) {
        var source = getSource(url),
            re = new RegExp('\\b' + escapeRegExp(fragment) + '\\b'),
            m;

        line -= 1;

        if (source && source.length > line && (m = re.exec(source[line]))) {
            return m.index;
        }

        return null;
    }

    /**
     * Determines where a function was defined within the source code.
     * @param {(Function|string)} func A function reference or serialized
     * function definition.
     * @return {?Object.<string, (string|number)>} An object containing
     * the url, line, and column number of the defined function.
     * @memberof TraceKit.computeStackTrace
     */
    function findSourceByFunctionBody(func) {
        if (_isUndefined(window && window.document)) {
            return;
        }

        var urls = [window.location.href],
            scripts = window.document.getElementsByTagName('script'),
            body,
            code = '' + func,
            codeRE = /^function(?:\s+([\w$]+))?\s*\(([\w\s,]*)\)\s*\{\s*(\S[\s\S]*\S)\s*\}\s*$/,
            eventRE = /^function on([\w$]+)\s*\(event\)\s*\{\s*(\S[\s\S]*\S)\s*\}\s*$/,
            re,
            parts,
            result;

        for (var i = 0; i < scripts.length; ++i) {
            var script = scripts[i];
            if (script.src) {
                urls.push(script.src);
            }
        }

        if (!(parts = codeRE.exec(code))) {
            re = new RegExp(escapeRegExp(code).replace(/\s+/g, '\\s+'));
        }

        // not sure if this is really necessary, but I donâ€™t have a test
        // corpus large enough to confirm that and it was in the original.
        else {
            var name = parts[1] ? '\\s+' + parts[1] : '',
                args = parts[2].split(',').join('\\s*,\\s*');

            body = escapeRegExp(parts[3]).replace(/;$/, ';?'); // semicolon is inserted if the function ends with a comment.replace(/\s+/g, '\\s+');
            re = new RegExp('function' + name + '\\s*\\(\\s*' + args + '\\s*\\)\\s*{\\s*' + body + '\\s*}');
        }

        // look for a normal function definition
        if ((result = findSourceInUrls(re, urls))) {
            return result;
        }

        // look for an old-school event handler function
        if ((parts = eventRE.exec(code))) {
            var event = parts[1];
            body = escapeCodeAsRegExpForMatchingInsideHTML(parts[2]);

            // look for a function defined in HTML as an onXXX handler
            re = new RegExp('on' + event + '=[\\\'"]\\s*' + body + '\\s*[\\\'"]', 'i');

            if ((result = findSourceInUrls(re, urls[0]))) {
                return result;
            }

            // look for ???
            re = new RegExp(body);

            if ((result = findSourceInUrls(re, urls))) {
                return result;
            }
        }

        return null;
    }

    // Contents of Exception in various browsers.
    //
    // SAFARI:
    // ex.message = Can't find variable: qq
    // ex.line = 59
    // ex.sourceId = 580238192
    // ex.sourceURL = http://...
    // ex.expressionBeginOffset = 96
    // ex.expressionCaretOffset = 98
    // ex.expressionEndOffset = 98
    // ex.name = ReferenceError
    //
    // FIREFOX:
    // ex.message = qq is not defined
    // ex.fileName = http://...
    // ex.lineNumber = 59
    // ex.columnNumber = 69
    // ex.stack = ...stack trace... (see the example below)
    // ex.name = ReferenceError
    //
    // CHROME:
    // ex.message = qq is not defined
    // ex.name = ReferenceError
    // ex.type = not_defined
    // ex.arguments = ['aa']
    // ex.stack = ...stack trace...
    //
    // INTERNET EXPLORER:
    // ex.message = ...
    // ex.name = ReferenceError
    //
    // OPERA:
    // ex.message = ...message... (see the example below)
    // ex.name = ReferenceError
    // ex.opera#sourceloc = 11  (pretty much useless, duplicates the info in ex.message)
    // ex.stacktrace = n/a; see 'opera:config#UserPrefs|Exceptions Have Stacktrace'

    /**
     * Computes stack trace information from the stack property.
     * Chrome and Gecko use this property.
     * @param {Error} ex
     * @return {?TraceKit.StackTrace} Stack trace information.
     * @memberof TraceKit.computeStackTrace
     */
    function computeStackTraceFromStackProp(ex) {
        if (!ex.stack) {
            return null;
        }

        var chrome = /^\s*at (.*?) ?\(((?:file|https?|blob|chrome-extension|native|eval|webpack|<anonymous>|\/).*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,
            gecko = /^\s*(.*?)(?:\((.*?)\))?(?:^|@)((?:file|https?|blob|chrome|webpack|resource|\[native).*?|[^@]*bundle)(?::(\d+))?(?::(\d+))?\s*$/i,
            winjs = /^\s*at (?:((?:\[object object\])?.+) )?\(?((?:file|ms-appx|https?|webpack|blob):.*?):(\d+)(?::(\d+))?\)?\s*$/i,

            // Used to additionally parse URL/line/column from eval frames
            isEval,
            geckoEval = /(\S+) line (\d+)(?: > eval line \d+)* > eval/i,
            chromeEval = /\((\S*)(?::(\d+))(?::(\d+))\)/,

            lines = ex.stack.split('\n'),
            stack = [],
            submatch,
            parts,
            element,
            reference = /^(.*) is undefined$/.exec(ex.message);

        for (var i = 0, j = lines.length; i < j; ++i) {
            if ((parts = chrome.exec(lines[i]))) {
                var isNative = parts[2] && parts[2].indexOf('native') === 0; // start of line
                isEval = parts[2] && parts[2].indexOf('eval') === 0; // start of line
                if (isEval && (submatch = chromeEval.exec(parts[2]))) {
                    // throw out eval line/column and use top-most line/column number
                    parts[2] = submatch[1]; // url
                    parts[3] = submatch[2]; // line
                    parts[4] = submatch[3]; // column
                }
                element = {
                    'url': !isNative ? parts[2] : null,
                    'func': parts[1] || UNKNOWN_FUNCTION,
                    'args': isNative ? [parts[2]] : [],
                    'line': parts[3] ? +parts[3] : null,
                    'column': parts[4] ? +parts[4] : null
                };
            } else if ( parts = winjs.exec(lines[i]) ) {
                element = {
                    'url': parts[2],
                    'func': parts[1] || UNKNOWN_FUNCTION,
                    'args': [],
                    'line': +parts[3],
                    'column': parts[4] ? +parts[4] : null
                };
            } else if ((parts = gecko.exec(lines[i]))) {
                isEval = parts[3] && parts[3].indexOf(' > eval') > -1;
                if (isEval && (submatch = geckoEval.exec(parts[3]))) {
                    // throw out eval line/column and use top-most line number
                    parts[3] = submatch[1];
                    parts[4] = submatch[2];
                    parts[5] = null; // no column when eval
                } else if (i === 0 && !parts[5] && !_isUndefined(ex.columnNumber)) {
                    // FireFox uses this awesome columnNumber property for its top frame
                    // Also note, Firefox's column number is 0-based and everything else expects 1-based,
                    // so adding 1
                    // NOTE: this hack doesn't work if top-most frame is eval
                    stack[0].column = ex.columnNumber + 1;
                }
                element = {
                    'url': parts[3],
                    'func': parts[1] || UNKNOWN_FUNCTION,
                    'args': parts[2] ? parts[2].split(',') : [],
                    'line': parts[4] ? +parts[4] : null,
                    'column': parts[5] ? +parts[5] : null
                };
            } else {
                continue;
            }

            if (!element.func && element.line) {
                element.func = guessFunctionName(element.url, element.line);
            }

            element.context = element.line ? gatherContext(element.url, element.line) : null;
            stack.push(element);
        }

        if (!stack.length) {
            return null;
        }

        if (stack[0] && stack[0].line && !stack[0].column && reference) {
            stack[0].column = findSourceInLine(reference[1], stack[0].url, stack[0].line);
        }

        return {
            'mode': 'stack',
            'name': ex.name,
            'message': ex.message,
            'stack': stack
        };
    }

    /**
     * Computes stack trace information from the stacktrace property.
     * Opera 10+ uses this property.
     * @param {Error} ex
     * @return {?TraceKit.StackTrace} Stack trace information.
     * @memberof TraceKit.computeStackTrace
     */
    function computeStackTraceFromStacktraceProp(ex) {
        // Access and store the stacktrace property before doing ANYTHING
        // else to it because Opera is not very good at providing it
        // reliably in other circumstances.
        var stacktrace = ex.stacktrace;
        if (!stacktrace) {
            return;
        }

        var opera10Regex = / line (\d+).*script (?:in )?(\S+)(?:: in function (\S+))?$/i,
            opera11Regex = / line (\d+), column (\d+)\s*(?:in (?:<anonymous function: ([^>]+)>|([^\)]+))\((.*)\))? in (.*):\s*$/i,
            lines = stacktrace.split('\n'),
            stack = [],
            parts;

        for (var line = 0; line < lines.length; line += 2) {
            var element = null;
            if ((parts = opera10Regex.exec(lines[line]))) {
                element = {
                    'url': parts[2],
                    'line': +parts[1],
                    'column': null,
                    'func': parts[3],
                    'args':[]
                };
            } else if ((parts = opera11Regex.exec(lines[line]))) {
                element = {
                    'url': parts[6],
                    'line': +parts[1],
                    'column': +parts[2],
                    'func': parts[3] || parts[4],
                    'args': parts[5] ? parts[5].split(',') : []
                };
            }

            if (element) {
                if (!element.func && element.line) {
                    element.func = guessFunctionName(element.url, element.line);
                }
                if (element.line) {
                    try {
                        element.context = gatherContext(element.url, element.line);
                    } catch (exc) {}
                }

                if (!element.context) {
                    element.context = [lines[line + 1]];
                }

                stack.push(element);
            }
        }

        if (!stack.length) {
            return null;
        }

        return {
            'mode': 'stacktrace',
            'name': ex.name,
            'message': ex.message,
            'stack': stack
        };
    }

    /**
     * NOT TESTED.
     * Computes stack trace information from an error message that includes
     * the stack trace.
     * Opera 9 and earlier use this method if the option to show stack
     * traces is turned on in opera:config.
     * @param {Error} ex
     * @return {?TraceKit.StackTrace} Stack information.
     * @memberof TraceKit.computeStackTrace
     */
    function computeStackTraceFromOperaMultiLineMessage(ex) {
        // TODO: Clean this function up
        // Opera includes a stack trace into the exception message. An example is:
        //
        // Statement on line 3: Undefined variable: undefinedFunc
        // Backtrace:
        //   Line 3 of linked script file://localhost/Users/andreyvit/Projects/TraceKit/javascript-client/sample.js: In function zzz
        //         undefinedFunc(a);
        //   Line 7 of inline#1 script in file://localhost/Users/andreyvit/Projects/TraceKit/javascript-client/sample.html: In function yyy
        //           zzz(x, y, z);
        //   Line 3 of inline#1 script in file://localhost/Users/andreyvit/Projects/TraceKit/javascript-client/sample.html: In function xxx
        //           yyy(a, a, a);
        //   Line 1 of function script
        //     try { xxx('hi'); return false; } catch(ex) { TraceKit.report(ex); }
        //   ...

        var lines = ex.message.split('\n');
        if (lines.length < 4) {
            return null;
        }

        var lineRE1 = /^\s*Line (\d+) of linked script ((?:file|https?|blob)\S+)(?:: in function (\S+))?\s*$/i,
            lineRE2 = /^\s*Line (\d+) of inline#(\d+) script in ((?:file|https?|blob)\S+)(?:: in function (\S+))?\s*$/i,
            lineRE3 = /^\s*Line (\d+) of function script\s*$/i,
            stack = [],
            scripts = (window && window.document && window.document.getElementsByTagName('script')),
            inlineScriptBlocks = [],
            parts;

        for (var s in scripts) {
            if (_has(scripts, s) && !scripts[s].src) {
                inlineScriptBlocks.push(scripts[s]);
            }
        }

        for (var line = 2; line < lines.length; line += 2) {
            var item = null;
            if ((parts = lineRE1.exec(lines[line]))) {
                item = {
                    'url': parts[2],
                    'func': parts[3],
                    'args': [],
                    'line': +parts[1],
                    'column': null
                };
            } else if ((parts = lineRE2.exec(lines[line]))) {
                item = {
                    'url': parts[3],
                    'func': parts[4],
                    'args': [],
                    'line': +parts[1],
                    'column': null // TODO: Check to see if inline#1 (+parts[2]) points to the script number or column number.
                };
                var relativeLine = (+parts[1]); // relative to the start of the <SCRIPT> block
                var script = inlineScriptBlocks[parts[2] - 1];
                if (script) {
                    var source = getSource(item.url);
                    if (source) {
                        source = source.join('\n');
                        var pos = source.indexOf(script.innerText);
                        if (pos >= 0) {
                            item.line = relativeLine + source.substring(0, pos).split('\n').length;
                        }
                    }
                }
            } else if ((parts = lineRE3.exec(lines[line]))) {
                var url = window.location.href.replace(/#.*$/, '');
                var re = new RegExp(escapeCodeAsRegExpForMatchingInsideHTML(lines[line + 1]));
                var src = findSourceInUrls(re, [url]);
                item = {
                    'url': url,
                    'func': '',
                    'args': [],
                    'line': src ? src.line : parts[1],
                    'column': null
                };
            }

            if (item) {
                if (!item.func) {
                    item.func = guessFunctionName(item.url, item.line);
                }
                var context = gatherContext(item.url, item.line);
                var midline = (context ? context[Math.floor(context.length / 2)] : null);
                if (context && midline.replace(/^\s*/, '') === lines[line + 1].replace(/^\s*/, '')) {
                    item.context = context;
                } else {
                    // if (context) alert("Context mismatch. Correct midline:\n" + lines[i+1] + "\n\nMidline:\n" + midline + "\n\nContext:\n" + context.join("\n") + "\n\nURL:\n" + item.url);
                    item.context = [lines[line + 1]];
                }
                stack.push(item);
            }
        }
        if (!stack.length) {
            return null; // could not parse multiline exception message as Opera stack trace
        }

        return {
            'mode': 'multiline',
            'name': ex.name,
            'message': lines[0],
            'stack': stack
        };
    }

    /**
     * Adds information about the first frame to incomplete stack traces.
     * Safari and IE require this to get complete data on the first frame.
     * @param {TraceKit.StackTrace} stackInfo Stack trace information from
     * one of the compute* methods.
     * @param {string} url The URL of the script that caused an error.
     * @param {(number|string)} lineNo The line number of the script that
     * caused an error.
     * @param {string=} message The error generated by the browser, which
     * hopefully contains the name of the object that caused the error.
     * @return {boolean} Whether or not the stack information was
     * augmented.
     * @memberof TraceKit.computeStackTrace
     */
    function augmentStackTraceWithInitialElement(stackInfo, url, lineNo, message) {
        var initial = {
            'url': url,
            'line': lineNo
        };

        if (initial.url && initial.line) {
            stackInfo.incomplete = false;

            if (!initial.func) {
                initial.func = guessFunctionName(initial.url, initial.line);
            }

            if (!initial.context) {
                initial.context = gatherContext(initial.url, initial.line);
            }

            var reference = / '([^']+)' /.exec(message);
            if (reference) {
                initial.column = findSourceInLine(reference[1], initial.url, initial.line);
            }

            if (stackInfo.stack.length > 0) {
                if (stackInfo.stack[0].url === initial.url) {
                    if (stackInfo.stack[0].line === initial.line) {
                        return false; // already in stack trace
                    } else if (!stackInfo.stack[0].line && stackInfo.stack[0].func === initial.func) {
                        stackInfo.stack[0].line = initial.line;
                        stackInfo.stack[0].context = initial.context;
                        return false;
                    }
                }
            }

            stackInfo.stack.unshift(initial);
            stackInfo.partial = true;
            return true;
        } else {
            stackInfo.incomplete = true;
        }

        return false;
    }

    /**
     * Computes stack trace information by walking the arguments.caller
     * chain at the time the exception occurred. This will cause earlier
     * frames to be missed but is the only way to get any stack trace in
     * Safari and IE. The top frame is restored by
     * {@link augmentStackTraceWithInitialElement}.
     * @param {Error} ex
     * @return {TraceKit.StackTrace=} Stack trace information.
     * @memberof TraceKit.computeStackTrace
     */
    function computeStackTraceByWalkingCallerChain(ex, depth) {
        var functionName = /function\s+([_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*)?\s*\(/i,
            stack = [],
            funcs = {},
            recursion = false,
            parts,
            item,
            source;

        for (var curr = computeStackTraceByWalkingCallerChain.caller; curr && !recursion; curr = curr.caller) {
            if (curr === computeStackTrace || curr === TraceKit.report) {
                continue;
            }

            item = {
                'url': null,
                'func': UNKNOWN_FUNCTION,
                'args': [],
                'line': null,
                'column': null
            };

            if (curr.name) {
                item.func = curr.name;
            } else if ((parts = functionName.exec(curr.toString()))) {
                item.func = parts[1];
            }

            if (typeof item.func === 'undefined') {
              try {
                item.func = parts.input.substring(0, parts.input.indexOf('{'));
              } catch (e) { }
            }

            if ((source = findSourceByFunctionBody(curr))) {
                item.url = source.url;
                item.line = source.line;

                if (item.func === UNKNOWN_FUNCTION) {
                    item.func = guessFunctionName(item.url, item.line);
                }

                var reference = / '([^']+)' /.exec(ex.message || ex.description);
                if (reference) {
                    item.column = findSourceInLine(reference[1], source.url, source.line);
                }
            }

            if (funcs['' + curr]) {
                recursion = true;
            }else{
                funcs['' + curr] = true;
            }

            stack.push(item);
        }

        if (depth) {
            stack.splice(0, depth);
        }

        var result = {
            'mode': 'callers',
            'name': ex.name,
            'message': ex.message,
            'stack': stack
        };
        augmentStackTraceWithInitialElement(result, ex.sourceURL || ex.fileName, ex.line || ex.lineNumber, ex.message || ex.description);
        return result;
    }

    /**
     * Computes a stack trace for an exception.
     * @param {Error} ex
     * @param {(string|number)=} depth
     * @memberof TraceKit.computeStackTrace
     */
    function computeStackTrace(ex, depth) {
        var stack = null;
        depth = (depth == null ? 0 : +depth);

        try {
            // This must be tried first because Opera 10 *destroys*
            // its stacktrace property if you try to access the stack
            // property first!!
            stack = computeStackTraceFromStacktraceProp(ex);
            if (stack) {
                if(_has(ex, 'bidder')) {
                   stack.bidder = ex.bidder;
                }
                return stack;
            }
        } catch (e) {
            if (debug) {
                throw e;
            }
        }

        try {
            stack = computeStackTraceFromStackProp(ex);
            if (stack) {
                if(_has(ex, 'bidder')) {
                   stack.bidder = ex.bidder;
                }
                return stack;
            }
        } catch (e) {
            if (debug) {
                throw e;
            }
        }

        try {
            stack = computeStackTraceFromOperaMultiLineMessage(ex);
            if (stack) {
                if(_has(ex, 'bidder')) {
                   stack.bidder = ex.bidder;
                }
                return stack;
            }
        } catch (e) {
            if (debug) {
                throw e;
            }
        }

        try {
            stack = computeStackTraceByWalkingCallerChain(ex, depth + 1);
            if (stack) {
                if(_has(ex, 'bidder')) {
                   stack.bidder = ex.bidder;
                }
                return stack;
            }
        } catch (e) {
            if (debug) {
                throw e;
            }
        }

        return {
            'name': ex.name,
            'message': ex.message,
            'mode': 'failed'
        };
    }

    /**
     * Logs a stacktrace starting from the previous call and working down.
     * @param {(number|string)=} depth How many frames deep to trace.
     * @return {TraceKit.StackTrace} Stack trace information.
     * @memberof TraceKit.computeStackTrace
     */
    function computeStackTraceOfCaller(depth) {
        depth = (depth == null ? 0 : +depth) + 1; // "+ 1" because "ofCaller" should drop one frame
        try {
            throw new Error();
        } catch (ex) {
            return computeStackTrace(ex, depth + 1);
        }
    }

    computeStackTrace.augmentStackTraceWithInitialElement = augmentStackTraceWithInitialElement;
    computeStackTrace.computeStackTraceFromStackProp = computeStackTraceFromStackProp;
    computeStackTrace.guessFunctionName = guessFunctionName;
    computeStackTrace.gatherContext = gatherContext;
    computeStackTrace.ofCaller = computeStackTraceOfCaller;
    computeStackTrace.getSource = getSource;

    return computeStackTrace;
}());

/**
 * Extends support for global error handling for asynchronous browser
 * functions. Adopted from Closure Library's errorhandler.js
 * @memberof TraceKit
 */
TraceKit.extendToAsynchronousCallbacks = function () {
    var _helper = function _helper(fnName) {
        var originalFn = window[fnName];
        window[fnName] = function traceKitAsyncExtension() {
            // Make a copy of the arguments
            var args = _slice.call(arguments);
            var originalCallback = args[0];
            if (typeof (originalCallback) === 'function') {
                args[0] = TraceKit.wrap(originalCallback);
            }
            // IE < 9 doesn't support .call/.apply on setInterval/setTimeout, but it
            // also only supports 2 argument and doesn't care what "this" is, so we
            // can just call the original function directly.
            if (originalFn.apply) {
                return originalFn.apply(this, args);
            } else {
                return originalFn(args[0], args[1]);
            }
        };
    };

    _helper('setTimeout');
    _helper('setInterval');
};

/**
 * Default function to track errors to Proper Medias back end.
 * Function gets overwritten by sendError(error) in the ad_project
 * file. 
 * @param error
 */
TraceKit.defaultSendError = function(error) {
    'use strict';
    try {
        if (!error.stack) {
            error.stack = (new Error('force-added stack')).stack;
            if (error.stack) {
                error.stack = error.stack.toString();
            }
        }
        if(!error.name) {
            error.name = 'Unknown';
        }
        if(!error.message) {
            error.message = 'Unknown';
        }

    } catch (e) {
        console.error("Error building error data");
        console.error(e);
    }

    try {

        var postData = {
            'client_timestamp' : new Date().getTime(),
            'event_id'         : '',
            'page_id'          : '',
            'session_id'       : '',
            'bidder'           : '',
            'user_id'          : '',
            'publisher'        : '',
            'rtp_file_version' : '',
            'ad_project_tag'   : '',
            'page_url'         : window.top.location.href || window.location.href || '',
            'in_iframe'        : false,
            'is_https'         : ('https:' == document.location.protocol) ? true : false,
            'user_agent'       : navigator.userAgent || '',
            'stack_trace'      : JSON.stringify(error.stack),
            'error_message'    : error.message.toString(),
            'error_name'       : error.name.toString()
        }

        // Must encode data
        if(postData && typeof(postData) === 'object') {
            var y = '', z = encodeURIComponent;
            for (var x in postData) {
               y += '&' + z(x) + '=' + z(postData[x]);
            }
            postData = y.slice(1);
        }

        //send ajax request
        var xhr = null; //new (this.XMLHttpRequest || ActiveXObject)('MSXML2.XMLHTTP.3.0');
        if(window.ActiveXObject) { 
            xhr = new ActiveXObject('Microsoft.XMLHTTP'); 
        } else if(window.XMLHttpRequest) { 
            xhr = new XMLHttpRequest(); 
        }

        // URL to send data to
        var request_url = 'https://events.proper.io/api/event';

        xhr.open("POST", request_url, 1);
        xhr.withCredentials = false;

        xhr.timeout = 2000; // time in milliseconds

        xhr.onload = function() {
            if(xhr.status == 200) { 
                // callback(xhr.responseText, xhr);
            } else { 
                console.error("Error sending exception data. xhr.status: " + xhr.status);
            }
        }

        xhr.send(postData);

    } catch (e) { 
        console.error("Error sending exception data");
        console.error(e);
    }
}

TraceKit.report.subscribe(TraceKit.defaultSendError);

//Default options:
if (!TraceKit.remoteFetching) {
    TraceKit.remoteFetching = false;
}
if (!TraceKit.collectWindowErrors) {
    TraceKit.collectWindowErrors = false;
}
if (!TraceKit.linesOfContext || TraceKit.linesOfContext < 1) {
    // 5 lines before, the offending line, 5 lines after
    TraceKit.linesOfContext = 11;
}

// Export
window.top.TraceKit = TraceKit;

}(typeof window !== 'undefined' ? window : global));

var ProperMedia = ProperMedia || {}; //define class if doesn't exist

ProperMedia.utils = (function(win, document) {

    // TraceKit Object
    var TraceKit = window.top.TraceKit;

    //needed for document ready function
    var readyList = [];
    var readyFired = false;
    var readyEventHandlersInstalled = false;

    // call this when the document is ready
    function ready() {
        if (!readyFired) {
            // this must be set to true before we start calling callbacks
            readyFired = true;
            for (var i = 0; i < readyList.length; i++) {
                readyList[i].fn.call(win, readyList[i].ctx);
            }
            // allow any closures held by these functions to free
            readyList = [];
        }
    }

    // call this when the document is ready
    function readyStateChange() {
        if ( document.readyState === "complete" ) {
            ready();
        }
    }

    // cross browser version of jquery's $( document ).ready() function
    var docReady = function(callback, context) {
        // if ready has already fired, then just schedule the callback
        // to fire asynchronously, but right away
        if (readyFired) {
            properSetTimeout.setTimeout(function() {callback(context);}, 1);
            return;
        } else {
            // add the function and context to the list
            readyList.push({fn: callback, ctx: context});
        }
        // if document already ready to go, schedule the ready function to run
        if (document.readyState === "complete") {
            properSetTimeout.setTimeout(ready, 1);
        } else if (!readyEventHandlersInstalled) {
            if (document.addEventListener) {
                document.addEventListener("DOMContentLoaded", TraceKit.wrap(ready), false);
                win.addEventListener("load", TraceKit.wrap(ready), false);
            } else {
                document.attachEvent("onreadystatechange", TraceKit.wrap(readyStateChange));
                win.attachEvent("onload", TraceKit.wrap(ready));
            }
            readyEventHandlersInstalled = true;
        }
    }

	// merge object function because Object.assign does not work on IE10/11
	function mergeObject(target) {

		// iterates over argument(s) (source objects)
	    for (var i = 1; i < arguments.length; i++) {
	        var source = arguments[i];

			// iterate over properties of source object
			for (var key in source) {

				// if source object has a value of property ...
	            if (source.hasOwnProperty(key)) {

					// ... copy property to target object
	                target[key] = source[key];
	            }
	        }
	    }

		// return target object
	    return target;
	}

    //recreating jquery selector
    var jquery_utils = {
        obj: {},
        sel: function (val) {
            if (typeof val === "function") { //shorthand for $( document ).ready()
                docReady(val);
            }
            else if (typeof val === "object") this.obj = val;
            else this.obj = document.querySelectorAll(val)[0];

            return this;
        },
        ready: function(func) {
            docReady(func);
            return this;
        },
        remove: function () {
            if(typeof this.obj === 'undefined') return false;
            this.obj.parentNode.removeChild(this.obj);
            return this;
        },
        hide: function () {
            if(typeof this.obj === 'undefined') return false;
            this.obj.style.display = 'none';
            return this;
        },
        show: function () {
            if(typeof this.obj === 'undefined') return false;
            this.obj.style.display = '';
            return this;
        },
        addClass: function(className) {
            if(typeof this.obj === 'undefined') return false;

            var list = className.split(" ");
            for (var i = 0; i < list.length; i++) {
              if(this.obj.classList) this.obj.classList.add(list[i]);
              else this.obj.className += ' ' + list[i];
            }

            return this;
        },
        removeClass: function(className) {
            if(typeof this.obj === 'undefined') return false;

            if (this.obj.classList) this.obj.classList.remove(className);
            else {
              var newClassName = "";
              var classes = this.className.split(" ");
              for(var i = 0; i < classes.length; i++) {
                  if(classes[i] !== remove) newClassName += classes[i] + " ";
              }
              this.obj.className = newClassName;
            }

            return this;
        },
        hasClass: function(className) {
            if(typeof this.obj === 'undefined') return false;

            if (this.obj.classList) {
                return (this.obj.classList.contains(className));
            } else {
                var regex = new RegExp('(?:^|\\s)' + className + '(?!\\S)');
                return (this.obj.className.match(regex) !== null) ? true : false;
            }

            return this;
        },
        removeStyle: function() {
            if(typeof this.obj === 'undefined') return false;
            this.obj.style='';
            return this;
        },
        attr: function(key,val) {
            if(typeof this.obj === 'undefined') return false;
            if(typeof val === 'undefined') { //get attribute value
              if(typeof this.obj.getAttribute === 'undefined') return null;
              else return this.obj.getAttribute(key);
            }
            else { //set attribute value
              if(typeof this.obj.setAttribute === 'undefined') return false;
              else {
                this.obj.setAttribute(key, val);
                return this;
              }
            }
        },
        after: function(htmlString) {
            if(typeof this.obj === 'undefined') return false;
            this.obj.insertAdjacentHTML('afterend', htmlString);
            return this;
        },
        before: function(htmlString) {
            if(typeof this.obj === 'undefined') return false;
            this.obj.insertAdjacentHTML('beforebegin', htmlString);
            return this;
        },
        append: function(newObj) {
            if(typeof this.obj === 'undefined') return false;
            if(typeof newObj === "string") {
              this.obj.innerHTML = this.obj.innerHTML + newObj;
            }
            else this.obj.appendChild(newObj);
            return this;
        },
        html: function(htmlString) {
            if(typeof this.obj === 'undefined') return false;
            if(typeof htmlString !== 'undefined')  {
                this.obj.innerHTML = htmlString;
                return this;
            }
            else {
                return this.obj.innerHTML;
            }
        },
        parent: function() {
            if(typeof this.obj === 'undefined') return false;
            this.obj = this.obj.parentNode;
            return this;
        },
        closest: function(className) {
            if(typeof this.obj === 'undefined' || !className) return false;
            while((this.obj = this.obj.parentNode)) {
              if(typeof this.obj.classList !== 'undefined' && this.obj.classList.contains(className)) {
                return this;
              }
            }
            return false;
        },
        getChildNodes: function() {
          if(typeof this.obj === 'undefined') return false;
          // return this.obj.childNodes;
          return this.obj.children;
        },
        val: function(text) {
            if(typeof this.obj === 'undefined') return false;
            if(typeof text === 'undefined') return this.obj.value;
            else {
              this.obj.value = text;
              return this;
            }
        },
        on: function(type, func) {
            if(typeof this.obj === 'undefined') return false;
            func = TraceKit.wrap(func);
            if(type=="click") {
              this.obj.onclick = func;
            }
            else if(type=="mouseover" || type=="mouseenter") {
              this.obj.addEventListener("mouseover", func, false);
            }
            else if(type=="mouseout" || type=="mouseleave") {
              this.obj.addEventListener("mouseout", func, false);
            }
            else {
              this.obj.addEventListener(type, func);
            }

            return this;
        },
        contents: function() {
            if(typeof this.obj === 'undefined') return false;
            this.obj = this.obj.contentDocument ? this.obj.contentDocument : this.obj.contentWindow.document;
            return this;
        },
        contentWin: function() {
            if(typeof this.obj === 'undefined') return false;
            if(this.obj.contentWindow) this.obj = this.obj.contentWindow;
            else if(this.obj.contentDocument) this.obj = this.obj.contentDocument.defaultView;

            return this;
        },
        find: function(val) {
            if(typeof this.obj === 'undefined') return false;
            this.obj = this.obj.querySelectorAll(val)[0];
            return this;
        },
        width: function() {
            return document.documentElement.clientWidth;
        },
        height: function() {
            return document.documentElement.clientHeight;
        },
        prev: function() {
            if(typeof this.obj === 'undefined') return false;
            this.obj = this.obj.previousElementSibling;
            return this;
        },
        prop: function(type, val) {
            if(typeof this.obj === 'undefined') return false;
            this.obj.checked = val;
            return this;
        }


    };

    var jquery = function(val) {
        return jquery_utils.sel(val);
    }


    //cross browser ajax request (includes jsonp support)
    var req_id = 0;
    jquery.ajax = function( parms ) {

        var url             = parms.url;
        var callback        = parms.success;
        var errFunc         = parms.error || function() {};
        var cache           = parms.cache;
        var data            = parms.data;
        var headers         = parms.headers || {};
        var method          = parms.method || "GET";
        var special         = parms.special;
        var requestType     = parms.requestType;
        var withCredentials = parms.withCredentials || true;

        if(typeof TraceKit !== 'undefined') {
            // Wrap Functions in TraceKit
            callback = TraceKit.wrap(callback);
            errFunc  = TraceKit.wrap(errFunc);
        }

        //jsonp request
        if(requestType == "jsonp") {
            req_id++;

            if(callback) {
                var separator = "&"; 

                var mycallback = 'proper_' + guid() + "_" + req_id;
                window[mycallback] = function(e) { callback(e); };

                var cname = "callback"; var callback_scope = 'window.';
                if(special && (special == "rtk" || special == "mantis" || special == "gumgum")) { 
                    cname = "jsonp";
                } else if(special && special == "index") { 
                    cname = "fn";
                } else if(special && special == "sonobi") { 
                    cname = "cv"; 
                    callback_scope = ''; 
                }
                url += separator+cname+'='+callback_scope+mycallback;
            }

            var script = document.createElement('script');
            script.async = true; script.src = url;
            document.getElementsByTagName('head')[0].appendChild(script);
            return true;
        }

        // Must encode data
        if(data && typeof(data) === 'object') {
            var y = '', e = encodeURIComponent;
            for (x in data) {
                y += '&' + e(x) + '=' + e(data[x]);
            }
            data = y.slice(1) + (! cache ? '&_t=' + new Date : '');
        }

        //send ajax request
        try {
            var xhr = null; //new (this.XMLHttpRequest || ActiveXObject)('MSXML2.XMLHTTP.3.0');
            if(window.ActiveXObject) { 
            xhr = new ActiveXObject('Microsoft.XMLHTTP'); 
            
            } else if(window.XMLHttpRequest) { 
                xhr = new XMLHttpRequest(); 
            }

            xhr.open(method, url, 1);
            if(requestType=="cors") {
                xhr.withCredentials = withCredentials;
            } else if(requestType=="fetch") {
                xhr.withCredentials = false;
            }
            //xhr.onreadystatechange = function () {
            //    xhr.readyState > 3 && callback && callback(xhr.responseText, xhr);
            //};

            xhr.timeout = 2000; // time in milliseconds

            xhr.onload = function() {
                if(xhr.status == 200) callback(xhr.responseText, xhr);
                else { errFunc(); }
            }

                for (var headerKey in headers) {
                xhr.setRequestHeader(headerKey, headers[headerKey]);
            }

            xhr.send(data)
        } catch (e) {
            errFunc();
            throw e;
        }

    }


    function guid() {
        function s4() {
            return Math.floor((1 + Math.random()) * 0x10000)
            .toString(16)
            .substring(1,5);
        }
        return s4() + s4() + '_' + s4() + s4();
    }

    // See https://developer.mozilla.org/en-US/docs/Web/API/WindowBase64/Base64_encoding_and_decoding#The_Unicode_Problem
    function b64EncodeUnicode(str) {
        return btoa(
            encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
                function toSolidBytes(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }
            )
        );
    }

    function b64DecodeUnicode(str) {
        // Going backwards: from bytestream, to percent-encoding, to original string.
        return decodeURIComponent(atob(str).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
    }

    function isBase64(str) {
        try {
            return b64EncodeUnicode(b64DecodeUnicode(str)) == str;
        } catch (err) {
            return false;
        }
    }

    function getDNT() {
        return navigator.doNotTrack === '1' || window.doNotTrack === '1' || navigator.msDoNoTrack === '1' || navigator.doNotTrack === 'yes';
    }

    /**
     * 
     * This function provides a safer way of accessing the pages[] array. 
     * 
     * @param {Int} index - The page number = Array index + 1.  
     * 
     * @returns {pageObj}
     */
    function getPageObjectByIndex(pages, index) {
        if( pages
            && index
            && typeof pages[index - 1] !== 'undefined'
            && pages[index - 1]
        ) {
            return pages[index - 1];
        } else {
            return null;
        }
    }

    /**
     * 
     * Safe way of grabbing a slot from a page object. 
     * 
     * @param {pageObj} page - The Page Object
     * @param {String} slot_name - The Slot name; A string preferably.  
     * 
     * @returns {slotObj|null} - The slot object or Null. 
     */
    function getSlotFromPageObject(page, slot_name) {
        if( page
            && slot_name
            && typeof page.slots !== 'undefined'
            && page.slots 
            && typeof page.slots[slot_name] !== 'undefined'
            && page.slots[slot_name]
        ) {
            return page.slots[slot_name];
        } else {
            return null;
        }
    }

    /**
     * safeJSONParse
     * 
     * Makes an attempt to parse a JSON safely, but might fail miserably. 
     * 
     * @param {String} the json
     * 
     * @returns {JSON|null} JSON is parsed, Null if not. 
     * 
     */
    function safeJsonParse(json) {
        try {
            return JSON.parse(json);
        } catch(e) {
            console.error(e);
            sendError(TraceKit.computeStackTrace(e));
        }
        return null;
    }

    /**
     * indexOfObjectInArray
     * 
     * This function looks for an object in an array and returns the index, else -1.
     * 
     * @param {Array} The array to look in. 
     * @param {Object} The object to find. 
     * 
     * @returns {int} The array index or -1;
     */
    function indexOfObjectInArray(array, object) {
        if(typeof object === "object" && typeof array === "object") {
            object = JSON.stringify(object);
            for (var i = 0; i < array.length; i++) {
                if (typeof array[i] === "object" && JSON.stringify(array[i]) === object) {
                    return i;
                }
            }
        }
        return -1;
    }

    var properSetTimeout = {
        selfCheck : true,
        setTimeout: function(vCallback, nDelay) {
            var scope = (typeof this.selfCheck !== 'undefined') ? window : this;
            return window.setTimeout(TraceKit.wrap(vCallback).bind(scope), nDelay);
        }
    }

    /**
     * deepAccess utility function useful for doing safe access (will not throw exceptions) of deep object paths.
     * @param {Object} obj The object containing the values you would like to access.
     * @param {string|number} path Object path to the value you would like to access.  Non-strings are coerced to strings.
     * @returns {*} The value found at the specified object path, or undefined if path is not found.
     */
    function deepAccess(obj, path) {
        if (!obj) {
            return;
        }
        path = String(path).split('.');
        for (var i = 0; i < path.length; i++) {
            obj = obj[path[i]];
            if (typeof obj === 'undefined') {
                return;
            }
        }
        return obj;
    }

    function extractSlotNameAndPageNumber(identifier) {
        var parts = identifier.replace(/^proper-ad-/, '').split("-");
        return { slot_name: parts[0], page_number: (+parts[1] || 1) };
    }

    //export functions
    return {
      jquery: jquery,
      getDNT: getDNT,
      isBase64: isBase64,
      mergeObject: mergeObject,
      b64EncodeUnicode: b64EncodeUnicode,
      b64DecodeUnicode: b64DecodeUnicode,
      properSetTimeout: properSetTimeout,
      getPageObjectByIndex: getPageObjectByIndex,
      getSlotFromPageObject: getSlotFromPageObject,
      safeJsonParse: safeJsonParse,
      deepAccess: deepAccess,
      indexOfObjectInArray: indexOfObjectInArray,
      extractSlotNameAndPageNumber: extractSlotNameAndPageNumber
    };

})(window, document);

/**
 * PgwBrowser - Version 1.3
 *
 * Copyright 2014-2015, Jonathan M. Piat
 * http://pgwjs.com - http://pagawa.com
*/
var pgw = function() {

    var pgwBrowser = {};
    pgwBrowser.userAgent = navigator.userAgent;
    pgwBrowser.browser = {};
    pgwBrowser.viewport = {};
    pgwBrowser.os = {};
    pgwBrowser.device_type = "";
    resizeEvent = null;


    // The order of the following arrays is important, be careful if you change it.
    var browserData = [
    	{ name: 'Edge',              group: 'Edge',     identifier: 'Edge/([0-9\.]*)',          versionIdentifier: 'Edge/([0-9\.]*)' },
        { name: 'Chromium',          group: 'Chrome',   identifier: 'Chromium/([0-9\.]*)'       },
        { name: 'Chrome Mobile',     group: 'Chrome',   identifier: 'Chrome/([0-9\.]*) Mobile', versionIdentifier: 'Chrome/([0-9\.]*)'},
		{ name: 'Chrome',            group: 'Chrome',   identifier: 'Chrome/([0-9\.]*)'         },
        { name: 'Chrome for iOS',    group: 'Chrome',   identifier: 'CriOS/([0-9\.]*)'          },
		{ name: 'Android Browser',   group: 'Chrome',   identifier: 'CrMo/([0-9\.]*)'           },
        { name: 'Firefox',           group: 'Firefox',  identifier: 'Firefox/([0-9\.]*)'        },
        { name: 'Opera Mini',        group: 'Opera',    identifier: 'Opera Mini/([0-9\.]*)'     },
        { name: 'Opera',             group: 'Opera',    identifier: 'Opera ([0-9\.]*)'          },
        { name: 'Opera',             group: 'Opera',    identifier: 'Opera/([0-9\.]*)',         versionIdentifier: 'Version/([0-9\.]*)' },
        { name: 'IEMobile',          group: 'Explorer', identifier: 'IEMobile/([0-9\.]*)'       },
        { name: 'Internet Explorer', group: 'Explorer', identifier: 'MSIE ([a-zA-Z0-9\.]*)'     },
        { name: 'Internet Explorer', group: 'Explorer', identifier: 'Trident/([0-9\.]*)',       versionIdentifier: 'rv:([0-9\.]*)' },
		{ name: 'Safari',            group: 'Safari',   identifier: 'Safari/([0-9\.]*)',        versionIdentifier: 'Version/([0-9\.]*)' },
		{ name: 'Facebook App',      group: 'Facebook', identifier: 'FBAN/',        		    versionIdentifier: 'FBAV/([0-9\.]*)' },
		{ name: 'Other', 			 group: 'Other',    identifier: ''                          }
    ];

    var osData = [
        { name: 'Windows 2000',           group: 'Windows',       identifier: 'Windows NT 5.0',                     version: '5.0' },
        { name: 'Windows XP',             group: 'Windows',       identifier: 'Windows NT 5.1',                     version: '5.1' },
        { name: 'Windows Vista',          group: 'Windows',       identifier: 'Windows NT 6.0',                     version: '6.0' },
        { name: 'Windows 7',              group: 'Windows',       identifier: 'Windows NT 6.1',                     version: '7.0' },
        { name: 'Windows 8',              group: 'Windows',       identifier: 'Windows NT 6.2',                     version: '8.0' },
        { name: 'Windows 8.1',            group: 'Windows',       identifier: 'Windows NT 6.3',                     version: '8.1' },
        { name: 'Windows 10',             group: 'Windows',       identifier: 'Windows NT 10.0',                    version: '10.0' },
        { name: 'Windows Phone',          group: 'Windows Phone', identifier: 'Windows Phone ([0-9\.]*)',           },
        { name: 'Windows Phone',          group: 'Windows Phone', identifier: 'Windows Phone OS ([0-9\.]*)',        },
        { name: 'Windows',                group: 'Windows',       identifier: 'Windows',                            },
        { name: 'Chrome OS',              group: 'Chrome OS',     identifier: 'CrOS',                               },
        { name: 'Android',                group: 'Android',       identifier: 'Android',                            versionIdentifier: 'Android ([a-zA-Z0-9\.-]*)' },
        { name: 'iPad',                   group: 'iOS',           identifier: 'iPad',                               versionIdentifier: 'OS ([0-9_]*)', versionSeparator: '[_|\.]' },
        { name: 'iPod',                   group: 'iOS',           identifier: 'iPod',                               versionIdentifier: 'OS ([0-9_]*)', versionSeparator: '[_|\.]' },
		{ name: 'iPhone',                 group: 'iOS',           identifier: 'iPhone OS',                          versionIdentifier: 'OS ([0-9_]*)', versionSeparator: '[_|\.]' },
		{ name: 'macOS High Sierra',      group: 'Mac OS',        identifier: 'Mac OS X (10([_|\.])13([0-9_\.]*))', versionSeparator: '[_|\.]' },
		{ name: 'macOS Sierra',           group: 'Mac OS',        identifier: 'Mac OS X (10([_|\.])12([0-9_\.]*))', versionSeparator: '[_|\.]' },
		{ name: 'Mac OS X El Capitan',    group: 'Mac OS',        identifier: 'Mac OS X (10([_|\.])11([0-9_\.]*))', versionSeparator: '[_|\.]' },
        { name: 'Mac OS X Yosemite',      group: 'Mac OS',        identifier: 'Mac OS X (10([_|\.])10([0-9_\.]*))', versionSeparator: '[_|\.]' },
        { name: 'Mac OS X Mavericks',     group: 'Mac OS',        identifier: 'Mac OS X (10([_|\.])9([0-9_\.]*))',  versionSeparator: '[_|\.]' },
        { name: 'Mac OS X Mountain Lion', group: 'Mac OS',        identifier: 'Mac OS X (10([_|\.])8([0-9_\.]*))',  versionSeparator: '[_|\.]' },
        { name: 'Mac OS X Lion',          group: 'Mac OS',        identifier: 'Mac OS X (10([_|\.])7([0-9_\.]*))',  versionSeparator: '[_|\.]' },
        { name: 'Mac OS X Snow Leopard',  group: 'Mac OS',        identifier: 'Mac OS X (10([_|\.])6([0-9_\.]*))',  versionSeparator: '[_|\.]' },
        { name: 'Mac OS X Leopard',       group: 'Mac OS',        identifier: 'Mac OS X (10([_|\.])5([0-9_\.]*))',  versionSeparator: '[_|\.]' },
        { name: 'Mac OS X Tiger',         group: 'Mac OS',        identifier: 'Mac OS X (10([_|\.])4([0-9_\.]*))',  versionSeparator: '[_|\.]' },
        { name: 'Mac OS X Panther',       group: 'Mac OS',        identifier: 'Mac OS X (10([_|\.])3([0-9_\.]*))',  versionSeparator: '[_|\.]' },
        { name: 'Mac OS X Jaguar',        group: 'Mac OS',        identifier: 'Mac OS X (10([_|\.])2([0-9_\.]*))',  versionSeparator: '[_|\.]' },
        { name: 'Mac OS X Puma',          group: 'Mac OS',        identifier: 'Mac OS X (10([_|\.])1([0-9_\.]*))',  versionSeparator: '[_|\.]' },
        { name: 'Mac OS X Cheetah',       group: 'Mac OS',        identifier: 'Mac OS X (10([_|\.])0([0-9_\.]*))',  versionSeparator: '[_|\.]' },
        { name: 'Mac OS',                 group: 'Mac OS',        identifier: 'Mac OS'                              },
        { name: 'Ubuntu',                 group: 'Linux',         identifier: 'Ubuntu',                             versionIdentifier: 'Ubuntu/([0-9\.]*)' },
        { name: 'Debian',                 group: 'Linux',         identifier: 'Debian',                             },
        { name: 'Gentoo',                 group: 'Linux',         identifier: 'Gentoo',                             },
        { name: 'Linux',                  group: 'Linux',         identifier: 'Linux',                              },
        { name: 'BlackBerry',             group: 'BlackBerry',    identifier: 'BlackBerry',                         }
    ];

    //  Set browser data
    var setBrowserData = function() {
        var userAgent = pgwBrowser.userAgent.toLowerCase();

        // Check browser type
        for (i in browserData) {
            var browserRegExp = new RegExp(browserData[i].identifier.toLowerCase());
            var browserRegExpResult = browserRegExp.exec(userAgent);

            if (browserRegExpResult != null && browserRegExpResult[1]) {
                pgwBrowser.browser.name = browserData[i].name;
                pgwBrowser.browser.group = browserData[i].group;

                // Check version
                if (browserData[i].versionIdentifier) {
                    var versionRegExp = new RegExp(browserData[i].versionIdentifier.toLowerCase());
                    var versionRegExpResult = versionRegExp.exec(userAgent);

                    if (versionRegExpResult != null && versionRegExpResult[1]) {
                        setBrowserVersion(versionRegExpResult[1]);
                    }

                } else {
                    setBrowserVersion(browserRegExpResult[1]);
                }

                break;
            }
        }

        return true;
    };

    // Set browser version
    var setBrowserVersion = function(version) {
        var splitVersion = version.split('.', 2);
        pgwBrowser.browser.fullVersion = version;

        // Major version
        if (splitVersion[0]) {
            pgwBrowser.browser.majorVersion = parseInt(splitVersion[0]);
        }

        // Minor version
        if (splitVersion[1]) {
            pgwBrowser.browser.minorVersion = parseInt(splitVersion[1]);
        }

        return true;
    };

    //  Set OS data
    var setOsData = function() {
        var userAgent = pgwBrowser.userAgent.toLowerCase();

        // Check browser type
        for (i in osData) {
            var osRegExp = new RegExp(osData[i].identifier.toLowerCase());
            var osRegExpResult = osRegExp.exec(userAgent);

            if (osRegExpResult != null) {
                pgwBrowser.os.name = osData[i].name;
                pgwBrowser.os.group = osData[i].group;

                // Version defined
                if (osData[i].version) {
                    setOsVersion(osData[i].version, (osData[i].versionSeparator) ? osData[i].versionSeparator : '.');

                // Version detected
                } else if (osRegExpResult[1]) {
                    setOsVersion(osRegExpResult[1], (osData[i].versionSeparator) ? osData[i].versionSeparator : '.');

                // Version identifier
                } else if (osData[i].versionIdentifier) {
                    var versionRegExp = new RegExp(osData[i].versionIdentifier.toLowerCase());
                    var versionRegExpResult = versionRegExp.exec(userAgent);

                    if (versionRegExpResult != null && versionRegExpResult[1]) {
                        setOsVersion(versionRegExpResult[1], (osData[i].versionSeparator) ? osData[i].versionSeparator : '.');
                    }
                }

                break;
            }
        }

        return true;
    };

    // Set OS version
    var setOsVersion = function(version, separator) {
        if (separator.substr(0, 1) == '[') {
            var splitVersion = version.split(new RegExp(separator, 'g'), 2);
        } else {
            var splitVersion = version.split(separator, 2);
        }

        if (separator != '.') {
            version = version.replace(new RegExp(separator, 'g'), '.');
        }

        pgwBrowser.os.fullVersion = version;

        // Major version
        if (splitVersion[0]) {
            pgwBrowser.os.majorVersion = parseInt(splitVersion[0]);
        }

        // Minor version
        if (splitVersion[1]) {
            pgwBrowser.os.minorVersion = parseInt(splitVersion[1]);
        }

        return true;
    };


    // custom function to detect device type (mobile, desktop, tablet)
    var setDeviceType = function() {

        var ua = pgwBrowser.userAgent.toLowerCase();
        if(/(ipad|tablet|(android(?!.*mobile))|(windows(?!.*phone)(.*touch))|kindle|playbook|silk|(puffin(?!.*(IP|AP|WP))))/.test(ua)) pgwBrowser.device_type = "tablet";
        else if(/(mobi|ipod|phone|blackberry|opera mini|fennec|minimo|symbian|psp|nintendo ds|archos|skyfire|puffin|blazer|bolt|gobrowser|iris|maemo|semc|teashark|uzard)/.test(ua)) pgwBrowser.device_type = "mobile";
        else pgwBrowser.device_type = "desktop";

        return true;
    };

    // Set viewport size
    /*
    var setViewportSize = function(init) {
        pgwBrowser.viewport.width = $(window).width();
        pgwBrowser.viewport.height = $(window).height();

        // Resize triggers
        if (typeof init == 'undefined') {
            if (resizeEvent == null) {
                $(window).trigger('PgwBrowser::StartResizing');
            } else {
                clearTimeout(resizeEvent);
            }

            resizeEvent = setTimeout(function() {
                $(window).trigger('PgwBrowser::StopResizing');
                clearTimeout(resizeEvent);
                resizeEvent = null;
            }, 300);
        }

        return true;
    };

    // Set viewport orientation
    var setViewportOrientation = function() {
        if (typeof window.orientation == 'undefined') {

            if (pgwBrowser.viewport.width >= pgwBrowser.viewport.height) {
                pgwBrowser.viewport.orientation = 'landscape';
            } else {
                pgwBrowser.viewport.orientation = 'portrait';
            }

        } else {
            switch(window.orientation) {
                case -90:
                case 90:
                    pgwBrowser.viewport.orientation = 'landscape';
                    break;
                default:
                    pgwBrowser.viewport.orientation = 'portrait';
                    break;
            }
        }

        // Orientation trigger
        $(window).trigger('PgwBrowser::OrientationChange');

        return true;
    };

    // Replace default value for the user-agent tester on pgwjs.com
    if (typeof window.pgwJsUserAgentTester != 'undefined') {
        pgwBrowser.userAgent = window.pgwJsUserAgentTester;
    }
    */

    // Initialization
    setBrowserData();
    setOsData();
    setDeviceType();
    //setViewportSize(true);
    //setViewportOrientation();

    // Triggers
    /*
    $(window).on('orientationchange', function(e) {
        setViewportOrientation();
    });

    $(window).resize(function(e) {
        setViewportSize();
    });
    */

    return pgwBrowser;
}



// @codekit-prepend "tracekit.js";
// @codekit-prepend "utils.js"; //jquery like functions
// @codekit-prepend "pgwbrowser.js";

//global variable for async
var propertag = propertag || {};
propertag.cmd = propertag.cmd || [];

// QuantCast
var _qevents = _qevents || [];

(function() {
	var elem = document.createElement('script');
	elem.src = (document.location.protocol == "https:" ? "https://secure" : "http://edge") + ".quantserve.com/quant.js";
	elem.async = true;
	elem.type = "text/javascript";
	var scpt = document.getElementsByTagName('script')[0];
	scpt.parentNode.insertBefore(elem, scpt);
})();

try {
	_qevents.push({
		qacct:"p-mEzuYq24VEJ-3"
	});
} catch (e) {
	console.error("Error pushing Quantcast event");
	console.error(e);
}

/**
 * Console Shim
 *
 * Some ancient browser don't have a console object defined by default
 * This shim basically "mutes" the errors for our exception handler as
 * we're not really interested in them.
 */
if(typeof console == 'undefined') {
    console = {
        log: function(m) {
            // do nothing
        },
        error: function(m) {
            // do nothing
        },
        info: function(m) {
            // do nothing
        },
        table: function(m) {
            // do nothing
        }
    }
}

//ad project class
ProperMedia.ad_project = (function(win, document) {

	//~~~~~~~~~~~~~~~~~
	//   GLOBAL VARS

	var pages = [],
		user  = {},
		ops   = {},
		dfp_per_slot = 1,
		cookieMatching = {},
		bidAdapters = {},
		adBlocker = null,
		event_callbacks = [],
		// A pass-through for when GDPR consent module is not included
		gdprConsent = {
			cmpPresent: false,
			ready: function(callback) { callback(gdprConsent); }
		};

	// END GLOBAL VARS
	//~~~~~~~~~~~~~~~~~

	//setup jquery selector
	var $ = ProperMedia.utils.jquery;

	// Overwrite setTimeout function to capture errors
	var properSetTimeout = ProperMedia.utils.properSetTimeout;

	// TraceKit Object
	var TraceKit = window.top.TraceKit;

	// Subscribe function for error tracking
    TraceKit.report.subscribe(sendError);
    // Unsubscribe default error tracking function
    TraceKit.report.unsubscribe(TraceKit.defaultSendError);

	function sendError(error) {
        'use strict';
        try {
            if (!error.stack) {
                error.stack = (new Error('force-added stack')).stack;
            }
            if(!error.name) {
                error.name = 'Unknown';
            }
            if(!error.message) {
                error.message = 'Unknown';
            }

        } catch (e) {
        	console.error("Error building error data");
            console.error(e);
        }

        try {

            var postData = {
                'client_timestamp' : new Date().getTime(),
                'event_id'         : generateUUID(),
                'page_id'          : generateUUID(),
                'session_id'       : generateUUID(),
                'bidder'           : error.bidder || '',
                'user_id'          : validateValue(user.pubcid, {'type':'string'}),
                'publisher'        : validateValue(ops.site_name, {'type':'string'}),
                'rtp_file_version' : validateValue(ops.split_version, {'type':'string'}),
                'ad_project_tag'   : validateValue(ops.rtp_file_revision, {'type':'string'}),
                'page_url'         : getPageUrl() || '',
                'in_iframe'        : true,
                'is_https'         : ('https:' == document.location.protocol) ? true : false,
                'user_agent'       : navigator.userAgent || '',
                'stack_trace'      : JSON.stringify(error.stack),
                'error_message'    : error.message.toString() || '',
                'error_name'       : error.name.toString() || ''
            }

            if(pages.length > 0) {
                // Get Most Recent page
                var pageObj = pages[pages.length - 1];

                // Set page uuid
                if(pageObj.uuid && pageObj.uuid !== '') {
                    postData['page_id'] = pageObj.uuid;
                }

                // Set session id
                if(
                    pageObj.sessionHandler &&
                    pageObj.sessionHandler.sessionData &&
                    pageObj.sessionHandler.sessionData.uuid &&
                    pageObj.sessionHandler.sessionData.uuid !== ''
                ) {
                    postData['session_id'] = pageObj.sessionHandler.sessionData.uuid;
                }

            }

            //send request
            $.ajax({
				url: "https://events.proper.io/api/event",
                requestType: "fetch",
                method: "POST",
                data: JSON.stringify(postData),
				withCredentials: false,
                success: function(resp) {
					console.log("Proper exception logged successfully.");
                },
				error: function() {
					console.error("Unable to log Proper exception.");
				}
            });
        } catch (e) {
            console.error("Error sending exception data");
            console.error(e);
        }
    }

	//detect user's os/browser
	window.device = {
		os            : "",
		os_group      : "",
		browser       : "",
		browser_group : "",
		device_type   : "",
	};

	var nav = pgw();
	if(typeof nav !== 'undefined') {
		window.device.os            = nav.os.name+" ("+nav.os.fullVersion+")";
		window.device.os_group      = nav.os.group;
		window.device.browser       = nav.browser.name+" "+nav.browser.fullVersion;
		window.device.browser_group = nav.browser.group;
		window.device.device_type   = nav.device_type;
	}


	// IE8 support
	if (!Object.keys) {
		Object.keys = (function() {
			'use strict';
			var hasOwnProperty = Object.prototype.hasOwnProperty,
			hasDontEnumBug = !({ toString: null }).propertyIsEnumerable('toString'),
			dontEnums = [
				'toString',
				'toLocaleString',
				'valueOf',
				'hasOwnProperty',
				'isPrototypeOf',
				'propertyIsEnumerable',
				'constructor'
			],
			dontEnumsLength = dontEnums.length;

			return function(obj) {
				if (typeof obj !== 'object' && (typeof obj !== 'function' || obj === null)) {
					throw new TypeError('Object.keys called on non-object');
				}

				var result = [], prop, i;

				for (prop in obj) {
					if (hasOwnProperty.call(obj, prop)) {
						result.push(prop);
					}
				}

				if (hasDontEnumBug) {
					for (i = 0; i < dontEnumsLength; i++) {
						if (hasOwnProperty.call(obj, dontEnums[i])) {
							result.push(dontEnums[i]);
						}
					}
				}
				return result;
			};
		}());
	}

	//adding IE8 support for trim()
	if (!String.prototype.trim) {
		String.prototype.trim = function () {
			return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, '');
		};
	}

	// Adding IE11 supprot for includes()
	if (!String.prototype.includes) {
		String.prototype.includes = function(search, start) {
			'use strict';
			if (typeof start !== 'number') {
				start = 0;
			}

			if (start + search.length > this.length) {
				return false;
			} else {
				return this.indexOf(search, start) !== -1;
			}
		};
	}

	// IE8 Support for Date.now
	Date.now = Date.now || function() { return +new Date; };

	//~~~~~~~~~~~~~~~~~
	//     OBJECTS

		// Page Object
	var pageObj = function() {
		// @import-if "include_viewability_code : 1" "viewability.js";

		this.url                 = '',      // current url
		this.domain              = '',      // current domain
		this.path                = '',      // current path
		this.referrer            = '',      // page referrer
		this.post_id             = '',      // post_id for page
		this.page_number         = 1,       // page number for infinite scroll
		this.isolated            = 0,       // if the page should be isolated from dfp
		this.get_vars            = {},      // GET params
		this.width               = 0,       // page width
		this.height              = 0,       // page height
		this.protocol            = 'http:', // protocol for current page (http or https)
		this.use_ssl             = false,   // https
		this.is_mobile           = 0,       // page is mobile
		this.slots               = {},      // list of slots on page
		this.requests_sent       = 0,       // number of bid requests sent
		this.requests_retuned    = 0,       // number of bid requests returned
		this.start_ts            = 0,       // timestamp script started
		this.bids_started_ts     = 0,       // timestamp page level bids were sent out
		this.dfp_correlator      = false,   // if the dfp correlator has been updated
		this.dfp_tags            = [],      // tags for dfp targeting
		this.bids                = {},      // object of page level bids
		this.dont_send_bids      = false,   // dont send out bids for this page
		this.uuid                = generateUUID(), // unique page id
		this.sessionHandler      = new sessionObj(this), // object to handle session data
		this.log                 = new logObj(this),     // page log
		this.adPools             = [],      // array of adPool objects
		this.viewability_tracker = null;	// only instantiate if a slot uses it

		this.init = function() {
			// Page variables
	    	if('https:' == document.location.protocol) {
	    		this.protocol = "https:";
	    		this.use_ssl  = true;
	    	} else this.protocol = "http:";

	        this.url      = getPageUrl();
	        this.path     = getPagePath();
	        this.domain   = getPageDomain();
	        this.get_vars = getUrlParameters(window.location.search.substring(1));
	        this.width    = $(window).width();
	        this.height   = $(window).height();
	        this.referrer = document.referrer;

	        this.page_number = pages.length + 1;

	        this.log.mylog('width: '+this.width);

	        // checking if domain verification is enabled
	        if(ops.domain_protection !== 'undefined' && ops.domain_protection == 1) {
				var regex = new RegExp('(^|\\.)' + ops.domain.replace(/(http(s)?:\/\/)?(www\.)?/, '') + '$');
	        	if(!this.domain.match(regex)) {
	        		this.log.mylog('WARNING: Domains don\'t match. Bids wont be sent out for this page');
					this.dont_send_bids = true;
				}
	        }

	        // checking if page is isolated
			if(typeof ops.isolated_urls !== 'undefined' && ops.isolated_urls.length > 0) {
				for(i in ops.isolated_urls) {
					var path = ops.isolated_urls[i];
					if(this.path.indexOf(path) == 0 && path) {
						this.isolated = 1; break;
					}
				}
			}

			if(typeof ops.isolated !== 'undefined' && this.isolated == 0 && this.page_number == 1) {
				this.isolated = ops.isolated;
			}

			// disable DFP/Adsense/etc if no consent for "Storage and access of
			// information" or "Personalisation"...
			if (gdprConsent.isolated) {
				this.isolated = 1;
			}

			//update tags variable
			ops.tags = (typeof special_ops.tags != 'undefined' && special_ops.tags != null) ? special_ops.tags : ["unknown"];
			if(typeof special_ops.tags !="undefined") this.dfp_tags = ops.tags;

			// update post_id
			ops.post_id = (typeof special_ops.post_id != 'undefined' && special_ops.post_id != null) ? special_ops.post_id : "";
			this.post_id = ops.post_id;

			// Build ad pools
			this.buildAdPools();

			// re-check mobile
	        this.checkMobile();

	        // handle session data
	        this.sessionHandler.init();

			// init the bidder data
			this.log.init_bid_data();

			this.start_ts = getTimestampMs();

		}

		this.buildAdPools = function() {
			var ad_pools = ops.ad_pools || special_ops.ad_pools;
			if(ad_pools && ad_pools.length > 0) {
				for(var i = 0; i < ad_pools.length; i++) {
					var slots = ad_pools[i];
					var adPool = new adPoolObj(slots);
					this.adPools.push(adPool);
				}
			}
		}

		this.assignSlotToAdPool = function(slot) {
			if(this.adPools && this.adPools.length > 0) {
				for(var i = 0; i < this.adPools.length; i++) {
					if(this.adPools[i].slots.indexOf(slot.name) !== -1) {
						slot.adPool = this.adPools[i];
						return true;
					}
				}
			}
			return false;
		}

		this.checkMobile = function() {
			// mobile specific ads
			if(ops.mobile_resolution > 0 && this.width < ops.mobile_resolution) {
				this.is_mobile = 1;
				ops.ad_ids = ops.mobile_ids;
			}
		}

		// Get slot object by slot number
		this.getSlotByNumber = function(value, type) {
			for( var slot in this.slots ) {
		        if( this.slots[slot].hasOwnProperty('number') ) {
		        	if( this.slots[slot].type == type ) {
	         			if( this.slots[slot].number == value )
	             			return this.slots[slot];
	             	}
		        }
		    }
		}

		// build slot
		this.buildDefaultSlots = function() {

			// page type specific ads
			var page_specific_ads = 0;
			var allowed_ads       = {};
			var optional_ads      = {};

			var arr = (typeof ops.page_type != 'undefined' && typeof ops.ad_pages[ops.page_type] != 'undefined') ? ops.ad_pages[ops.page_type] : [];

			// possible_ads override
			if(typeof ops.possible_ads != 'undefined' && ops.possible_ads != "" && ops.possible_ads.length > 0) {
				page_specific_ads = 1;
				for (var i = 0; i < ops.possible_ads.length; i++) allowed_ads[ops.possible_ads[i]] = 1;

			// page template
			} else if(ops.page_type != "" && typeof arr != 'undefined' && arr.length > 0) {
				page_specific_ads = 1;
				for (var i = 0; i < ops.ad_pages[ops.page_type].length; i++) allowed_ads[arr[i]] = 1;
			}

			// optional ads to not immediately build
			if(typeof ops.optional_ads != 'undefined' && ops.optional_ads != "") {
				for (var i = 0; i < ops.optional_ads.length; i++) optional_ads[ops.optional_ads[i]] = 1;
			}

			// build ads array
			if(page_specific_ads == 1) {
				for (var slot_type in ops.ad_slots) {
					var slot_number = 0;
					for (var slot_name in ops.ad_slots[slot_type]) {
						// increment slot number
						slot_number++;
						if(typeof allowed_ads[slot_name] !== "undefined" && typeof optional_ads[slot_name] == "undefined") {
							// Build slot object
							this.buildSlot(slot_name, slot_number, slot_type);
						}
					}
				}
			}
		}

		this.buildSlot = function(slot_name, slot_number, slot_type) {

			// special options for members
			if(typeof ops.member !== 'undefined' && ops.member == "yes") {
				// stickies
				if(slot_number == ops.sticky_slot && slot_type == "display") {
					// check if desktop and/or mobile stickies are allowed for members
					if(this.width > 750 && (typeof ops.member_sticky_desktop !== 'undefined' && ops.member_sticky_desktop == "no")) return;
					else if(this.width <= 750 && (typeof ops.member_sticky_mobile !== 'undefined' && ops.member_sticky_mobile == "no")) return;
				}
			}

			// Create a new slot object
			slot = new slotObj(this);
			slot.name      = slot_name;
			slot.number    = slot_number;
			slot.type      = slot_type;
			slot.sticky    = (slot.number == ops.sticky_slot && slot.type == 'display') ? 1 : 0;
			slot.outstream = (typeof ops.outstream_settings !== "undefined" && typeof ops.outstream_settings.slot_name !== "undefined" && slot.name == ops.outstream_settings.slot_name && slot.type == 'video') ? 1 : 0;
			slot.div_id    = (this.page_number > 1) ? "proper-ad-"+slot.name+'-'+this.page_number : "proper-ad-"+slot.name;
			slot.position  = (typeof ops.ad_pos[slot.name] !== "undefined") ? ops.ad_pos[slot.name] : "atf";

			// Check if sticky should be included on page
    		if(
                slot.sticky == 1 && 
                (
	                (   // Check if sticky has been closed
	                    ops.disable_sticky_on_close &&
	                    user.stickyFreqCapHandler.getStickyClosedCookie() == true
	                ) ||
	                (   // Check if sticky frequency cap has been met
	                    ops.enable_sticky_freq_cap &&
	                    user.stickyFreqCapHandler.getStickyUnitImps() >= ops.sticky_freq_cap
	                )
                )
            ) {
                return;
            }

			// use different floors for mobile and desktop, if defined
	        if (this.is_mobile == 1 && ops.hasOwnProperty('mobile_ad_retry_max')) {
	            slot.wait_count_max = ops.mobile_ad_retry_max;
	        } else if (this.is_mobile == 0 && ops.hasOwnProperty('ad_retry_max')) {
	            slot.wait_count_max = ops.ad_retry_max;
	        }

	        if(ops.ad_slot_options && ops.ad_slot_options[slot.name]) {
				// set custom slot options/overrides
				for (var key in ops.ad_slot_options[slot.name]) {
					slot[key] = ops.ad_slot_options[slot.name][key];
				}
			}

			if(ops.ad_slot_settings && ops.ad_slot_settings[slot.name]) {
				// set custom slot options/overrides
				for (var key in ops.ad_slot_settings[slot.name]) {
					slot[key] = ops.ad_slot_settings[slot.name][key];
				}
			}

			// Check if slot is always inview. Remove refresh safeguards on slots that are always inview
			slot.inview = ((this.is_mobile == 0 && slot.inview_ad_refresh == 1) || slot.sticky) ? 1 : 0;

			// Refresh settings
			slot.refresh_interval        = ((slot.inview || slot.viewable_ad_refresh) && slot.refresh_interval) ? slot.refresh_interval : ops.refresh_interval;
			slot.inview_refresh_interval = ((slot.inview || slot.viewable_ad_refresh) && slot.inview_refresh_interval) ? slot.inview_refresh_interval : ops.inview_refresh_interval;
			slot.lazyload_enabled        = (ops.lazyload_enabled && !slot.exclude_lazyload) ? 1 : 0;
			slot.refresh_max             = ops.refresh_max;
			slot.refresh_cnt             = 0;

			// Calculate max timeout number
			slot.max_timeout = (parseInt(slot.wait_interval) * parseInt(slot.wait_count_max));
			if(slot.position == "btf") slot.max_timeout = parseInt(slot.max_timeout * 1.1); //add extra timeout to btf units

			// get max tier for current resolution
			var max = 0; var sizes = [];
			for (var tier in ops.ad_slots[slot.type][slot.name]) {
				tier = parseInt(tier);
				if(this.width >= tier && tier >= max) max = tier;
			}

			// add to ad array
			var min = 0;
			var sizes = ops.ad_slots[slot.type][slot.name][max];
			if(sizes.length > 0) {

				// Loop through sizes
				for(var i = 0; i < sizes.length; i++) {

					var s = sizes[i].split('x');
					s[0] = parseInt(s[0]) || NaN;
					s[1] = parseInt(s[1]) || NaN;

					if(!isNaN(s[0]) && !isNaN(s[1])) {

						// Exclude 1x1
						if(s[0] != 1 && s[1] != 1 ) {
							// min width/height
							if(s[0] < slot.min_width || slot.min_width == 0) slot.min_width = s[0];
							if(s[1] < slot.min_height || slot.min_height == 0) slot.min_height = s[1];

							//min size
							if((s[0]*s[1]) < min || min == 0) {
								slot.default_size = sizes[i];
								min = s[0]*s[1];
							}
						}

						// Get floor for slot size
						if(slot.sticky == 1) {
							// Set size specific floor
							if(typeof ops.sticky_floors[sizes[i]] !== "undefined") {
								// sticky floor should be lowest size floor
								if(slot.floors.backup_floor == 0 || slot.floors.backup_floor > ops.sticky_floors[sizes[i]]) slot.floors.backup_floor = ops.sticky_floors[sizes[i]];
								slot.floors.sizes[sizes[i]] = ops.sticky_floors[sizes[i]];
							}
						} else {
							// Set size specific floor
							if(typeof ops.floors[sizes[i]] !== "undefined" && ops.floors[sizes[i]] !== "") {
								slot.floors.sizes[sizes[i]] = ops.floors[sizes[i]];
							}
						}
					}

					// Checking if there are bidder ids for this slot size
					if(typeof ops.ad_ids[slot.name+"@"+sizes[i]] !== "undefined") {
						// Adding slot size and bidder ids to slot object
						slot.sizes[sizes[i]] = ops.ad_ids[slot.name+"@"+sizes[i]];
					}
					else slot.sizes[sizes[i]] = {};

				}

				// Usually the smallest size has the most demand except for 320x50/300x250
				if(slot.default_size=="320x50" && typeof slot.sizes["300x250"] != "undefined") {
					slot.default_size = "300x250";
				}

				// ad slot object to page object
				this.slots[slot.name] = slot;
			}

			if(slot.type == 'display') {

				// whether or not to show report ad tool
				if(ops.report_ads == 1 && slot.exclude_ad_report == 0) {
					slot.report_ad_tool = 1;
				}

				// set data for refresh
				if(slot.exclude_ad_refresh == 0) {
					slot.refresh = ops.refresh;
				}

				// exclude google on refresh
				if(ops.exclude_google_refresh == 1) slot.exclude_advertiser = [ops.google_advertiser, ops.adsense_advertiser];

				// if slot auto-refreshing, add it to the refresh handler
				if(slot.refresh == 1 || slot.viewable_ad_refresh == 1) {
					// if there is a slot with this name already in the que then remove it
					if(slot.refresh_handler) {
						slot.removeRefreshTimeout();
					}
				}

				if (slot.viewable_ad_refresh == 1 || slot.lazyload_enabled == 1) {
					if (!this.viewability_tracker) {
						this.viewability_tracker = new ViewabilityTracker();
					}

					slot.refresh_interval        = ((slot.inview || slot.viewable_ad_refresh) && slot.refresh_interval) ? slot.refresh_interval : ops.refresh_interval;
					slot.inview_refresh_interval = ((slot.inview || slot.viewable_ad_refresh) && slot.inview_refresh_interval) ? slot.inview_refresh_interval : ops.inview_refresh_interval;

					var fetchMarginPercent = 0;
					var renderMarginPercent = 0;
					if(this.is_mobile) {
						fetchMarginPercent = (typeof slot.lazyload_fetch_margin_mobile !== 'undefined') ? slot.lazyload_fetch_margin_mobile : ops.lazyload_fetch_margin_mobile;
						renderMarginPercent = (typeof slot.lazyload_render_margin_mobile !== 'undefined') ? slot.lazyload_render_margin_mobile : ops.lazyload_render_margin_mobile;
					} else {
						fetchMarginPercent = (typeof slot.lazyload_fetch_margin_desktop !== 'undefined') ? slot.lazyload_fetch_margin_desktop : ops.lazyload_fetch_margin_desktop;
						renderMarginPercent = (typeof slot.lazyload_render_margin_desktop !== 'undefined') ? slot.lazyload_render_margin_desktop : ops.lazyload_render_margin_desktop;
					}

					var viewabilityConfig = {
						'id': slot.div_id,
						'lazyload': slot.lazyload_enabled ? true : false,
						'viewability': slot.viewable_ad_refresh ? true : false,
						'fetchMarginPercent': fetchMarginPercent,
						'renderMarginPercent': renderMarginPercent,
						'minHeight' : slot.min_height
					}

					// remember default refresh behavior for when slot goes out of view
					this.viewability_tracker.addElement(
						viewabilityConfig,
						slot.viewabilityChange.bind(slot)
					);
				}
			}

			// Set slot backup floor
			var backup_floor = (slot.custom_floor && slot.custom_floor > ops.backup_floor) ? slot.custom_floor : ops.backup_floor;
			// Set backup floor
			if(slot.floors.backup_floor < backup_floor) {
				slot.floors.backup_floor = backup_floor;
			}

			// Assign an add pool to the slot
			this.assignSlotToAdPool(slot);
		}

		this.init();
	}

		// Slot Object
	var slotObj = function(parent) {
		this.page                     = parent,

		this.name                      = '',    // slot name
		this.number                    = 0,     // slot number
		this.type                      = '',    // slot type: display, video
		this.size                      = [0,0], // size of slot
		this.div_id                    = '',    // div id for slot
		this.sizes                     = {},    // possible slot sizes
		this.default_size              = '0x0', // default slot size (used for testing placeholder)
		this.min_width       	       = 0,     // smallest width of any size enabled (used for container size)
		this.min_height       	       = 0,     // smallest height of any size enabled (used for container size)
		this.position                  = 'atf', // slot position (atf / btf)
		this.auction_num               = 0,     // how many auctions have run
		this.bids                      = {},    // list of bids
		this.bids_started_ts           = 0,     // ts when bids start sending out
		this.bids_sent                 = 0,     // number of bids sent for slot
		this.bids_returned             = 0,     // number of bids returned from slot
		this.bids_ready                = 0,     // bids are ready to be added to dfp request
		this.bids_ready_ts             = 0,     // time it took for for bids to finish since they where sent out
		this.last_displayed_ts         = 0,     // time slot was last displayed on page
		this.precent_bids_ready        = 0,     // precent of bids that were ready
		this.mapped_dfp_sizes          = 0,     // Flag if dfp size mapping has been set
		this.dfp_slot                  = {},    // dfp request setup
		this.dfp_ready                 = 0,     // dfp request is ready to be sent for slot
		this.dfp_sent                  = 0,     // dfp request has been sent
		this.winning_ad                = {},    // current winning ad
		this.ads                       = [],    // array of ads returned from bids
		this.sticky                    = 0,     // sicky slot or not
		this.inview                    = 0,     // slot is set to always be inview by publisher
		this.displayed                 = 0,     // slot ad has been displayed
		this.delay_handle              = null,  // handle for timeout
		this.timeout_handle            = null,  // handle for faegoiegogeoeg
		this.max_timeout      	       = 2000,  // max number of ms to wait before sending DFP request
		this.wait_interval             = 300,   // number of ms to wait
		this.wait_count                = 0,     // number of times slot has waited the wait_interval
		this.wait_count_max            = 6,     // max number of times to wait
		this.refresh                   = 0,     // refresh ad or not
		this.refresh_max               = 0,     // max times to refresh
		this.refresh_cnt               = 0,     // how many times slot has been refreshed
		this.refresh_handler           = null,  // handle for refresh timeout
		this.refresh_timer_met         = false, // flag to signal refresh interval has been met
		this.min_refresh_interval      = 15000, // refresh interval cannot be faster then this value
		this.inview_ad_refresh         = 0,     // Enable inview refresh 
		this.viewable_ad_refresh       = 0,     // should refresh only happen when visible?
		this.exclude_ad_refresh        = 0,     // Don't refresh slot
		this.exclude_ad_report         = 0,     // Exclude report ad tool
		this.exclude_advertiser        = [],    // keep advertiser ID's to exclude for refresh
		this.exclude_bidders           = {},    // bidders to exclude from refresh
		this.advertiserId 		       = 0,     // keep advertiser ID of current winner (excluding Proper Media)
		this.report_ad_tool            = 0,     // include report ad tool or not
		this.dfp_targeting		       = {},    // hold keys added to DFP slot
		this.banger_loop               = 0,     // banger loop count
		this.dfp_init			       = 0, 	// flag if DFP is initialized for this slot (only used in V6)
		this.always_refresh_dfp        = 0,     // always call DFP on refresh even if there are no other bids
		this.outstream                 = 0,     // Outstream slot,
		this.adPool                    = {},    // Pool of ads to choose from
		this.floors                    = {      // Object to set slot floors
			backup_floor: 0,
			sizes: {}
		},
		this.lazyload_enabled = 0,
		this.exclude_lazyload = 0,
		this.lazyload = {
			inFetchZone: false,
			inRenderZone: false
		},
		this.viewability = {
			viewable: false,
			entered_inview_ts: 0, // Ts slot became in view
			total_time_inview: 0, // Time that slot has been in view
		}

		this._videoCallback; // callback function to video player to return VAST tag

		// find the slot's div element (potentially inside an iframe)
		this.getElement = function() {
			return (this.iframe_window || top).document.getElementById(this.div_id);
		}

		// Log a bid response
	 	this.logBidResponse = function(bidder, size, price, adcode, tag_id, request_url, obj, ad_details, bid_response_ms, bid_floor) {

	 		// set price
	 		price = parseFloat(price);

	 		// gross price
	 		var gross = price;

	 		// take bidder rev share into account
			price = (ops.bidder_info[bidder] && ops.bidder_info[bidder].rev_share) ? price * ops.bidder_info[bidder].rev_share : price;

			// log bid response
			if(typeof this.bids[bidder] !== 'undefined') {
	 			this.bids[bidder].responses[size] = { 
	 				'bidder': bidder, 
	 				'size': size, 
	 				'price': price, 
	 				'gross': gross, 
	 				'adcode': adcode, 
	 				'tag_id': tag_id, 
	 				'request_url': request_url, 
	 				'obj': obj,
	 				'ad_details': ad_details 
	 			};
	 		}

	 		if(typeof this.page.bids[bidder] !== 'undefined') {
	 			if(typeof this.page.bids[bidder].responses[this.name] == 'undefined') {
	 				this.page.bids[bidder].responses[this.name] = {};
	 			}
	 			this.page.bids[bidder].responses[this.name][size] = { 
	 				'bidder': bidder, 
	 				'size': size, 
	 				'price': price, 
	 				'gross': gross, 
	 				'adcode': adcode, 
	 				'tag_id': tag_id, 
	 				'request_url': request_url, 
	 				'obj': obj, 
	 				'ad_details': ad_details 
	 			};
	 		}

			// new ad object
			var ad = new adObj(this);
			ad.bidder      = bidder;
			ad.size        = size;
			ad.price       = price;
			ad.gross       = gross;
			ad.floor       = bid_floor;
			ad.adcode      = adcode;
			ad.tag_id      = tag_id;
			ad.ad_details  = ad_details;
			ad.request_url = request_url;
			ad.response    = obj;
			ad.response_ms = bid_response_ms,
			ad.received_ts = Date.now();

			// Get bid adapter name from bidder
			var bidderAdapterName = bidderToAdapterName(bidder);
			if (
				typeof bidAdapters[bidderAdapterName] !== 'undefined' &&
				typeof bidAdapters[bidderAdapterName].bidderInfo !== 'undefined' && 
				typeof bidAdapters[bidderAdapterName].bidderInfo.default_bid_ttl !== 'undefined'
			) {
				// Update bid ttl
				ad.ttl = bidAdapters[bidderAdapterName].bidderInfo.default_bid_ttl;
			}
			
			// add ad to slot
			this.ads.push(ad);

			// Log bid to pool
			if(this.adPool instanceof adPoolObj) {
				this.adPool.addBidToPool(ad);
			}

	 	}

	 	// keep track of how many bids have returned
	 	this.incrementBidResponseCount = function(bidder,count) {

	 		// Make sure count is a number
			if(isNaN(parseInt(count))) count = 0;

	 		// log bid received
	 		this.page.requests_retuned += parseInt(count);
	 		this.bids_returned         += parseInt(count);

	 		if(typeof this.bids[bidder] !== 'undefined') this.bids[bidder].returned += parseInt(count);
	 		if(typeof this.page.bids[bidder] !== 'undefined') this.page.bids[bidder].returned += parseInt(count);

	 		// if last bid is received then bids are ready
	 		if(this.bids_ready == 0) { //we haven't send DFP yet
	 			this.checkBidsReady();
	 		}
	 	}

	 	// calculate auction ms
	 	this.calcAuctionMs = function() {
	 		var bids_started_ts = this.bids_started_ts == 0 ? this.page.bids_started_ts : this.bids_started_ts;
	 		return (this.bids_ready_ts > 0 && bids_started_ts > 0 && this.bids_ready_ts > bids_started_ts) ? this.bids_ready_ts - bids_started_ts : -1;
	 	}

	 	// calculate how long it's been since we started the auction
	 	this.auctionTimePassed = function() {
	 		var bids_started_ts = this.bids_started_ts == 0 ? this.page.bids_started_ts : this.bids_started_ts;
			var d = new Date();
			var ts = d.getTime();
			var current_auction_ms = ts - bids_started_ts;
			return current_auction_ms;
	 	}

	 	this.checkBidsReady = function() {
	 		//we have them all!
 			if(this.bids_returned >= this.bids_sent ) {
 				this.bidsReady();
 			}
			//check if we have most of them
 			else if(this.bids_returned >= this.bids_sent * 0.8) {
				if(this.auctionTimePassed() > (this.max_timeout * 0.8) ) {
					this.bidsReady();
				}
			// Check if max timeout has passed
 			} else if(this.auctionTimePassed() >= this.max_timeout) {
 				this.bidsReady();
 			}
	 	}

	 	// Check if bids are back
	 	this.bidsReady = function() {

	 		// Make sure we haven't already started
	 		if(
	 			this.bids_ready == 1 || 
	 			(
	 				this.lazyload_enabled &&
	 				!this.lazyload.inRenderZone 
 				)
 			) {
	 			return;
	 		}

			// bids are ready to send to dfp
			this.bids_ready = 1;

			// turning off timeout
			this.resetTimeout();

			if(this.type == 'display') {

	 			// display winning ad. Dont send to dfp
	 			if(this.page.isolated == 1) {
					this.getWinningBid();
					// run secondary auction if no winning bid
					if(this.winning_ad.price == 'undefined' && this.auction_num == 0 && typeof ops.secondary_auction !== 'undefined' && ops.secondary_auction == 1) {
	 					var id = (this.page.page_number > 1) ? this.page.page_number+"|"+this.number : this.number;
	 					proper_secondary(document,id);
	 				} else {
	 					showWinningAd(this);
	 				}
				// add highest price to dfp
	 			} else {
	 				//handle loading differently if multiple DFP instances are used
	 				if(typeof dfp_per_slot != "undefined" && dfp_per_slot == 1 && this.dfp_init == 0) {
	 					initDfp(this);
					} else {
						addBidToDfpSlot(this);
					}
	 			}

	 		} else if(this.type == 'video') {
	 			// do something with winning video ad
	 			this.getWinningBid();
	 			this.checkVideoAuction();
	 		}

	 	}

	 	this.checkVideoAuction = function() {
	 		var thisSlotObj = this;
			if(this.bids_ready && typeof this._videoCallback == 'function') {
				if(this.winning_ad.hasOwnProperty('adcode')) {
					this._videoCallback(this.winning_ad.adcode, this.winning_ad.ad_details.response_type);
					// Add event listener for Outstream Impression
					document.body.addEventListener('outstreamImpression', TraceKit.wrap(function(e) {

						var slot = thisSlotObj;
						var page = thisSlotObj.page;
						var ad   = thisSlotObj.winning_ad;

						// update auction time
	        			var auction_ms = slot.calcAuctionMs();

						// bid data
			            page.log.bid_data.ad_slots[slot.name] = {
			                slot_name          : validateValue(slot.name, {'type':'string','max_len':50}),
			                bidder             : validateValue(ad.bidder, {'type':'string','max_len':30}),
			                gross              : validateValue(ad.gross, {'type': (ad.bidder == 'a9') ? 'string' : 'number', 'max':999, 'max_len':15}),
			                price              : validateValue(ad.price, {'type': (ad.bidder == 'a9') ? 'string' : 'number', 'max':999, 'max_len':15}),
			                size               : validateValue(ad.size, {'type':'string','max_len':10}),
			                refresh_cnt        : validateValue(slot.refresh_cnt, {'type':'number','max':999}),
			                line_item_id       : "",
			                response_ms        : validateValue(ad.response_ms, {'type':'number','max':999999}),
			                auction_duration   : validateValue(auction_ms, {'type':'number','max':999999}),
			                precent_bids_ready : validateValue(slot.precent_bids_ready, {'type':'number','max':100}),
			                tag_id             : validateValue(ad.tag_id, {'type':'string','max_len':50})
			            };

			            // track data after 500ms (wait for more ad units to finish)
				        clearTimeout(page.log.tracker_timeout); page.log.tracker_timeout = null;
				        page.log.tracker_timeout = properSetTimeout.setTimeout.call(page, function() { page.log.proper_tracker(); }, page.log.tracker_wait);

                    }), false);
				} else {
					this._videoCallback(false, false);
				}
			}
		}

		// Calculate winning bid
		this.getWinningBid = function() {

			// timestamp when bids are ready
			this.bids_ready_ts = getTimestampMs();
			this.precent_bids_ready = (this.bids_sent > 0) ? ((this.bids_returned / this.bids_sent) * 100).toFixed(2) : 0;

			// Get bid from ad pool
			if(this.adPool instanceof adPoolObj) {
				this.adPool.getWinningBid(this);
			} else {

				if(this.ads.length > 0) {

					// sot ads on price
		 			this.ads.sort(function(a, b) {
						return parseFloat(b.price) - parseFloat(a.price);
					});

		 			for (var i = 0; i < this.ads.length; i++) {

			 			// get ad with highest price
						var winning_ad = this.ads[i];

						// Check if bid has expired
						if(winning_ad.checkIfExpired()) {
							this.ads.splice(i,1).pop();
							continue;
						}

						// Skip ads and bidders that have already won
						if(winning_ad.displayed == 1 || (typeof this.exclude_bidders[winning_ad.bidder] !== 'undefined' && this.exclude_bidders[winning_ad.bidder] == 1)) continue;
						// Only refresh to ads the same size as the current sticky ad
						if(this.sticky == 1 && this.refresh_cnt > 0 && this.size.join('x') != winning_ad.size) continue;

						// get / set price floor
						var floor_price = 0;
						if(typeof this.page.get_vars.proper_test != 'undefined' && (this.page.get_vars.proper_test == winning_ad.bidder || (this.page.get_vars.proper_test == 's2s' && winning_ad.bidder.includes("_s2s")))) {
							floor_price = 0;
						} else if(this.floors.sizes.hasOwnProperty(winning_ad.size) && this.floors.sizes[winning_ad.size] > this.floors.backup_floor) {
							floor_price = this.floors.sizes[winning_ad.size];
						} else {
							floor_price = this.floors.backup_floor;
						}

						//exclude advertisers on refresh
						if(
							this.refresh_cnt > 0 && 
							ops.full_refresh != 1 && 
							ProperMedia.utils.deepAccess(ops, 'bidder_info.'+winning_ad.bidder+'.dont_refresh') == 1
						) {
							continue;
						}

						// Don't include ads that don't break price floor
						if(winning_ad.price >= floor_price) {
							// set winning ad and remove the winning ad from the ads array
							this.winning_ad = this.ads.splice(i,1).pop();
							break;
						}
					};
				}
			}
		}

	 	// wait for more bids to come back
	 	this.wait = function() {
	 		var obj = this;
	 		if(this.timeout_handle == null) {
	 			this.timeout_handle = properSetTimeout.setTimeout.call(
	 				obj, 
	 				function() {
 						obj.bidsReady();
 					},
	 				obj.max_timeout 
 				);
	 		}
	    }

	    // reset timeout
	 	this.resetTimeout = function() {
	 		clearTimeout(this.timeout_handle);
	 		this.timeout_handle = null;
	 	}

	 	this.setRefreshInterval = function() {

	 		// Check if bidder should NOT be refreshed
	 		if((this.winning_ad.displayed == 1 && ProperMedia.utils.deepAccess(ops, 'bidder_info.'+this.winning_ad.bidder+'.dont_refresh') == 1) || this.refresh == 0) {
	 			this.refresh = 0;
	 			return;
	 		}

	 		// Set default refresh interval
	 		var refresh_interval = Math.max(this.refresh_interval, this.min_refresh_interval);

	 		// Check if google or adsense advertiser. Special refresh interval
	 		if( [ops.google_advertiser, ops.adsense_advertiser].indexOf(this.advertiserId) !== -1 && 
 				refresh_interval < ops.adx_refresh_interval
			) { 
	 			refresh_interval = ops.adx_refresh_interval;
	 		}

	 		if(this.viewable_ad_refresh) {
	 			if(this.viewability.viewable) {
	 				refresh_interval = Math.max(
	 					0,
	 					(this.inview_refresh_interval - this.viewability.total_time_inview),
	 					(refresh_interval - this.timeSinceRefresh())
					);
	 				
	 			} else {
	 				return;
	 			}

	 		} else if(this.inview) {
	 			refresh_interval = Math.max( 
	 				0, 
	 				(this.inview_refresh_interval - this.timeSinceRefresh()),
	 				(refresh_interval - this.timeSinceRefresh()) 
 				)
	 		} else {
	 			var bidder_refresh_interval = (this.winning_ad.displayed == 1 && ProperMedia.utils.deepAccess(ops, 'bidder_info.'+this.winning_ad.bidder+'.refresh_interval')) ? ProperMedia.utils.deepAccess(ops, 'bidder_info.'+this.winning_ad.bidder+'.refresh_interval') : 0;
	 			refresh_interval = Math.max( bidder_refresh_interval, refresh_interval );
	 		}
	 		
	 		this.addRefreshTimeout(refresh_interval);
	 	}

	 	this.addRefreshTimeout = function(refresh_interval) {
	 		var obj = this;
			this.removeRefreshTimeout(); // remove any existing handler
	 		this.refresh_handler = properSetTimeout.setTimeout.call(
	 			obj,
				function() {
					obj.refresh_timer_met = true;
					obj.removeRefreshTimeout();
					obj.refreshSlot();
				},
				refresh_interval
			);
			this.page.log.mylog(this.name+': Starting refresh timer. ms = '+refresh_interval);
	 	}
		
		this.timeSinceRefresh = function() {
			if (this.last_displayed_ts == 0) return 0;
			return Date.now() - this.last_displayed_ts;
		}

	 	this.removeRefreshTimeout = function() {
	 		this.page.log.mylog(this.name+': Removing refresh timer.');
	 		clearTimeout(this.refresh_handler);
	 		this.refresh_handler = null;
	 	}

	 	this.resetForRefresh = function(enabled_bidders) {

	 		this.bids_started_ts    = 0,
			this.bids_sent          = 0,
			this.bids_returned      = 0,
			this.bids_ready         = 0,
			this.bids_ready_ts      = 0,
			this.last_displayed_ts  = 0,
			this.precent_bids_ready = 0,
			this.dfp_ready          = 0,
			this.dfp_sent           = 0,
			this.winning_ad         = {},
			this.exclude_advertiser = [],
			this.exclude_bidders    = {},
			this.advertiserId 		= 0,
			this.refresh_timer_met  = false,
			this.viewability.entered_inview_ts = 0,
			this.viewability.total_time_inview = 0;

			var biddersToSetup = {};			

			// Reset bidder request data
			Object.keys(enabled_bidders).forEach(function(bidder) {
				// check that bidder is enabled
				if(enabled_bidders[bidder] == 1) {
					// check if bid request exist from previous auction
					if(typeof this.bids[bidder] !== 'undefined' && typeof this.bids[bidder].requests !== 'undefined' && bidder !== 'remnant_rubicon' && bidder !== 'remnant_adsense' && bidder !== 'remnant_adx') {
						this.bids[bidder].responses = {},
						this.bids[bidder].returned  = 0,
						this.bids[bidder].sent      = 0;

					// check if bidder is undefined or was sent out at page level
					} else if(typeof ops.bidder_info[bidder] !== 'undefined' && (typeof this.bids[bidder] == 'undefined' || (typeof ops.bidder_info[bidder].bid_grouping !== 'undefined' && ops.bidder_info[bidder].bid_grouping == 'page'))) {
						// set bid level to slot
						ops.bidder_info[bidder].bid_grouping = 'slot';
						biddersToSetup[bidder] = 1;
					}
				}
			}, this);

			// setup bid request data for bids that were sent out at page level
			if(Object.keys(biddersToSetup).length > 0) {
				// setup bid request for slot level
				var slots = {};
				slots[this.name] = this;
				setupBids(slots, biddersToSetup);
			}
	 	}

	 	// refresh ad
	    this.refreshSlot = function() {
	        if(this.refresh_cnt < this.refresh_max) {

	        	// Only refresh in fetch zone for lazy laod
		 		if(
	 				this.lazyload_enabled &&
	 				!this.lazyload.inFetchZone 
	 			) {
		 			return;
		 		}

	            this.page.log.mylog('Refreshing slot: '+this.name);

	            this.refresh_cnt++;

	            // Set isolated if dfp is excluded from refresh
	            if(ops.exclude_dfp_refresh == 1) this.page.isolated = 1;

	            // re-run whole auction
	            if(ops.full_refresh == 1) {

	                // get enabled bidders
	                var data = ops.enabled_bidders[this.auction_num] || {};

	                this.resetForRefresh(data);
	                // send bids by slot
	                sendBids(this, 'slot', data);

	            } else {
	            	this.bidsReady();
	            }
	        }
	    }

	 	this.getTimeInview = function() {
			if (this.viewability.entered_inview_ts == 0) return 0;
			return Date.now() - this.viewability.entered_inview_ts;
		}

		this.viewabilityChange = function(viewabilityObj) {
			if(this.viewable_ad_refresh && this.viewability.viewable != viewabilityObj.viewable) {
				this.page.log.mylog(this.name+': Viewability Change. visible = '+viewabilityObj.viewable);
				this.viewability.viewable = viewabilityObj.viewable;
				if (this.viewability.viewable) {
					this.viewability.entered_inview_ts = getTimestampMs();
					if (this.displayed && this.refresh && this.refresh_cnt < this.refresh_max) {
						// either start a refresh timer or replace with a shorter one.
						this.setRefreshInterval();
					}
				} else {
					this.viewability.total_time_inview += this.getTimeInview();
					this.removeRefreshTimeout();
				}
			}

			// Lazy Load is enabled
			if(this.lazyload_enabled) {

				// Slot has entered or exited fetch zone
				if(this.lazyload.inFetchZone != viewabilityObj.inFetchZone) {
					this.page.log.mylog(this.name+': LazyLoad Change. inFetchZone = '+viewabilityObj.inFetchZone);
					this.lazyload.inFetchZone = viewabilityObj.inFetchZone
					// Slot is in fetch zone and bids haven't been sent
					if(this.lazyload.inFetchZone && this.refresh_cnt == 0 && this.bids_started_ts == 0) {
						var data = ops.enabled_bidders[this.auction_num] || {};
						if(this.page.isolated != 1) {
							//handle differently if multiple DFP instances are used
			 				if(typeof dfp_per_slot != "undefined" && dfp_per_slot == 1) {
			 					if(this.dfp_init == 0) {
			 						initDfp(this);
			 					}
							} else if(typeof dfp_init != "undefined") {
								if(dfp_init == 0) {
									initDfp();
								}
								if(this.mapped_dfp_sizes == 0) {
	                            	// define dfp slot
	                            	buildDfpSizeMapping(this);
	                            } else {
	                            	sendBids(this, 'slot', data);
	                            }
							}
                        }

					} else if (this.lazyload.inFetchZone && this.displayed && this.refresh && this.refresh_timer_met) {
						this.refreshSlot();
					}	
				}

				// Slot has entered or exited render zone
				if(this.lazyload.inRenderZone != viewabilityObj.inRenderZone) {
					this.page.log.mylog(this.name+': LazyLoad Change. inRenderZone = '+viewabilityObj.inRenderZone);
					this.lazyload.inRenderZone = viewabilityObj.inRenderZone
					// Slot is in render zone and bids haven't been displayed
					if(this.lazyload.inRenderZone && this.bids_sent > 0 && this.bids_ready == 0) {
						this.checkBidsReady();
					}
				}
			}
		}
	}

		// Bidder Object
	// var bidderObj = function() {
	// 	this.name      = '',
	// 	this.rev_share = 1,
	// 	this.enabled   = 0;
	// }
		// Bid Object
	var bidObj = function() {
		this.bidder    = '',
		this.sent      = 0,
		this.returned  = 0;
		this.requests  = {},
		this.responses = {};
	}
		// Ad Object
	var adObj = function(parent) {
		this.slot        = parent,

		this.price       = 0,
		this.dfp_price   = 0,
		this.gross       = 0,
		this.bidder      = '',
		this.size        = '1x1',
		this.adcode      = '',
		this.tag_id      = '',
		this.ad_details  = {},
		this.request_url = '',
		this.response    = {},
		this.response_ms = 0,
		this.displayed   = 0,
		this.received_ts = 0,
		this.ttl         = 120000;

		this.timePassed = function() {
			var d = new Date();
			var ts = d.getTime();
			var ms = ts - this.received_ts;
			return ms;
	 	}

	 	this.checkIfExpired = function() {
	 		return (this.timePassed() > this.ttl) ? true : false;
	 	}
	}

		// user object
	var userObj = function() {
		this.lang    = '',              // users language
		this.tzone   = '',              // users timezone
		this.member  = 'no',            // user is a memeber
		this.facebook_user = 'unknown'; // User is logged into facebook
		this.pubcid  = '';              // Publisher Common ID

		this.init = function() {
			this.tzone = new Date().getTimezoneOffset();
        	this.lang  = navigator.language || navigator.browserLanguage || navigator.userLanguage || navigator.systemLanguage;

        	if (typeof top.window.PublisherCommonId === 'object' &&	
				typeof top.window.PublisherCommonId.getId === 'function')	
			{	
				try {	
					this.pubcid = top.window.PublisherCommonId.getId();	
				} catch (e) {	
					sendError(TraceKit.computeStackTrace(e));	
				}	
			}	

 			if (!this.pubcid) {	
				this.pubcid = getCookieValue('_pubcid');	
				if (!this.pubcid) {	
					this.pubcid = generateUUID();	
				}	

 				var date  = new Date();	
				date.setTime(date.getTime()+(365*24*60*60*1000));	
				document.cookie = "_pubcid="+this.pubcid+"; expires="+date.toGMTString()+"; path=/;";	
			}
		}

		this.stickyFreqCapHandler = {

			setStickyClosedCookie: function() {
				var date = new Date();
				date.setHours(23,59,59,0); // Expires at midnight
				document.cookie = "properStickyClosed=true; expires="+date.toGMTString()+"; path=/;";
			},

			getStickyClosedCookie: function() {
				return getCookieValue('properStickyClosed') == "true" ? true : false;
			},

			setStickyUnitImps: function(unitImpressions) {
				var date = new Date();
				date.setHours(23,59,59,0); // Expires at midnight
				document.cookie = "properStickyUnitImps="+parseInt(unitImpressions)+"; expires="+date.toGMTString()+"; path=/;";
			},

			getStickyUnitImps: function() {
				return parseInt(getCookieValue('properStickyUnitImps')) != NaN ? parseInt(getCookieValue('properStickyUnitImps')) : 0;
			},

			incrementStickyUnitImps: function() {
				var unitImpressions = this.getStickyUnitImps() || 0;
				unitImpressions += 1;
				this.setStickyUnitImps(unitImpressions);
			},

			expireCookie: function(cookieName) {
				document.cookie = cookieName+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
			},
		}

		this.init();
	}

		// Log object
	var logObj = function(parent) {
		this.page            = parent,

		this.log_lines       = {},   // list of events
		this.autoplay_html   = {},   // holds html from killed auto-play video ad
		this.rogue_data      = [],   // holds data of ads displayed to send back the tracker (this one will be cleared in between tracker calls to save)
		this.saved_data      = {},   // holds data for ad report tool
		this.bid_data        = {},   // holds bid data 
		this.ad_info         = {},   // holds creative and line item ID's for each ad displayed
		this.rogue_timeout   = null, // holds timeout function in case tracker take too long
		this.tracker_timeout = null; // holds timeout function for reporting bad ads
		this.tracker_wait	 = 500;  //number of ms to wait for more bids before sending tracking request

		// setup the page data
		this.init_bid_data = function() {

			//custom settings
			if(ops.site_name=="greatergood_ctg" || ops.site_name=="historyinorbit" || ops.site_name=="groovyhistory") this.tracker_wait=100;
			
			this.bid_data = {
				website           : validateValue(ops.site_name, {'type':'string','default_val':'unknown','max_len':40}),
				url               : validateValue(this.page.url, {'type':'string','max_len':255}),
				url_path          : validateValue(this.page.path, {'type':'string','max_len':150}),
				os                : validateValue(window.device.os_group, {'type':'string','max_len':30}),
				browser           : validateValue(window.device.browser_group, {'type':'string','max_len':30}),
				device            : validateValue(window.device.device_type, {'type':'string','max_len':10}),
				use_ssl           : validateValue(this.page.use_ssl, {'type':'boolean'}),
				is_mobile         : validateValue(this.page.is_mobile, {'type':'boolean'}),
				is_isolated       : validateValue(this.page.isolated, {'type':'boolean'}),
				session_depth     : validateValue(this.page.sessionHandler.sessionData.depth, {'type':'number'}),
				session_guid      : validateValue(this.page.sessionHandler.sessionData.uuid, {'type':'string'}),
				resolution_width  : validateValue(this.page.width, {'type':'number','max':99999}),
			    resolution_height : validateValue(this.page.height, {'type':'number','max':99999}),
			    rtp_file_version  : validateValue(ops.split_version, {'type':'number'}),
			    referrer          : validateValue(this.page.sessionHandler.sessionData.referrer, {'type':'string','max_len':255}),
			    utm_source        : validateValue(this.page.sessionHandler.sessionData.utm_source, {'type':'string','max_len':50}),
			    utm_campaign      : validateValue(this.page.sessionHandler.sessionData.utm_campaign, {'type':'string','max_len':50}),
			    utm_medium	      : validateValue(this.page.sessionHandler.sessionData.utm_medium, {'type':'string','max_len':50}),
			    utm_term	      : validateValue(this.page.sessionHandler.sessionData.utm_term, {'type':'string','max_len':50}),
			    page_guid         : validateValue(this.page.uuid, {'type':'string'}),
			    tags              : (typeof ops.tags != 'undefined') ? ops.tags.join(",") : '',
			    ad_slots          : {}
			}
		}

		this.log_bid = function(bidder, slot, size, price) {
			this.mylog(bidder+" ("+slot.name+"@"+size+") = "+price);
	    }

	    this.mylog = function(content, id) {

	        id = id || "proper"; //GET variable to check for

	        //save log
	        this.log_lines[id] = checkData(this.log_lines[id]);
	        this.log_lines[id].push(content);

	        //print to screen automatically
	        //logger.enableLogger();
	        if(this.page.get_vars[id] == 1 || (id == "proper" && getCookieValue('proper_log') == 1) ) console.log(content);
	        //logger.disableLogger();
	    }

	    // log autoplay data
	    this.rogue_tracker = function() {

			// clear timeout
			clearTimeout(this.rogue_timeout);
			this.rogue_timeout = null;

			// send bidder data for ads that displayed
			if(this.rogue_data.length > 0) {

				// clear data before sending request in case more comes in
				var post_data = this.rogue_data;
				this.rogue_data = [];

				var log = this;

				// send request
				$.ajax({
					url: 'https://proper.io/ajax/tracker.php?rogue=1',
					method: "POST",
					data: "data=" + JSON.stringify(post_data),
					headers: {"Content-type": "application/x-www-form-urlencoded"},
					success: function(resp) {
						log.mylog("autoplay ads tracked! x"+post_data.length);
					}
				});
			}
		}

		this.proper_tracker = function() {

			var log       = this;
			var post_data = {};

			//clear timeout
			clearTimeout(this.tracker_timeout);
			this.tracker_timeout = null;

			if (Object.keys(this.bid_data.ad_slots).length > 0) {
				
				//clear data before sending request in case more comes in
				post_data = JSON.stringify(this.bid_data);

				// clearing data after is it sent
				this.bid_data.ad_slots = {};
					
				// send request
				$.ajax({
					url: this.page.protocol+'//bids.proper.io/api/bidding',
					method: "POST",
					data: post_data,
					success: function(resp) { 
						log.mylog("bids tracked!");
					},
					error: function(e) {
						log.mylog("error tracking bid data");
					}
				});
			}
			
		}

	}
		// Set Default Options (different for each website)
	var optionsObj = function() {
		this.split_version     = 0,
		this.post_id           = '',
		this.post_id_enabled   = 0,
		this.member            = 'no',
		this.member_enabled    = 0,
		this.secondary_auction = 0,
		this.member_sticky_desktop = 'yes',
		this.member_sticky_mobile  = 'yes',
		this.tags = ["unknown"],
		this.bidder_info = {
	    	pubmatic_s2s : {
	    		rev_share   : 0.81,
				bid_grouping: 'slot'
	    	},
	    	sovrn_s2s : {
	    		rev_share   : 1,
				bid_grouping: 'page'
	    	},
	    	gumgum_s2s : {
	    		rev_share   : 1,
				bid_grouping: 'page',
				dont_refresh: 1
	    	},
	    	brealtime : {
	    		rev_share   : 0.9,
				bid_grouping: 'page',
        		default_bid_ttl: 300000,
        		refresh_interval: 60000
	    	},
	    	districtm : {
	    		rev_share   : 0.9,
				bid_grouping: 'page',
        		default_bid_ttl: 300000,
        		refresh_interval: 60000
	    	},
	    	openx_pmp : {
	    		rev_share   : 1,
				bid_grouping: 'slot'
	    	},
	    	remnant_rubicon : {
	    		rev_share   : 1,
				bid_grouping: 'slot',
				remnant: 1
	    	},
	    	remnant_adsense : {
	    		rev_share   : 1,
				bid_grouping: 'slot',
				remnant: 1
	    	},
	    	remnant_adx : {
	    		rev_share   : 1,
				bid_grouping: 'slot',
				remnant: 1
	    	},
		}
        if (typeof bidAdapters !== 'undefined') {
            for (var bidder in bidAdapters) {
                this.bidder_info[bidder] = bidAdapters[bidder].bidderInfo;
            }
        }
		this.floors = {},
		this.sticky_floors = {},
	    this.dynamic_bid_mod = {
	    	enabled : 0,
			range: [0,0],
			m: '',
			b: ''
	    },

	    this.disable_sticky_on_close= false,   // Disable sticky slot for session once it is closed once 
	    this.enable_sticky_freq_cap = false,   // Enable/Disable sticky slot frequency cap for session
	    this.sticky_freq_cap        = 0,       // Sticky slot frequency cap for session
		this.sticky_slot_pos        = "right",
		this.sticky_brand           = "yes",
		this.remove_sticky_close    = "no",
		this.adx_bid_modifier       = 1.10,
		this.backup_floor           = 0.10,    // minimum price for bids in first auction
		this.sovrn_floor            = 0.91,
		this.site_name              = "",
		this.domain                 = "",
		this.dfp_id                 = 5376056,
		this.google_advertiser      = 42904576,
		this.adsense_advertiser     = 1349528536,
		this.proper_advertiser      = 600883576,
		this.amazon_advertiser      = 455011336,
		this.remnant_advertiser     = 1349314336,
		this.ad_slots               = {},
		this.ad_slot_options        = {},
		this.ad_ids                 = {},
		this.ad_pos                 = {},
		this.sticky_slot            = 0,
		this.refresh_points         = [],
		this.report_ads             = 0,
		this.backup_stickies        = 0,
		this.testing_mode           = 0,
		this.mobile_resolution      = 0,
		this.mobile_ids             = {},
		this.page_type              = "", // type of page= home, article, movie, etc.
		this.ad_pages               = {}, // ad slots allowed for each page_type
		this.facebook_detection     = 0,
		this.capture_blocked_html   = 0,  // Record html for blocked ads
        this.blocker_sample_data    = 0,  // Take an html sample of all ads
        this.blocker_sample_rate    = 1,  // What % of ads to capture html for in thousandth. 1 = 1/1000 = 0.1%
		this.autoplay_block         = 1,  // block auto play ads!
		this.sandbox_iframe         = 1,  // serve in sandboxed iframe to stop redirects
		this.sandbox_options        = "allow-popups allow-pointer-lock allow-scripts allow-same-origin", //what to allow in sandbox
		this.ad_retry_max           = 6,  // how many times to extend timeout (300ms each)
		this.mobile_ad_retry_max    = 6,  // how many times to extend timeout (300ms each)
		this.site_ids               = {}, // site id's for each bidder
		this.start_stop_bidders     = [], // start/stop points for each bidder
		this.enabled_bidders        = {},
		this.domain_protection      = 0,
		this.refresh                = 0,      // refresh ads or not
		this.full_refresh           = 0,      // do a full refresh by calling all bidders again
		this.refresh_max            = 0,      // max number of refreshes
		this.adx_refresh_interval   = 30000,  // adx seconds to wait to refresh ads
		this.refresh_interval       = 60000,  // minimum seconds to wait to refresh ads
		this.inview_refresh_interval= 5000,   // minimum number of seconds ad has to be inview before refresh
		this.viewable_ad_refresh    = 0,      // flag to include viewability code
		this.exclude_google_refresh = 0,      // flag to exclude google from ad refresh
		this.exclude_dfp_refresh    = 0,      // flag to exclude dfp from ad refresh
		this.lazyload_enabled       = 0,      // turn lazy load on/off
		this.lazyload_fetch_margin_desktop  = 0,  // Precent of viewport the slot has to be from being inview to send bid requests (Desktop)
		this.lazyload_render_margin_desktop = 0,   // Precent of viewport the slot has to be from being inview to render (Desktop)
		this.lazyload_fetch_margin_mobile   = 0,  // Precent of viewport the slot has to be from being inview to send bid requests (Mobile)
		this.lazyload_render_margin_mobile  = 0,   // Precent of viewport the slot has to be from being inview to render (Mobile)
		this.autoplay_whitelist = [
			"sharethrough"
		],

		this.outstream_settings = {   // Settings for outstream player
			outstream          : 0,   // Enable Outstream player
			slot_name          : '',  // Outstream slot name
			sound_on_hover     : 0,   // Outstream Sound On/Off on hover
			expand_collapse    : 0,   // Outstream player expand / collapes
			placement_selector : '',  // Outstream placement on page
			exclude_dfp        : 1    // Exclude DFP
		}
	}

	/** 
 * Ad Pool Object
 */
var adPoolObj = function(slotsArr) {

	this.ads = [],               // List of ads to choose from
	this.displayedAds = [],      // List of displayed ads
	this.slots = slotsArr || []; // List of slots in pool

	/**
	 * ads  adObj
	 */
	this.addBidToPool = function(ad) {
		if(ad.price > 0) {
			// Add to size pool
			this.ads.push(ad);
			// sort ads on price
 			this.ads.sort(function(a, b) {
				return parseFloat(b.price) - parseFloat(a.price);
			});
		}
	}

	/**
	 * sizes  Array  Array of possible ad sizes
	 */
	this.getWinningBid = function(slot) {
		// Get slots possible sizes
		var sizes = Object.keys(slot.sizes);

		if(this.ads.length > 0) {

 			// Loop through ads
 			for(var i = 0; i < this.ads.length; i++) {

	 			// get ad with highest price
				var winning_ad = this.ads[i];				

				// Check if bid has expired
				if(winning_ad.checkIfExpired()) {
					this.ads.splice(i,1).pop();
					continue;
				}

				// Check if winning as size is in slots sizes 
				if(sizes.indexOf(winning_ad.size) == -1) continue;

				// Skip ads and bidders that have already won
				if(winning_ad.displayed == 1 || (typeof slot.exclude_bidders[winning_ad.bidder] !== 'undefined' && slot.exclude_bidders[winning_ad.bidder] == 1)) continue;
				// Only refresh to ads the same size as the current sticky ad
				if(slot.sticky == 1 && slot.refresh_cnt > 0 && slot.size.join('x') != winning_ad.size) continue;

				// get / set price floor
				var floor_price = 0;
				if(typeof slot.page.get_vars.proper_test != 'undefined' && (slot.page.get_vars.proper_test == winning_ad.bidder || (slot.page.get_vars.proper_test == 's2s' && winning_ad.bidder.includes("_s2s")))) {
					floor_price = 0;
				} else if(slot.floors.sizes.hasOwnProperty(winning_ad.size) && slot.floors.sizes[winning_ad.size] > slot.floors.backup_floor) {
					floor_price = slot.floors.sizes[winning_ad.size];
				} else {
					floor_price = slot.floors.backup_floor;
				}

				//exclude advertisers on refresh
				if(
					slot.refresh_cnt > 0 && 
					ops.full_refresh != 1 && 
					ProperMedia.utils.deepAccess(ops, 'bidder_info.'+winning_ad.bidder+'.dont_refresh') == 1
				) {
					continue;
				}

				// Don't include ads that don't break price floor
				if(winning_ad.price >= floor_price) {
					// set winning ad
					slot.winning_ad = winning_ad;
					// remove the winning ad from the ads array
					this.ads.splice(i,1).pop();
					break;
				}
			}
		}
	}

}

		var cookieMatchingObj = function(page) {

		this.proper_tracker_cookie = {       // cookie saved by us to track user and bidder cookies
			'pid' : '', 
			'bidders': {} 
		}, 
		this.s_to_s_bidders        = {},     // list of bidders that use server to server
		this.done_matching         = false,  // flag to tell if we are done matching cookies with bidders
		this.sent                  = 0,      // number of requests sent to bidders to match
		this.received              = 0,      // number of requests returned from bidders
		this.timeout               = 500,    // timeout ms
		this.timeout_handle        = null,   // handle for timeout to wait for cookie matching responses
		this.page                  = page;   // page obj

		// check if we need to do cookie matching
		this.cookieMatch = function() {

			this.getTrackerCookie();

			// Check if proper_uid is in the tracking cookie
			if(!this.proper_tracker_cookie.hasOwnProperty('proper_uid') || this.proper_tracker_cookie.proper_uid == '') {
				// Generate new proper_uid
				this.proper_tracker_cookie.proper_uid = user.pubcid;
			}

			// loop through server to server bidders
			for(bidder in this.s_to_s_bidders) {

				// if we dont have the bidders matching cookie
				if(this.s_to_s_bidders[bidder] == 1) {

					if( typeof this.proper_tracker_cookie.bidders[bidder] === 'undefined' || this.proper_tracker_cookie.bidders[bidder] == 0 ) {

						// check if we have cookie but havent sent it to proper.io yet
						if(typeof getCookieValue(bidder+'_cookie') !== 'undefined' && getCookieValue(bidder+'_cookie') !== '') {
							this.proper_tracker_cookie.bidders[bidder] = 1;
						} else {
							this.requestCookieMatch(bidder);
						}
					}

					if(bidder == 'pubmatic') {
						var tempObj = this;
                        $(function() {
                            try {
                                // Append Iframe to do sync up-pixeling
                                var iframe = document.createElement('iframe');
                                iframe.style.display = 'none';
                                iframe.src = tempObj.page.protocol+'//ads.pubmatic.com/AdServer/js/user_sync.html?p=156374&s=206686&predirect=';
                                document.body.appendChild(iframe);
                            } catch(e) {
                            	console.log(e);
                            	sendError(TraceKit.computeStackTrace(e));
                            }
                        });
                    }
				}
			}

			// Save cookie
			this.setTrackerCookie();

			// if we didnt sent any maching requests
			if(this.sent == 0) {
				this.matchingDone();

			// set timeout to wait for cookie matching responses
			} else {
				this.addTimeout();
			}
		}

		this.requestCookieMatch = function(bidder) {

			//logging
 			page.log.mylog('Start '+bidder+' Cookie Matching','proper');

			//send request
			var obj = this; obj.sent++; var uri = ''; var uid = '';

			// Sovrn
			if(bidder == 'sovrn') {
				uri = obj.page.protocol+'//ap.lijit.com/pixel?redir=';
				uid = '$UID';
			// Pubmatic
			} else if(bidder == 'pubmatic') {
				uri = obj.page.protocol+'//image6.pubmatic.com/AdServer/UCookieSetPug?oid=1&rd=';
				uid = '#PM_USER_ID';
			// DistrictM
			} else if(bidder == 'districtm') {
				uri = obj.page.protocol+'//ib.adnxs.com/getuid?';
				uid = '$UID';
			}

			// UID and URI are set
			if(uid != '' && uri != '') {
				var redir = encodeURIComponent(obj.page.protocol+'//s2s.proper.io/?savecookie=1&bidder='+bidder+'&proper_uid='+this.proper_tracker_cookie.proper_uid+'&uid='+uid);
				$.ajax({
					url: uri+redir,
					requestType: "jsonp"
				});
			}
		}

		// Log a response has come back
		this.logMatchingResponse = function(bidder, proper_uid, bidder_uid) {
			// save backup cookie
			var date  = new Date();
			var days = 365; //expire in x hours
			date.setTime(date.getTime()+(days*24*60*60*1000));
			document.cookie = bidder+"_cookie="+bidder_uid+"; expires="+date.toGMTString()+"; path=/; domain=."+this.page.domain+";";

			this.received++;
			this.proper_tracker_cookie.bidders[bidder] = 1;
			this.setTrackerCookie();

			// check if we have gotten all responses back
			if(this.received >= this.sent) {
				this.matchingDone();
			}
		}

		// We are done cookie matching
		this.matchingDone = function() {

	 		if(this.done_matching == 1) return;
 			this.done_matching = 1;

 			page.log.mylog('S2S Cookie Matching Done','s2s');

 			// turning off timeout
 			this.resetTimeout();
		}

		this.getTrackerCookie = function() {
			// check for our cookie
			if(typeof getCookieValue('proper_tracker_cookie') !== 'undefined') {

				// Get cookie value
				var cookie_string_value = getCookieValue('proper_tracker_cookie') || '';

				// Check if cookie is base64 encoded and decode
				if(ProperMedia.utils.isBase64(cookie_string_value)) {
					cookie_string_value = ProperMedia.utils.b64DecodeUnicode(cookie_string_value);
				} else {
					cookie_string_value = decodeURIComponent(cookie_string_value);
				}
				// Set cookie object
				this.proper_tracker_cookie = ProperMedia.utils.safeJsonParse(cookie_string_value) || this.proper_tracker_cookie;
			}
		}

		// set / update the tracking cookie
		this.setTrackerCookie = function() {
			var date  = new Date();
			date.setTime(date.getTime()+(365*24*60*60*1000));

			// Base 64 encoded cookie value
			var encoded_cookie_value = ProperMedia.utils.b64EncodeUnicode(JSON.stringify(this.proper_tracker_cookie));

			// save tracker cookie
			document.cookie = "proper_tracker_cookie="+encoded_cookie_value+"; expires="+date.toGMTString()+"; path=/; domain=."+this.page.domain+";";
		}

		// add timeout
		this.addTimeout = function() {
			var obj = this;
	 		this.timeout_handle = properSetTimeout.setTimeout.call(obj, function(){ obj.resetTimeout(); obj.matchingDone(); }, obj.timeout );
	 	}

		// reset timeout
	 	this.resetTimeout = function() {
	 		clearTimeout(this.timeout_handle);
	 		this.timeout_handle = null;
	 	}

	}
		var sessionObj = function(page) {

		this.page = page,
		this.sessionData = {
			uuid     	 : '', // session id (universal unique id)
			depth    	 : 0,  // depth of session
			referrer 	 : '', // referrer
			utm_campaign : '', // utm vars
			utm_source 	 : '', // utm vars
			utm_medium 	 : '', // utm vars
			utm_term 	 : ''  // utm vars
		},
		this.newCookieName = 'properSessionData',
		this.oldCookieName = 'sessionData';

		this.init = function() {

			this.getSessionCookie();

			// check session id
			if(typeof this.sessionData.uuid == 'undefined' || this.sessionData.uuid == '') {
				this.sessionData.uuid = generateUUID();
			}

			// Get session depth count
			if(typeof this.sessionData['depth'] !== 'undefined') {
				this.sessionData['depth'] = this.sessionData['depth'] + 1;
			} else this.sessionData['depth'] = 1;


			var new_referrer = '', new_utm = {};
			// Referrer is not the same domain
			if(this.page.referrer !== '' && !matchDomain(this.page.domain, this.page.referrer)) {
				new_referrer = this.page.referrer;
	    	}

	    	// UTM Medium
			if(typeof this.page.get_vars['utm_medium'] !== 'undefined') {
				new_utm['utm_medium'] = this.page.get_vars['utm_medium'];
			}

			// UTM Source
			if(typeof this.page.get_vars['utm_source'] !== 'undefined') {
				new_utm['utm_source'] = this.page.get_vars['utm_source'];
			}

			// UTM Campaign
			if(typeof this.page.get_vars['utm_campaign'] !== 'undefined') {
				new_utm['utm_campaign'] = this.page.get_vars['utm_campaign'];
			}

			// UTM Term
			if(typeof this.page.get_vars['utm_term'] !== 'undefined') {
				new_utm['utm_term'] = this.page.get_vars['utm_term'];
			}

			// referrer or utm variables changed
			if(new_referrer !== '' || Object.keys(new_utm).length > 0) {
				this.sessionData['referrer'] 	 = new_referrer;
				this.sessionData['utm_campaign'] = (typeof new_utm.utm_campaign !== 'undefined') ? new_utm.utm_campaign : '';
				this.sessionData['utm_source']   = (typeof new_utm.utm_source   !== 'undefined') ? new_utm.utm_source   : '';
				this.sessionData['utm_medium']   = (typeof new_utm.utm_medium   !== 'undefined') ? new_utm.utm_medium   : '';
				this.sessionData['utm_term']  	 = (typeof new_utm.utm_term     !== 'undefined') ? new_utm.utm_term     : '';
			}

			this.setSessionCookie();
		}

		this.getSessionCookie = function() {

			// Check for new cookie
			if(typeof getCookieValue(this.newCookieName) !== 'undefined') {

				// Get cookie value
				var cookie_string_value = getCookieValue(this.newCookieName) || '';

				// Check if cookie is base64 encoded and decode
				if(ProperMedia.utils.isBase64(cookie_string_value)) {
					cookie_string_value = ProperMedia.utils.b64DecodeUnicode(cookie_string_value);
				} else {
					cookie_string_value = decodeURIComponent(cookie_string_value);
				}
				// Set settion object
				var cookieSessionData = ProperMedia.utils.safeJsonParse(cookie_string_value) || {};
				ProperMedia.utils.mergeObject(this.sessionData, cookieSessionData);

            // Check for old cookie
			} else if(typeof getCookieValue(this.oldCookieName) !== 'undefined') {
				var cookieData = ProperMedia.utils.safeJsonParse(getCookieValue(this.oldCookieName));
                if(cookieData != null) {

                	// Only copy over our variables from old coookie
                	for(key in this.sessionData) {
                		if(typeof cookieData[key] !== 'undefined') {
                			this.sessionData[key] = cookieData[key];
                		}
                	}

                	// decode variables if they are encoded in the cookie
                	if(typeof cookieData.encoded != 'undefined' && cookieData.encoded == 1) {
						this.sessionData['referrer'] 	 = decodeURIComponent(this.sessionData['referrer']);
						this.sessionData['utm_campaign'] = decodeURIComponent(this.sessionData['utm_campaign']);
						this.sessionData['utm_source']   = decodeURIComponent(this.sessionData['utm_source']);
						this.sessionData['utm_medium']   = decodeURIComponent(this.sessionData['utm_medium']);
						this.sessionData['utm_term']  	 = decodeURIComponent(this.sessionData['utm_term']);
					}
                }
			}
		}

	    this.setSessionCookie = function() {
			// cookie to expire in 30 min
			var date  = new Date();
			date.setTime(date.getTime()+(30*60*1000));

			// Base 64 encoded cookie value
			var encoded_cookie_value = ProperMedia.utils.b64EncodeUnicode(JSON.stringify(this.sessionData));

			// save session cookie
			document.cookie = this.newCookieName+"="+encoded_cookie_value+"; expires="+date.toGMTString()+"; path=/; domain=."+this.page.domain+";";
	    }

	    this.deleteCookie = function(cookieName) {
	    	var date  = new Date();
			date.setTime(date.getTime()-(60*1000));
	    	document.cookie = cookieName+"=; expires="+date.toGMTString()+"; path=/; domain=."+this.page.domain+";";
	    }

	}
	var userSyncs = (function() {
    var started = false;
    var interval = null;
    var container = null;
    var pending = [];

    function id(prefix) {
        return (prefix || '') + Math.random().toString(16).substr(2);
    }

    var insert = {
        'iframe': function(url) {
            var ifr = document.createElement('iframe');
            ifr.id = id('i-');
            ifr.frameborder = '0';
            ifr.allowtransparency = 'true';
            ifr.marginheight = '0';
            ifr.marginwidth = '0';
            ifr.width = '0';
            ifr.hspace = '0';
            ifr.vspace = '0';
            ifr.height = '0';
            ifr.scrolling = 'no';
            ifr.style.display = 'none';
            ifr.style.width = '0';
            ifr.style.height = '0';
            ifr.sandbox = 'allow-scripts allow-same-origin';
            ifr.src = url;
            container.appendChild(ifr);
        },
        'image': function(url) {
            var img = new Image();
            img.src = url;
        }
    };

    function process() {
        pending.splice(0, 5).forEach(function(sync) {
            // console.log('process sync', sync);
            insert[sync.type](sync.url);
        });

        if (pending.length === 0) {
            clearInterval(interval);
            interval = null;
        }
    }

    function resume() {
        if (!started) return;
        if (pending.length === 0) return;
        if (interval !== null) return;
        interval = setInterval(process, 100);
        // Do the first batch right away
        properSetTimeout.setTimeout(process, 0);
    }

    return {
        add: function(syncs) {
            pending = pending.concat(syncs);
            resume();
        },
        start: function() {
            if (!started) {
                started = true;
                container = document.createElement('div');
                container.id = id('us-');
                container.style.display = 'none';
                container.style.width = '0';
                container.style.height = '0';
                document.body.appendChild(container);
            }
            resume();
        }
    };
})();

	// @import-if "native_blocker : 1" "adBlockerObj.js";
	var gdprConsent = (function() {
    function lookupIABConsent(cmpSuccess, cmpError) {
        var cmpResponse = {};

        function handleCmpResponseCallback(method, response) {
            cmpResponse[method] = response;
            if (cmpResponse.getConsentData && cmpResponse.getVendorConsents) {
                cmpSuccess({
                    consentString: cmpResponse.getConsentData.consentData,
                    vendorData: cmpResponse.getVendorConsents,
                    gdprApplies: cmpResponse.getConsentData.gdprApplies
                });
            }
        }

        var cmpCallbacks = {};
        var cmpFunction;
        var cmpLoadWait = 2000;

        try {
          cmpFunction = window.__cmp || window.top.__cmp;
        } catch(e) {}

        if(Object.prototype.toString.call(cmpFunction) == '[object Function]') {
            cmpFunction('getConsentData', null,
                handleCmpResponseCallback.bind(null, 'getConsentData')
            );
            cmpFunction('getVendorConsents', null,
                handleCmpResponseCallback.bind(null, 'getVendorConsents')
            );
            setTimeout(function() {
                var pingTimeout = setTimeout(function() {
                    cmpError('CMP unresponsive.');
                }, 100);
                cmpFunction('ping', null, function(response) {
                    clearTimeout(pingTimeout);
                    if (!response.cmpLoaded) {
                        cmpError('CMP did not load.');
                    }
                })
            }, cmpLoadWait);
        } else {
            var f = window;
            var cmpFrame;

            while(!cmpFrame) {
                try {
                    if (f.frames['__cmpLocator']) cmpFrame = f;
                } catch(e){}
                if (f === window.top) break;
                f = f.parent;
            }

            if(!cmpFrame) {
                return cmpError('CMP not found.');
            }

            callCmpWhileInIframe('getConsentData', cmpFrame,
                handleCmpResponseCallback.bind(null, 'getConsentData')
            );
            callCmpWhileInIframe('getVendorConsents', cmpFrame,
                handleCmpResponseCallback.bind(null, 'getVendorConsents')
            );
            setTimeout(function() {
                var pingTimeout = setTimeout(function() {
                    cmpError('CMP unresponsive.');
                }, 100);
                callCmpWhileInIframe('ping', cmpFrame, function(response) {
                    clearTimeout(pingTimeout);
                    if (!response.cmpLoaded) {
                        cmpError('CMP did not load.');
                    }
                })
            }, cmpLoadWait);
        }

        function callCmpWhileInIframe(commandName, cmpFrame, moduleCallback) {
            /* Setup up a __cmp function to do the postMessage and stash the callback.
            This function behaves (from the caller's perspective identicially to the in-frame __cmp call */
            window.__cmp = function(cmd, arg, callback) {
                var callId = Math.random() + '';
                var msg = {__cmpCall: {
                    command: cmd,
                    parameter: arg,
                    callId: callId
                }};
                cmpCallbacks[callId] = callback;
                cmpFrame.postMessage(msg, '*');
            }

            /** when we get the return message, call the stashed callback */
            window.addEventListener('message', readPostMessageResponse, false);

            // call CMP
            window.__cmp(commandName, null, cmpIframeCallback);

            function readPostMessageResponse(event) {
                var json = (typeof event.data === 'string' && strIncludes(event.data, 'cmpReturn')) ? ProperMedia.utils.safeJsonParse(event.data) : event.data;
                if (json.__cmpReturn && json.__cmpReturn.callId) {
                    var i = json.__cmpReturn;
                    // TODO - clean up this logic (move listeners?); we have duplicate messages responses because 2 eventlisteners are active from the 2 cmp requests running in parallel
                    if (typeof cmpCallbacks[i.callId] !== 'undefined') {
                        cmpCallbacks[i.callId](i.returnValue, i.success);
                        delete cmpCallbacks[i.callId];
                    }
                }
            }

            function removePostMessageListener() {
                window.removeEventListener('message', readPostMessageResponse, false);
            }

            function cmpIframeCallback(consentObject) {
                removePostMessageListener();
                moduleCallback(consentObject);
            }
        }

    }

    var pendingWaiters = [];
    var gdprConsent = {
        cmpPresent: null,
        ready: function(callback) { pendingWaiters.push(callback); }
    };

    function callPendingWaiters() {
        gdprConsent.ready = function(callback) { callback(gdprConsent); };
        pendingWaiters.forEach(gdprConsent.ready);
        pendingWaiters.length = 0;
    }

    lookupIABConsent(function(data) {
        gdprConsent.cmpPresent = true;
        gdprConsent.consentString = data.consentString;
        gdprConsent.vendorData = data.vendorData;
        gdprConsent.gdprApplies = data.gdprApplies;
        if (data.gdprApplies) {
            // if no consent for "Personalisation" (used to configure DFP/Adsense/etc)
            gdprConsent.noPersonalization = !gdprConsent.vendorData.purposeConsents[2];
            // if no consent for "Storage and access of information" or "Personalisation"...
            if (!gdprConsent.vendorData.purposeConsents[1] && !gdprConsent.vendorData.purposeConsents[2]) {
                // disable DFP/Adsense/etc
                gdprConsent.isolated = true;
            }
        }
        callPendingWaiters();
    }, function(error) {
        // Ignore error if we've already received a success.
        if (!gdprConsent.cmpPresent) {
            gdprConsent.cmpPresent = false;
            callPendingWaiters();
        }
    });

    return gdprConsent;
})();

	// @import-if "confiant : 1" "confiantWrapper.js";

	//   END OBJECTS
	//~~~~~~~~~~~~~~~~~

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	// Set page options and set page slot data
	function set_options(val) {

		// options object
		ops = new optionsObj();

		// set options
		for (var key in val) {
			if(key == "post_id") ops.post_id_enabled = 1;
			else if(key == "member") ops.member_enabled = 1;
			ops[key] = val[key];
		}

		// enable/disable ast settings
		if(ops.hasOwnProperty('ast_settings')) {
			for(key in ops.ast_settings) {
				if(ops.bidder_info.hasOwnProperty(key)) {
					ops.bidder_info[key].ast = ops.ast_settings[key];
				}
			}
		}

		// add styles
		if( !(typeof special_ops.kill_all_ads !== 'undefined' && special_ops.kill_all_ads == "yes") ) {

			var style = document.createElement('style');
			style.type = 'text/css';

			var css = ".proper-ad-unit{margin:auto;position:relative;display:block;min-width:100px;text-align:center;box-sizing:border-box !important}.proper-ad-unit *{box-sizing:border-box !important;}.proper-ad-unit>div:first-of-type{position:relative;margin:auto}.proper-ad-uni\\t>div:first-of-type.active-highlight:after{content:\'\';margin:auto;position:absolute;top:0;right:0;bottom:0;left:0;pointer-events:none;background:none;border:5px solid rgba(218,48,48,0.85)}.proper-ad-unit>div:first-of-type>.noad{background-color:#c2c2c2}.proper-ad-unit .report-ad{position:relative !important;display:block !important;font-family:\'Source Sans Pro\', sans-serif;left:0;right:0;color:#999 !important;font-size:12px;line-height:23px;white-space:nowrap;text-decoration:none !important;-webkit-font-smoothing:antialiased}.proper-ad-unit .report-ad:hover{color:black;text-decoration:underline !important}.proper-ad-unit.ad-sticky{position:fixed;display:block;z-index:100}.proper-ad-unit.ad-sticky.open{transition:all 1.5s ease-in}.proper-ad-unit.ad-sticky.close{transition:all 1s ease-in}.proper-ad-unit.ad-sticky.sticky-btm{padding-top:0;width:100%;height:auto;position:fixed;z-index:9999;text-align:center;padding-bottom:0;background:rgba(40,40,40,0.9);top:auto;right:0;bottom:-100%;left:0}.proper-ad-unit.ad-sticky.sticky-btm.open,.proper-ad-unit.ad-sticky.sticky-btm.isOpen{bottom:0}.proper-ad-unit.ad-sticky.sticky-btm.close,.proper-ad-unit.ad-sticky.sticky-btm.isClosed{bottom:-100%}.proper-ad-unit.ad-sticky.sticky-btm.sticky-compact{display:none !important}.proper-ad-unit.ad-sticky.sticky-btm .brand{top:-16px;left:0;right:0;background:rgba(40,40,40,0.9);height:16px;width:62px;border-radius:0 3px 0 0}.proper-ad-unit.ad-sticky.sticky-btm .brand:after{top:2px;left:0;width:61px;height:15px;background-size:56px 14px}.proper-ad-unit.ad-sticky.sticky-btm .inner-wrapper{margin:auto;padding:0;position:relative !important;display:block;width:100%;height:0 !important;max-width:calc(100% - 60px);height:auto;font-family:Arial, \'Helvetica Neue\', Helvetica, sans-serif;background:none}.proper-ad-unit.ad-sticky.sticky-btm .inner-wrapper .close-ad{top:-15px;right:-30px;width:30px;height:29px;font-size:16px;line-height:21px}.proper-ad-unit.ad-sticky.sticky-btm .inner-wrapper .close-ad:after{width:22px;height:22px;color:rgba(255,255,255,0.75);background:#555;border-radius:100px;-moz-border-radius:100px;-webkit-border-radius:100px;margin:4px auto;vertical-align:middle}.proper-ad-unit.ad-sticky.sticky-btm .inner-wrapper .close-ad:after:hover{color:#fff}.proper-ad-unit.ad-sticky.sticky-btm .inner-wrapper .report-ad{width:50px;height:12px;top:-11px;background:none;color:rgba(0,0,0,0) !important}.proper-ad-unit.ad-sticky.sticky-btm .ad-wrapper{position:relative;margin:auto;z-index:9;margin-top:3px}.proper-ad-unit.ad-sticky.sticky-left,.proper-ad-unit.ad-sticky.sticky-right{top:0;bottom:0;padding-top:20px !important;padding-bottom:20px !important}.proper-ad-unit.ad-sticky.sticky-left .brand,.proper-ad-unit.ad-sticky.sticky-right .brand{top:4px;height:12px;width:54px;z-index:1}.proper-ad-unit.ad-sticky.sticky-left .brand:after,.proper-ad-unit.ad-sticky.sticky-right .brand:after{top:0;width:54px;height:12px;background-size:54px 12px}.proper-ad-unit.ad-sticky.sticky-left .inner-wrapper,.proper-ad-unit.ad-sticky.sticky-right .inner-wrapper{margin-top:0;margin-bottom:0;position:absolute;top:0;bottom:0;left:0;right:0;background:rgba(40,40,40,0.9)}.proper-ad-unit.ad-sticky.sticky-left .inner-wrapper .close-ad,.proper-ad-unit.ad-sticky.sticky-right .inner-wrapper .close-ad{color:#999;font-size:20px;line-height:19px}.proper-ad-unit.ad-sticky.sticky-left .inner-wrapper .report-ad,.proper-ad-unit.ad-sticky.sticky-right .inner-wrapper .report-ad{bottom:0;font-weight:700;letter-spacing:.5px;text-transform:uppercase;line-height:21px;font-size:11px}.proper-ad-unit.ad-sticky.sticky-left .inner-wrapper .report-ad:hover,.proper-ad-unit.ad-sticky.sticky-right .inner-wrapper .report-ad:hover{text-decoration:none !important;color:white !important}.proper-ad-unit.ad-sticky.sticky-left{left:-100%}.proper-ad-unit.ad-sticky.sticky-left .inner-wrapper{border-radius:0 5px 5px 0}.proper-ad-unit.ad-sticky.sticky-left .close-ad{right:5px}.proper-ad-unit.ad-sticky.sticky-left .brand{left:5px}.proper-ad-unit.ad-sticky.sticky-left .brand:after{left:0}.proper-ad-unit.ad-sticky.sticky-right{right:-100%}.proper-ad-unit.ad-sticky.sticky-right .inner-wrapper{border-radius:5px 0 0 5px}.proper-ad-unit.ad-sticky.sticky-right .close-ad{left:5px}.proper-ad-unit.ad-sticky.sticky-right .brand{right:5px}.proper-ad-unit.ad-sticky.sticky-right .brand:after{left:0}.proper-ad-unit.ad-sticky.open.sticky-right,.proper-ad-unit.ad-sticky.isOpen.sticky-right{right:0}.proper-ad-unit.ad-sticky.open.sticky-left,.proper-ad-unit.ad-sticky.isOpen.sticky-left{left:0}.proper-ad-unit.ad-sticky.close.sticky-right,.proper-ad-unit.ad-sticky.isClosed.sticky-right{right:-100%}.proper-ad-unit.ad-sticky.close.sticky-left,.proper-ad-unit.ad-sticky.isClosed.sticky-left{left:-100%}.proper-ad-unit.ad-sticky.sticky-120x600.sticky-left,.proper-ad-unit.ad-sticky.sticky-120x600.sticky-right{width:120px;height:640px}.proper-ad-unit.ad-sticky.sticky-160x600.sticky-left,.proper-ad-unit.ad-sticky.sticky-160x600.sticky-right{width:160px;height:640px}.proper-ad-unit.ad-sticky.sticky-300x600.sticky-left,.proper-ad-unit.ad-sticky.sticky-300x600.sticky-right{width:300px;height:640px}.proper-ad-unit.ad-sticky.sticky-300x250.sticky-left,.proper-ad-unit.ad-sticky.sticky-300x250.sticky-right{width:300px;height:290px}.proper-ad-unit.ad-sticky .brand{position:absolute !important}.proper-ad-unit.ad-sticky .brand:after{content:\'\';position:absolute;background-image:url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHcAAAAeCAYAAAAWwoEYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA3hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTM4IDc5LjE1OTgyNCwgMjAxNi8wOS8xNC0wMTowOTowMSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo4ZDJkODBlZS1kYTVhLTRiNGUtYWMwZS1iZmI0ODE2ZGRjYTgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6QjIzNUY5QkE4MkREMTFFODgyMkM4QUM2OTM0NUM1RUYiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NjcxMzE2MzQ4MkREMTFFODgyMkM4QUM2OTM0NUM1RUYiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTcgKE1hY2ludG9zaCkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4NjczMThlNC02ZmY0LTRiNDctYTAwNC00ZGFkNzc0NzE2MjQiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OGQyZDgwZWUtZGE1YS00YjRlLWFjMGUtYmZiNDgxNmRkY2E4Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+UshKoAAABFdJREFUeNrsmk9IFFEcx3dUjO0vZJ0kUAupQ+QtqJMg4iXoYF46CAtetcNe6mInTx7aTnlIok5B0FYsZkehwwaR2iFCI8tEMDtUmn/S2b6PfrP8fL6ZeTPz1h1hfvBhZ997v3m/md/7vffmN2OVSqVUAGkEt+lY/C6kEomtWAGcewf0S2V3wY3kNu5f52bIiYfov6Ng0e8qOX00uZ37x7lt4AloJkc6ztym31rmbMFn0A0mk9saD6lxKc+Dt6CFOVU4cBrUEdM8ijFITuP3HVihaE8kZpHbC0bAAeY4IT/AdfAquWX7R+ro9yJNwY1S/RYYBrd8zqOzK7NclRVLg2VZvicMq2dCTNocKio1+hLT8jh4rXDsGKjXcKyn44LcLxhchq3lYoB9AfdAk0E9WdJgABTBGlGksrRpmwMQvq/Sf7EZi6BVjLAQeImrnm3bfrqO/AZdUfUUnAMzHvoz1MaIzaAUgNB9ceeugWxIpzq0Vti5Qn6Bpih6EqJsSUN/ietHsbmCzt3RVw2F9jOaeoal6aOV0JEC+Ki5/vrJcfb4JfYFl8E3qjsCbhrUewBOsv/X6F6k6dgR0eZhBWy2fAjfl0dEFdhoKHi0GwKbFP0l9hslco8p2l1i9V+j6DE6JP12hX671KYjqs1yZPrNiGH70nGW47BNqnPadYLv0notZBvkQZth59az+o0oeoz7rG7Qw8ZB1u5RVJsr5NxdfaU0nCVvuESbKanMlpyq2mTFMXJnWZ3XJrKFtftkOnLdiHp/nOfcKXBesV1/TsdX2PzfAE4ESD1aIdbhWulxTTyHP2ZlLw3pnWLHcx72zLvomLC5FOLxUq8vaUQ4ETgrRWAblW1LEb0CMhF32Hu6W5aiYoPV13vYeJC1W92j3XKk+yN05NzyH9AHzkhROEllfdRGjLYcOKzxNugpsA0lhkTeuscnynY5hxISPTie84hIr0QHT/AsGLY5yC452HXqbnokGjXbremuuWK0uoiYLebBCGjW1ZOiYBbUKdazSBuqKDYH3VCFuU6lc72mCJfOd7R3yVj5Gh/kgjU2Jzmprl/h3EiPQqZsrtR1ujkgz9ZXW8MAecccKnINO7cBLLO6ZSpLSeefkO5BNzgAjtIxl4kK2+xF4OuUnZtlC3h5E+UY7hHR5U0YK8uSc+0qOTdFo5jX5xTODZ1+NGSzVvoxzHXqvDjISNNs+RmYXVBGyi8vKp6Xq+Fcsf58YPV/wVnF+UO9OIiRc5XXKTocB1sKZxQ8pl+36bqgGCxb1Ec1nCvoktqMuZw/DQbAG7AOfoIilaUraLMJ5yqv0/kSQ35Zb7F3hfxlvdunrUMgS0lsnrRYoORGMW4vvqO+1K/2y/pUiGelXhq1qpRjp2IkuqUs1+lcqYTq4fb1Y15KOTryHlzwSVm+AFeTL5iST1sTqcKnraqUI9ep0UhZJhJj5zoySjnknPzBVoD8ciIxm5bdEuiq3XIiMZR/AgwAEp2vo1fQ15UAAAAASUVORK5CYII=\");background-position:center center;background-repeat:no-repeat}.proper-ad-unit.ad-sticky .inner-wrapper .close-ad{display:block;position:absolute !important;text-decoration:none;z-index:9999}.proper-ad-unit.ad-sticky .inner-wrapper .close-ad:after{content:\"\\00d7\";font-family:sans-serif;display:block}.proper-ad-unit.ad-sticky .ad-wrapper{position:relative;z-index:9}";

			if(typeof ops.extra_css !== 'undefined' && ops.extra_css != '') css += ops.extra_css;

			if (style.styleSheet) style.styleSheet.cssText = css;
			else style.appendChild(document.createTextNode(css));
			document.getElementsByTagName('head')[0].appendChild(style);
		}

		// initilize page object
		var page = new pageObj();

		// use different adx bid modifiers for mobile and desktop, if defined
		if (page.is_mobile==1 && ops.hasOwnProperty('mobile_adx_bid_mod') && ops.mobile_adx_bid_mod > 0) {
			ops.adx_bid_modifier = ops.mobile_adx_bid_mod;
		} else if (page.is_mobile==0 && ops.hasOwnProperty('desktop_adx_bid_mod') && ops.desktop_adx_bid_mod > 0) {
			ops.adx_bid_modifier = ops.desktop_adx_bid_mod;
		}

		// use different floors for mobile and desktop, if defined
		if (page.is_mobile == 1 && ops.hasOwnProperty('mobile_floor')) {
			ops.backup_floor = ops.mobile_floor;
		} else if (page.is_mobile == 0 && ops.hasOwnProperty('desktop_floor')) {
			ops.backup_floor = ops.desktop_floor;
		}
		ops.backup_floor = round_floor(ops.backup_floor);

		//switch to ISO mode when testing bidder
		if(typeof page.get_vars.proper_test != 'undefined' && page.get_vars.proper_test!="") {
			page.log.mylog("TESTING MODE: "+page.get_vars.proper_test)
			ops.testing_mode           = 1;
			ops.refresh                = 0;
			ops.backup_floor           = 0.01;
			//ops.secondary_backup_floor = 0.01;
			ops.isolated               = (typeof page.get_vars.proper_dfp !== 'undefined' && page.get_vars.proper_dfp == 1) ? 0 : 1;
			page.isolated              = ops.isolated;
		}

		// initilize user object
		user = new userObj();

		//build slots
		page.buildDefaultSlots();

		// add page to pages array (needed for infinite scroll)
		pages.push(page);

		// Init Cookie matching object
		cookieMatching = new cookieMatchingObj(page);

		// Init Redirect AdBlocker code
		if(typeof ops.native_blocker!=="undefined" && ops.native_blocker==1) {
			//only turn on in mobile
			if(page.is_mobile != 1 && ops.native_blocker_desktop < 1) {
				ops.native_blocker = 0;
			} else {
				adBlocker = new adBlockerObj();
			}
		}
	}

	// END Page options
	//~~~~~~~~~~~~~~~~~~~

	// Register a new event callback
	function subscribeToEvents(callback) {
		event_callbacks.push(callback);
	}

	// Dispatch an event to registered callbacks
	function dispatchEvent(event) {
		event_callbacks.forEach(function(callback) {
			// Run callback outside of our current execution context
			properSetTimeout.setTimeout(function() {
				// Catch and ignore any errors
				try {
					callback.call(null, event);
				} catch(e) {
					console.error(e);
					sendError(TraceKit.computeStackTrace(e));
				}
			}, 0);
		});
	}

	// Add new page for infinite scroll
	function newPage() {

		// kill everything!
		if(typeof special_ops.kill_all_ads !== 'undefined' && special_ops.kill_all_ads == "yes") return false;

		// initilize page object
		var page = new pageObj();
		pages.push(page);

		page.log.mylog('========== New Page ==========');

	}

	//~~~~~~~~~~~~~~~~~~~~~
	// FORMAT REQUEST DATA

	/*
	*  slot        : slot object
	*  slot_name   : name of slot. Ex: tvtropes_main_1
	*  slot_number : slot number in array
	*  tag_id      : bidder id for that slot size
	*  size        : slot size
	*  bid         : bid object
	*/

	function formatRemnantRequests(slot, tag_id, size, bid) {
		bid.requests[size] = tag_id;
		return bid;
	}

	bidAdapters.rubicon = (function() {
	/*
	  IMPORTANT: when updating this rev_share, you MUST also update
	  the value of 'var RUBICON_REVSHARE'.
	  This value can be found in the rubicon_stats.php file in the proper-io project:
	  https://github.com/proper-media/proper-io/blob/develop/site/proper_data/advertiser_apis/rubicon_stats.php
	*/
	var bidderInfo = {
        rev_share   : 0.80,
        bid_grouping: 'page',
        default_bid_ttl: 300000
	};

    var bidder = 'rubicon';

    var ENDPOINT_URL  = '//fastlane.rubiconproject.com/a/api/fastlane.json',
        SYNC_ENDPOINT = 'https://eus.rubiconproject.com/usync.html';

    var sizeMap = {
        '468x60': 1,
        '728x90': 2,
        '120x90': 5,
        '120x600': 8,
        '160x600': 9,
        '300x600': 10,
        '200x200': 13,
        '250x250': 14,
        '300x250': 15,
        '336x280': 16,
        '300x100': 19,
        '980x120': 31,
        '250x360': 32,
        '180x500': 33,
        '980x150': 35,
        '468x400': 37,
        '930x180': 38,
        '750x100': 39,
        '750x200': 40,
        '750x300': 41,
        '320x50': 43,
        '300x50': 44,
        '300x300': 48,
        '1024x768': 53,
        '300x1050': 54,
        '970x90': 55,
        '970x250': 57,
        '1000x90': 58,
        '320x80': 59,
        '320x150': 60,
        '1000x1000': 61,
        '580x500': 64,
        '640x480': 65,
        '930x600': 66,
        '320x480': 67,
        '1800x1000': 68,
        '320x320': 72,
        '320x160': 73,
        '980x240': 78,
        '980x300': 79,
        '980x400': 80,
        '480x300': 83,
        '970x310': 94,
        '970x210': 96,
        '480x320': 101,
        '768x1024': 102,
        '480x280': 103,
        '250x800': 105,
        '320x240': 108,
        '1000x300': 113,
        '320x100': 117,
        '800x250': 125,
        '200x600': 126,
        '980x600': 144,
        '980x150': 145,
        '320x250': 159,
        '250x600': 179,
        '600x300': 195,
        '640x360': 198,
        '640x200': 199,
        '1030x590': 213,
        '980x360': 214,
        '320x180': 229,
        '580x400': 232,
        '400x600': 257
    };

    Object.keys(sizeMap).forEach(function(x) {
        sizeMap[sizeMap[x]] = x;
    });

    function formatRequest(slot, tag_id, size, bid) {

        if(typeof bid.requests[slot.name] == 'undefined') {
            bid.requests[slot.name] = {
                'tag_id': tag_id,
                'slot_name': slot.name,
                'rubicon_sizes': [],
                'rubicon_floor': 0.01,
                'position': slot.position
            }
        }

        if(typeof sizeMap[size] !== 'undefined') {

            // Set price floor for slot
            var rubicon_floor = get_floor(bidder, slot, size);
            if(rubicon_floor < bid.requests[slot.name]['rubicon_floor'] || bid.requests[slot.name]['rubicon_floor'] == 0.01) {
                bid.requests[slot.name]['rubicon_floor'] = rubicon_floor;
            }

            // Add converted rubicon size
            bid.requests[slot.name]['rubicon_sizes'].push(sizeMap[size]);
        }

    	return bid;
    }

    function send(bid_level_obj, bid_level, requestData) {

        var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
        var slot = (bid_level == 'slot') ? bid_level_obj : {};

        var accountId = 8777,
            siteId    = ops.site_ids[bidder] || '';

        if(siteId == '') {
            page.log.mylog("Error: Rubicon site ID are required slot "+slot.name+".");
            return false;
        }

        var request_cnt = {
            'total': 0
        };

        var data = [];
        Object.keys(requestData).forEach(function(slot_name) {

            var obj    = requestData[slot_name];
            var zoneId = obj.tag_id || '';

            if(zoneId == '' || obj.rubicon_sizes.length == 0) {
                page.log.mylog("Error: Rubicon site ID are required slot "+obj['slot_name']+".");
                return false;
            }

            // Order sizes by priority
            obj['rubicon_sizes'] = masSizeOrdering(obj['rubicon_sizes']);

            var slotData = {
                'account_id'     : accountId,
                'site_id'        : siteId,
                'zone_id'        : zoneId,
                'size_id'        : obj['rubicon_sizes'][0],
                'alt_size_ids'   : obj['rubicon_sizes'].slice(1).join(','),
                'p_pos'          : obj['position'] === 'atf' || obj['position'] === 'btf' ? obj['position'] : 'unknown',
                'rp_floor'       : obj['rubicon_floor'],
                'rp_secure'      : (page.use_ssl == true) ? '1' : '0',
                'tk_flint'       : 'pbjs_lite_v2.2.0',
                'x_source.tid'   : generateUUID(),
                'p_screen_res'   : page.width+'x'+page.height,
                'kw'             : '',
                'tk_user_key'    : '',
                'p_geo.latitude' : undefined,
                'p_geo.longitude': undefined,
                'tg_fl.eid'      : obj['slot_name'],
                'rf'             : page.url
            };

            data.push(slotData);

            request_cnt['total']   += obj['rubicon_sizes'].length;
            if(request_cnt[obj['slot_name']] === undefined) {
                request_cnt[obj['slot_name']] = 0;
            }
            request_cnt[obj['slot_name']] += obj['rubicon_sizes'].length;

        });

        var combined_data = combineSlotUrlParams(data);

        // GDPR Consent
        if (gdprConsent.cmpPresent) {
            if (typeof gdprConsent.gdprApplies === 'boolean') {
                combined_data['gdpr'] = Number(gdprConsent.gdprApplies);
            }
            combined_data['gdpr_consent'] = gdprConsent.consentString;
        }

        combined_data['slots'] = data.length;
        combined_data['rand']  = Math.random();

        var orderedParams = getOrderedParams(combined_data);

        // Must encode data
        if(combined_data && typeof(combined_data) === 'object') {
            var y = '', e = encodeURIComponent;
            Object.keys(orderedParams).forEach(function(x) {
                if(combined_data[orderedParams[x]]) {
                    y += '&' + e(orderedParams[x]) + '=' + e(combined_data[orderedParams[x]]);
                }
            });
            post_data = y.slice(1);
        }

        var request_url = page.protocol+ENDPOINT_URL+'?'+post_data;

        //logging
        page.log.mylog(request_url,bidder);

        // log requests
        page.requests_sent += request_cnt['total'];
        Object.keys(request_cnt).forEach(function(slot_name) {
            if(slot_name == 'total') return;
            if(typeof page.slots[slot_name] !== 'undefined')
                page.slots[slot_name].bids_sent += request_cnt[slot_name];
        });
        bid_level_obj.bids[bidder].sent += request_cnt['total'];

    	var bid_sent_ts = getTimestampMs();

        //send request
        $.ajax({
            url: request_url,
            requestType: "cors",
            success: function(resp) {

                //parse resposne
                try {

        			//logging
        			page.log.mylog(resp,bidder);

    				var responseObj = ProperMedia.utils.safeJsonParse(resp) || {};
    				if(
                        responseObj &&
                        typeof responseObj == 'object'
                    ) {

    					var bids_received_ts = getTimestampMs();
    					var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

                        var ads = responseObj.ads || [];
                        if (Array.isArray(ads) && ads.length > 0) {

        					for(var i = 0; i < ads.length; i++) {

                                var ad = ads[i];

                                if(bid_level == 'page') slot = page.slots[data[i]['tg_fl.eid']] || {};

                                // Check slot object
                                if(!(slot instanceof slotObj)) continue;

        						//check status
        						if(ad.status !== "ok") {
                                    if(typeof ad.reason !== 'undefined') {
                                        page.log.mylog("rubicon resposne status: " + slot.name + " " + ad.reason);
                                    }
                                    continue;
                                }

        						//log bid
        						var cpm     = ad.cpm,
        						    status  = ad.status,
        						    adcode  = ad.script,
        						    adtype  = ad.type,
                                    size_id = ad.size_id,
                                    tag_id  = responseObj.zoneId;

                                var size = sizeMap[size_id] || 'unknown';

        						if(adtype == "script") adcode="<script>"+adcode+"</script>";

        						//identify ad
        						var ad_details = {};
        						if(typeof ad.advertiser  != "undefined") ad_details.advertiser  = ad.advertiser;
        						if(typeof ad.seat        != "undefined") ad_details.seat        = ad.seat;
        						if(typeof ad.creative_id != "undefined") ad_details.creative_id = ad.creative_id;
        						if(typeof ad.campaign_id != "undefined") ad_details.campaign_id = ad.campaign_id;
        						if(typeof ad.ad_id       != "undefined") ad_details.ad_id       = ad.ad_id;

        						// log bid
        						slot.logBidResponse(bidder, size, parseFloat(cpm), adcode, tag_id, request_url, ProperMedia.utils.safeJsonParse(resp), ad_details, bid_response_ms, requestData['rubicon_floor']);
        						page.log.log_bid(bidder, slot, size, parseFloat(cpm));
        					}
        				}
                    }

        			//log request as received regardless
                    if(bid_level == 'page') {
                        Object.keys(request_cnt).forEach(function(slot_name) {
                            if(slot_name == 'total') return;
                            if(typeof page.slots[slot_name] !== 'undefined')
                                page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
                        });
                    } else if(bid_level == 'slot') {
                        slot.incrementBidResponseCount(bidder,request_cnt['total']);
                    }

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }

            },
            error: function(resp) {
                try {
        			//log request as received regardless
                    if(bid_level == 'page') {
                        Object.keys(request_cnt).forEach(function(slot_name) {
                            if(slot_name == 'total') return;
                            if(typeof page.slots[slot_name] !== 'undefined')
                                page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
                        });
                    } else if(bid_level == 'slot') {
                        slot.incrementBidResponseCount(bidder,request_cnt['total']);
                    }

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
            }
        });
    }

    /**
    * @summary combines param values from an array of slots into a single semicolon delineated value
    * or just one value if they are all the same.
    * @param {Object[]} aSlotUrlParams - example [{p1: 'foo', p2: 'test'}, {p2: 'test'}, {p1: 'bar', p2: 'test'}]
    * @return {Object} - example {p1: 'foo;;bar', p2: 'test'}
    */
    function combineSlotUrlParams(aSlotUrlParams) {
        // if only have params for one slot, return those params
        if (aSlotUrlParams.length === 1) {
            return aSlotUrlParams[0];
        }

        // reduce param values from all slot objects into an array of values in a single object
        var oCombinedSlotUrlParams = aSlotUrlParams.reduce(function(oCombinedParams, oSlotUrlParams, iIndex) {
            Object.keys(oSlotUrlParams).forEach(function(param) {
                if (!oCombinedParams.hasOwnProperty(param)) {
                    oCombinedParams[param] = new Array(aSlotUrlParams.length); // initialize array;
                }
                // insert into the proper element of the array
                oCombinedParams[param].splice(iIndex, 1, oSlotUrlParams[param]);
            });

            return oCombinedParams;
        }, {});

        // convert arrays into semicolon delimited strings
        var re = new RegExp('^([^;]*)(;\\1)+$'); // regex to test for duplication

        Object.keys(oCombinedSlotUrlParams).forEach(function(param) {
            var sValues = oCombinedSlotUrlParams[param].join(';');
            // consolidate param values into one value if they are all the same
            var match = sValues.match(re);
            oCombinedSlotUrlParams[param] = match ? match[1] : sValues;
        });

        return oCombinedSlotUrlParams;
    }


    function getOrderedParams(params) {
        var containsTgV = /^tg_v/
        var containsTgI = /^tg_i/

        var orderedParams = [
            'account_id',
            'site_id',
            'zone_id',
            'size_id',
            'alt_size_ids',
            'p_pos',
            'gdpr',
            'gdpr_consent',
            'rf',
            'dt.id',
            'dt.keyv',
            'dt.pref',
            'p_geo.latitude',
            'p_geo.longitude',
            'kw'
        ].concat(Object.keys(params).filter(function(item) { return containsTgV.test(item) }))
        .concat(Object.keys(params).filter(function(item) { return containsTgI.test(item) }))
        .concat([
            'tk_flint',
            'x_source.tid',
            'p_screen_res',
            'rp_floor',
            'rp_secure',
            'tk_user_key'
        ]);

        return orderedParams.concat(Object.keys(params).filter(function(item) { return (orderedParams.indexOf(item) === -1) }));
    }

    function masSizeOrdering(sizes) {
        var MAS_SIZE_PRIORITY = [15, 2, 9];

        return sizes.sort(function(first, second) {
            // sort by MAS_SIZE_PRIORITY priority order
            var firstPriority = MAS_SIZE_PRIORITY.indexOf(first);
            var secondPriority = MAS_SIZE_PRIORITY.indexOf(second);

            if (firstPriority > -1 || secondPriority > -1) {
                if (firstPriority === -1) {
                    return 1;
                }
                if (secondPriority === -1) {
                    return -1;
                }
                return firstPriority - secondPriority;
            }

            // and finally ascending order
            return first - second;
        });
    }

	gdprConsent.ready(function() {
		var params = '';

		// GDPR Consent
		if (gdprConsent.cmpPresent) {
			if (typeof gdprConsent.gdprApplies === 'boolean') {
				params += '?gdpr='+Number(gdprConsent.gdprApplies)+'&gdpr_consent='+gdprConsent.consentString;
			} else {
				params += '?gdpr_consent='+gdprConsent.consentString;
			}
		}

		userSyncs.add({
			type: 'iframe',
			url: SYNC_ENDPOINT + params
		});
    });

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();
bidAdapters.aol = (function() {
	var bidderInfo = {
		rev_share   : 0.85,
		bid_grouping: 'slot',
        default_bid_ttl: 60000
	};

	var bidder = 'aol';

	function formatRequest(slot, tag_id, size, bid) {
		var aol_floor = get_floor(bidder, slot, size);

		bid.requests[size] = {
			'size'        : size,
			'tag_id'      : tag_id,
			'price_floor' : aol_floor
		};

		return bid;
	}

	function send(bid_level_obj, bid_level, requestData) {
        // AOL can only send per slot
        if (bid_level != 'slot') {
            return;
        }

        // dont send aol for isolated pages on dailydot
        if (bid_level_obj.page.isolated == 1 && ops.site_name == "dailydot") {
            return false;
        }

        var page = bid_level_obj.page;
        var slot = bid_level_obj;

        Object.keys(requestData).forEach(function(x) {
            send_slot(requestData[x]);
        });

        function send_slot(requestData) {

			var tag_id = requestData['tag_id'],
				size   = requestData['size'];

			var size_map = {
				"728x90" : 225,
				"160x600": 154,
				"300x600": 529,
				"300x250": 170,
				"320x50" : 3055
			};

			if(typeof size_map[size] == 'undefined') return;

			var price_floor = get_floor(bidder, slot, size),
			    size_id     = size_map[size],
				alias       = slot.name + "@" + size,
				misc        = new Date().getTime();

			// Build Request URL
			var request_url = page.protocol+"//adserver-us.adtech.advertising.com/pubapi/3.0/9857.1/"+tag_id+"/0/"+size_id+"/ADTECH;v=2;cmd=bid;cors=yes;alias="+alias+";misc="+misc+";bidfloor="+price_floor;

			// GDPR Consent
			if (gdprConsent.cmpPresent) {
                if (typeof gdprConsent.gdprApplies === 'boolean') {
                    request_url += ";gdpr=" + Number(gdprConsent.gdprApplies);
                }
				if (gdprConsent.consentString) {
					request_url += ";euconsent=" + gdprConsent.consentString;
				}
            }

			page.log.mylog(request_url, bidder);

			// log requests
			page.requests_sent += 1;
			slot.bids_sent     += 1;
			slot.bids.aol.sent += 1;

			var bid_sent_ts = getTimestampMs();

			//send request
			$.ajax({
				url: request_url,
				special: "aol",
				requestType: "cors",
				success: function(resp){

					try {
						//logging
						page.log.mylog(resp, bidder);

						// Parse JSON
						resp = ProperMedia.utils.safeJsonParse(resp) || {};

						//handle response
						if(resp && resp.seatbid && resp.seatbid.length > 0) {

							var bids_received_ts = getTimestampMs();
							var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

							var obj = resp.seatbid[0]['bid'][0] || {};

							if(Object.keys(obj).length > 0) {

								//store identifiers to identifiy buyer/creative
								var ad_details = {};
								if(typeof obj.crid !== "undefined") ad_details = obj.crid;

								var width  = obj['w']     || 1,
									height = obj['h']     || 1,
									price  = obj['price'] || 0,
									adcode = obj['adm']   || '';

								//log bid
								slot.logBidResponse(bidder, width+"x"+height, price, adcode, tag_id, request_url, resp, ad_details, bid_response_ms, price_floor);
								page.log.log_bid(bidder, slot, width+"x"+height, price);

							}

						}

						//log request as received regardless
						slot.incrementBidResponseCount(bidder,1);

            			addUserSyncs(resp);

					} catch (e) {
						e.bidder = bidder;
						throw e;
					}

				},
				error: function(resp) {
					try {
						//log request as received regardless
						slot.incrementBidResponseCount(bidder,1);

					} catch (e) {
						e.bidder = bidder;
						throw e;
					}
				}
			});
		}
	}

	var EXTRACT_ITEMS = /(img|iframe)[\s\S]*?src\s*=\s*("|')(.*?)\2/gi,
		EXTRACT_TAG_NAME = /\w*(?=\s)/,
		EXTRACT_TAG_SRC = /src=("|')(.*?)\1/;
	function addUserSyncs(resp) {
		if (resp && resp.ext && resp.ext.pixels) {
			var items = resp.ext.pixels.match(EXTRACT_ITEMS);
			if (items) {
				var syncs = [];
				items.forEach(function(item) {
					var tagName = item.match(EXTRACT_TAG_NAME)[0];
					var tagSrc = item.match(EXTRACT_TAG_SRC)[2];

					if (tagName && tagSrc) {
						syncs.push({
							type: (tagName === 'img' ? 'image' : 'iframe'),
							url: tagSrc
						});
					}
				});
				userSyncs.add(syncs);
			}
		}
	}

	return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();
bidAdapters.appnexus = (function() {
	var bidderInfo = {
		rev_share       : 1,
		bid_grouping    : 'page',
        default_bid_ttl : 300000,
        refresh_interval: 60000
	};

	var ENDPOINT_URL = "//ib.adnxs.com/ut/v3/prebid";

	function formatRequest(slot, tag_id, size, bid) {

		if(typeof bid.requests[tag_id] == 'undefined') {
            bid.requests[tag_id] = {
                'tag_id'   : tag_id,
                'slot_name': slot.name,
                'sizes'    : []
            }
        }

        // Add converted size
        var s = size.split('x');
        bid.requests[tag_id]['sizes'].push({
        	'width' : parseInt(s[0]),
        	'height': parseInt(s[1]),
        });

		return bid;
	}

	function send(bid_level_obj, bid_level, requestData, bidder) {

		var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
		var slot = (bid_level == 'slot') ? bid_level_obj : {};

	    //build tags
	    var astTags     = [];
	    var astSlots    = {};
	    var request_cnt = { 'total': 0 };

    	Object.keys(requestData).forEach(function(tagId) {

    		var obj = requestData[tagId];

	    	if(bid_level == 'page') slot = ProperMedia.utils.getSlotFromPageObject(page, obj['slot_name']);

			var sizes = obj['sizes'];
			var astFloor = 0;
			
			if(slot.type == 'display') {
				for(var i = 0; i < obj['sizes'].length; i++) {
					//get floor
					var size  = sizes[i]['width'] + 'x' + sizes[i]['height'];
					var floor = get_floor(bidder, slot, size);
					if(floor < astFloor || astFloor == 0) {
						astFloor = floor;
					}
				}
			}

			//parse sizes
			var primary_size = obj['sizes'][0];

			var position = {
				'atf': 1,
				'btf': 2
			}[slot.position] || 0;

			//build unique identifier
			var uuid = astUID();

			//save info
			astSlots[uuid] = {
				"slot_name" : slot.name,
				"slot_type" : slot.type,
				"astFloor"  : astFloor
			};

			var bidData = {
				"sizes"               : obj['sizes'],
				"primary_size"        : obj['sizes'][0],
				"uuid"                : uuid,
				"id"                  : parseInt(tagId),
				"position"            : position,
				"use_pmt_rule"        : false,
				"prebid"              : true,
				"disable_psa"         : true,
				"ad_types"            : [],
				"allow_smaller_sizes" : false,
				"video"               : {
		            "skippable":true,
		            "playback_method":[
	               		"auto_play_sound_off"
		            ]
	         	}
			};

			if(slot.type == 'display') {
				bidData['reserve'] = astFloor;
				bidData['ad_types'].push('banner');
			} else if(slot.type == 'video') {
				bidData['ad_types'].push('video');
				if(slot.outstream == 0) {
					bidData["require_asset_url"] = true;
				}
			}

			//build tag
			astTags.push(bidData);

			request_cnt['total'] += sizes.length;
			if(typeof request_cnt[slot_name] == 'undefined') {
				request_cnt[slot_name] = 0;
			}
			request_cnt[slot_name] += sizes.length;

		});

		if(astTags.length == 0) return false;

		//build request
		var request_url = page.protocol+ENDPOINT_URL;
		var data = {
			"tags" : astTags,
			"sdk"  : {
		      "source"  : "pbjs",
		      "version" : "2.3.0"
		   }
		}

		if (gdprConsent.cmpPresent) {
			data.gdpr_consent = {
				consent_string: gdprConsent.consentString,
				consent_required: gdprConsent.gdprApplies
			};
		}

		//logging
		page.log.mylog(request_url,bidder);

		// log requests
		page.requests_sent += request_cnt['total'];
		Object.keys(request_cnt).forEach(function(slot_name) {
			if(slot_name !== 'total') {
				if(typeof page.slots[slot_name] !== 'undefined') {
					page.slots[slot_name].bids_sent += request_cnt[slot_name];
				}
			}
		});
		bid_level_obj.bids[bidder].sent += request_cnt['total'];

		var bid_sent_ts = getTimestampMs();

		//send request
		$.ajax({
			url: request_url,
			requestType: "cors",
			method: "POST",
			data: JSON.stringify(data),
			success: function(resp) {

				//parse resposne
				try {

					//logging
					page.log.mylog(resp, bidder);

					var bids_received_ts = getTimestampMs();
					var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

					var json = ProperMedia.utils.safeJsonParse(resp);

					if(json.hasOwnProperty('tags')) {

						for(var i = 0; i < json.tags.length; i++) {

							var obj = json.tags[i];

							//variables
							var ast         = astSlots[obj.uuid];
							var astFloor    = ast.astFloor
							var cpm         = 0;
							var adcode      = "";
							var tagId       = obj.tag_id;
							var ad_details  = {};

							if(obj.ads && obj.ads[0].cpm) {
								var ad   = obj.ads[0];
								cpm      = ad.cpm;

								var adWidth,
									adHeight;

								if(ast.slot_type == "display") {
									adcode   = ad.rtb.banner.content;
									adWidth  = ad.rtb.banner.width;
									adHeight = ad.rtb.banner.height;
									
									//add tracking pixel
									var tracking_url = ad.rtb.trackers[0].impression_urls[0];
									adcode+='<div style="position:absolute;left:0px;top:0px;visibility:hidden;"><img src="' + encodeURI(tracking_url) + '"></div>';

									//build identifier
									if(typeof ad.creative_id!="undefined") ad_details.creative_id = ad.creative_id;
									if(typeof ad.buyer_member_id!="undefined") ad_details.buyer_member_id = ad.buyer_member_id;

								} else if(ast.slot_type == "video") {
									if(ad.rtb.video.hasOwnProperty("asset_url")) {
										adcode = ad.rtb.video.asset_url;
										ad_details.response_type = 'url';
									} else if(ad.rtb.video.hasOwnProperty("content")) {
										adcode = ad.rtb.video.content;
										ad_details.response_type = 'xml';
									}
									adWidth  = ad.rtb.video.player_width;
									adHeight = ad.rtb.video.player_height;
								}

								// if all slots for page were sent at once
								if(bid_level == 'page') slot = ProperMedia.utils.getSlotFromPageObject(page, ast.slot_name);

								//log bid
								slot.logBidResponse(bidder, adWidth+"x"+adHeight, cpm, adcode, tagId, request_url, obj, ad_details, bid_response_ms, astFloor);
								page.log.log_bid(bidder, slot, adWidth+"x"+adHeight, cpm);
							}

						}
					}

					//log request as received regardless
					if(bid_level == 'page') {
						Object.keys(request_cnt).forEach(function(slot_name) {
							if(slot_name !== 'total') {
								if(typeof page.slots[slot_name] !== 'undefined') {
									page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
								}
							}
						});
					} else if(bid_level == 'slot') {
						slot.incrementBidResponseCount(bidder,request_cnt['total']);
					}

				} catch (e) {
					e.bidder = bidder;
					throw e;
				}

			},
			error: function(resp) {

				try {
					//log request as received regardless
					if(bid_level == 'page') {
						Object.keys(request_cnt).forEach(function(slot_name) {
							if(slot_name !== 'total') {
								if(typeof page.slots[slot_name] !== 'undefined') {
									page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
								}
							}
						});
					} else if(bid_level == 'slot') {
						slot.incrementBidResponseCount(bidder,request_cnt['total']);
					}

				} catch (e) {
					e.bidder = bidder;
					throw e;
				}

			}
		});
	}

	function astUID() {
        var e = (new Date).getTime(),
            t = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(t) {
                var n = (e + 16 * Math.random()) % 16 | 0;
                return e = Math.floor(e / 16), ("x" === t ? n : 3 & n | 8).toString(16)
            });
        t = t.split("-")[4];
        return t;
    }

	userSyncs.add({
		type: 'iframe',
		url: '//acdn.adnxs.com/ib/static/usersync/v3/async_usersync.html'
	});

	return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();
bidAdapters.pubmatic = (function() {
	/*
	  IMPORTANT: when updating this rev_share, you MUST also update
	  the value of 'const REVSHARE'.
	  This value can be found in the pubmatic_stats.php file in the proper-io project:
	  https://github.com/proper-media/proper-io/blob/develop/site/proper_data/advertiser_apis/pubmatic_stats.php
	*/
	var bidderInfo = {
        rev_share   : 0.81,
        bid_grouping: 'page'
	};

    var bidder = 'pubmatic';

    //url endpoint
    var ENDPOINT = '//hbopenbid.pubmatic.com/translator?source=prebid-client';
    var USYNCURL = '//ads.pubmatic.com/AdServer/js/showad.js#PIX&kdntuid=1&p=';

    // Publisher ID
    var pubId = 109126;

    var imp_id = 1;

    // Format Slot Data
    function formatRequest(slot, tag_id, size, bid) {

        var floor = get_floor(bidder, slot, size) || slot.backup_floor;

    	bid.requests[imp_id] = {
            'slot_name' : slot.name,
            'tag_id'    : tag_id,
            'floor'     : floor,
            'size'      : size
        };
        imp_id++;

    	return bid;
    }

    function send(bid_level_obj, bid_level, requestData) {

        var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
        var slot = (bid_level == 'slot') ? bid_level_obj : {};

        var request_cnt = { 'total' : 0 };

        var payload = {
            'id': '' + new Date().getTime(),
            'at': 1,
            'cur': ['USD'],
            'imp': [],
            'site': {
                'page': page.url,
                'domain': page.domain,
                'ref': page.referrer,
                'publisher': {
                    'id' : pubId.toString()
                }
            },
            'device': {
                'ua': navigator.userAgent,
                'js': 1,
                'h' : parseInt(page.height),
                'w' : parseInt(page.width),
                'dnt': (navigator.doNotTrack == 'yes' || navigator.doNotTrack == '1' || navigator.msDoNotTrack == '1') ? 1 : 0,
                'language': navigator.language,
                "geo": {}
            },
            'user': {
                "geo": {}
            },
            'ext': {
                'wrapper': {
                    'wp': 'pbjs',
                    'wv': "prebid_prebid_1.24.1",
                    'transactionId': generateUUID()
                }
            }
        };

		if (gdprConsent.cmpPresent) {
			payload.user.ext = {
				consent: (gdprConsent.consentString || '')
			}

			payload.regs = {
				ext: {
					gdpr: (gdprConsent.gdprApplies ? 1 : 0)
				}
			}
		}

        var imps = [];
        for(var impid in requestData) {
            var bidData = requestData[impid];

            var s = bidData['size'].split("x");

            var imp = {
                'id': impid.toString(),
                'tagid' : bidData['slot_name'],
                'bidfloor' : bidData['floor'],
                'bidfloorcur' : 'USD',
                'secure' : page.use_ssl ? 1 : 0,
                'banner' : {
                    'pos': 0,
                    'w' : parseInt(s[0]),
                    'h' : parseInt(s[1]),
                    'topframe' : (typeof dfp_per_slot !== "undefined" && dfp_per_slot == 1) ? 0 : 1
                },
                'ext': {}
            };

            payload.imp.push(imp);

            request_cnt['total']++;
            request_cnt[bidData['slot_name']] = (request_cnt[bidData['slot_name']] || 0) + 1;
        }

        if(payload.imp.length == 0) {
            return;
        }

        var request_url = page.protocol+ENDPOINT;

    	//logging
    	page.log.mylog(request_url, bidder);

    	// log requests
        page.requests_sent += request_cnt['total'];
        if(bid_level == 'page') {
            for(var key in requestData) {
                var slot_name = requestData[key].slot_name;
                if(typeof page.slots[slot_name] !== 'undefined') {
                    page.slots[slot_name].bids_sent += request_cnt[slot_name];
                }
            }
        } else if(bid_level == 'slot') {
            slot.bids_sent += request_cnt['total'];
        }
        bid_level_obj.bids.pubmatic.sent += request_cnt['total'];

    	var bid_sent_ts = getTimestampMs();

    	//send request
    	$.ajax({
            method: "POST",
    		url: request_url,
    		requestType: "cors",
            data: JSON.stringify(payload),
    		success: function(resp) {

                try {

                    resp = ProperMedia.utils.safeJsonParse(resp);

                    var bids_received_ts = getTimestampMs();
                    var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

        			//check result
        			if(resp && resp.seatbid && resp.seatbid.length > 0) {

                        for (key in resp.seatbid) {
                            for (key2 in resp.seatbid[key].bid) {

                                var bid = resp.seatbid[key].bid[key2];

                                var requestId  = bid.impid,
                                    cpm        = (parseFloat(bid.price) || 0).toFixed(2),
                                    width      = bid.w,
                                    height     = bid.h,
                                    creativeId = bid.crid || bid.id,
                                    adcode     = bid.adm;

                                if(typeof requestData[requestId] !== 'undefined') {
                                    var slotObj = page.slots[requestData[requestId]['slot_name']];

                                    //log bid
                                    slotObj.logBidResponse(bidder, width+"x"+height, cpm, adcode, requestId, request_url, resp, {}, bid_response_ms, requestData[requestId]['floor']);
                                    page.log.log_bid(bidder, slotObj, width+"x"+height, cpm);
                                }
                            }
                        }
        			}

                    //log request as received regardless
                    if(bid_level == 'page') {
                        for(var key in requestData) {
                            var slot_name = requestData[key].slot_name;
                            if(typeof page.slots[slot_name] !== 'undefined') {
                                page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
                            }
                        }
                    } else if(bid_level == 'slot') {
                        slot.incrementBidResponseCount(bidder,request_cnt['total']);
                    }

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }

    		},
    		error: function(resp) {
                try {
        			//log request as received regardless
                    if(bid_level == 'page') {
                        for(var key in requestData) {
                            var slot_name = requestData[key].slot_name;
                            if(typeof page.slots[slot_name] !== 'undefined') {
                                page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
                            }
                        }
                    } else if(bid_level == 'slot') {
                        slot.incrementBidResponseCount(bidder,request_cnt['total']);
                    }

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
    		}
    	});
    }

	gdprConsent.ready(function() {
		var syncurl = USYNCURL + pubId;

		// GDPR Consent
		if (gdprConsent.cmpPresent) {
			syncurl += '&gdpr=' + (gdprConsent.gdprApplies ? 1 : 0);
			syncurl += '&gdpr_consent=' + encodeURIComponent(gdprConsent.consentString || '');
		}

		userSyncs.add({ type: 'iframe', url: syncurl });
	});

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();
bidAdapters.index = (function() {
	var bidderInfo = {
        rev_share   : 1,
        bid_grouping: 'page',
        dont_refresh: 1,
        default_bid_ttl: 60000
	};

    /*
    bid.requests = {
        data : [{
            id : {id},
            width : 728,
            height : 90,
            siteID: {siteID},
            bidfloorcur : 'USD',
            bidfloor : {index_floor}
        }, ... ],
        index_slots : {
            {id} : {
                width: 728,
                height: 90,
                tag_id, {tag_id},
                slot_name : {slot_name_1},
                slot_number : {slot_number},
                index_floor : {index_floor}
            },
            ...
        },
        slot_requests : {
            {slot_name_1} : {request_count},
        }
    }
    */
    function formatRequest(slot, tag_id, size, bid) {

    	var p = tag_id.split("-");
    	var s = size.split("x");
    	var id = tag_id.replace('-','_');

    	var index_floor = get_floor('index', slot, size);

    	if(typeof bid.requests.data == 'undefined') bid.requests.data = [];
    	if(typeof bid.requests.index_slots == 'undefined') bid.requests.index_slots = {};
    	if(typeof bid.requests.slot_requests == 'undefined') bid.requests.slot_requests = {};
    	if(typeof bid.requests.slot_requests[slot.name] == 'undefined') bid.requests.slot_requests[slot.name] = 0;

    	bid.requests.data.push( {"id":id, "width":parseInt(s[0]), "height":parseInt(s[1]), "siteID":parseInt(p[0]), "bidfloorcur":"USD", "bidfloor":index_floor } );
		bid.requests.index_slots[id] = { 'width':parseInt(s[0]), 'height':parseInt(s[1]), "tag_id":tag_id, "slot_name": slot.name, "slot_number":slot.number, "index_floor":index_floor }
		bid.requests.slot_requests[slot.name]++;

    	return bid;
    }

    function send(bid_level_obj, bid_level, requestData, bidder) {

    	var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
    	var slot = (bid_level == 'slot') ? bid_level_obj : {};

        if(requestData.data.length == 0) return false;

    	var request_cnt = requestData.data.length;

    	// Set site id. Default to PROPER id
    	var site_id = (ops.site_ids.hasOwnProperty('index') && ops.site_ids['index'] !== '') ? ops.site_ids['index'] : 161112;

		var request_url = buildRequestUrl(site_id, requestData.data);

    	//logging
    	page.log.mylog(request_url, "index");

        // log requests
    	page.requests_sent += request_cnt;
    	if(bid_level == 'page') {
    		for(slot_name in requestData.slot_requests) {
    			if(typeof page.slots[slot_name] !== 'undefined')
    				page.slots[slot_name].bids_sent += requestData.slot_requests[slot_name];
    		}
    	} else if(bid_level == 'slot') {
    		slot.bids_sent += requestData.data.length;
    	}
    	bid_level_obj.bids.index.sent += request_cnt;

    	var bid_sent_ts = getTimestampMs();

        $.ajax({
        	url: request_url,
        	special : "index",
        	requestType: "jsonp",
        	success: function(resp) {

                try {
    				//process response
        	        if(!resp || !resp.seatbid || resp.seatbid.length==0 || !resp.seatbid[0].bid) {
        	          page.log.mylog("no index bids found");

        	        } else {

        	        	var bids_received_ts = getTimestampMs();
        				var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

        	        	//logging
        				page.log.mylog(resp,'index');

        	          for(var x in resp.seatbid) {

        	            for(var i in resp.seatbid[x].bid) {

        					//grab variables
        					var seat     = resp.seatbid[x].seat;
        					var obj      = resp.seatbid[x].bid[i];
        					var adid     = obj.adid;
        					var id       = obj.id;
        					var impid    = obj.impid;
        					var adcode   = obj.adm;
        					var ext      = obj.ext;
        					var dspid    = obj.ext.dspid;
        					var price    = obj.ext.pricelevel;
        					var brand    = obj.ext.advbrand;
        					var brand_id = obj.ext.advbrandid;
        					var domain   = obj.adomain[0];

        					//parse price
        					price = price.replace("_","") / 100;

        					//identify ad
        					var ad_details = {};
        					if(typeof obj.crid !="undefined") ad_details.crid = obj.crid;
        					if(typeof obj.adomain !="undefined") ad_details.adomain = obj.adomain[0];
        					if(typeof obj.ext.advbrand !="undefined") ad_details.advbrand = obj.ext.advbrand;
        					if(typeof obj.ext.advbrandid !="undefined") ad_details.advbrandid = obj.ext.advbrandid;

        					//log bid
        					var slot_data = requestData.index_slots[impid];

        					// if all slots for page were sent at once
        					if(bid_level == 'page') slot = page.slots[slot_data.slot_name];

        					slot.logBidResponse('index', slot_data.width+"x"+slot_data.height, parseFloat(price), adcode, slot_data.tag_id, '', obj, ad_details, bid_response_ms, slot_data.index_floor);
        					page.log.log_bid('index', slot, slot_data.width+"x"+slot_data.height, parseFloat(price));

        	            } //end loop
        	          } //end loop
        	        } //end if

        	        //log request as received regardless
        			if(bid_level == 'page') {
        				for(slot_name in requestData.slot_requests) {
        					if(typeof page.slots[slot_name] !== 'undefined')
        						page.slots[slot_name].incrementBidResponseCount('index',requestData.slot_requests[slot_name]);
        				}
        			} else if(bid_level == 'slot') {
        				slot.incrementBidResponseCount('index',requestData.data.length);
        			}

                } catch (e) {
                    e.bidder = 'index';
                    throw e;
                }

    		},
    		error: function(resp) {
                try {
        			//log request as received regardless
        			if(bid_level == 'page') {
        				for(slot_name in requestData.slot_requests) {
        					if(typeof page.slots[slot_name] !== 'undefined')
        						page.slots[slot_name].incrementBidResponseCount('index',requestData.slot_requests[slot_name]);
        				}
        			} else if(bid_level == 'slot') {
        				slot.incrementBidResponseCount('index',requestData.data.length);
        			}

                } catch (e) {
                    e.bidder = 'index';
                    throw e;
                }
    		}
    	});
    }

	function buildRequestUrl(siteID, slots) {
		var jsonURI = encodeURIComponent(JSON.stringify(buildRTBRequest(slots)));
		var scriptSrc = window.location.protocol === 'https:' ? 'https://as-sec.casalemedia.com' : 'http://as.casalemedia.com';

		//special fix: historyinorbit's account requires an old endpoint version
		if(siteID==259845) scriptSrc += '/cygnus?v=7&s=' + siteID + '&r=' + jsonURI;
		else scriptSrc += '/headertag?v=9&s=' + siteID + '&r=' + jsonURI;

		scriptSrc += '&t=300';
		return scriptSrc;
	};

	var requestCounter = Math.floor(Math.random() * 256);

	function buildRTBRequest(slots) {

		var sitePage = location.href;
		var topframe = 1;

		if (top !== self) {
			sitePage = document.referrer;
			topframe = 0;
		}

		var requestID = String(
			(new Date().getTime() % 2592000) * 256 +
			(requestCounter = (requestCounter + 1) % 256) + 256
		);

		var json = {
			id: requestID,
			site: { page: sitePage },
			imp: []
		};

		if (typeof document.referrer === 'string') {
			json.site.ref = document.referrer;
		}

		for (var i = 0; i < slots.length; i++) {
			var slot = slots[i];

			if (typeof slot.width !== 'number' || slot.width <= 1) {
    			continue;
    		}
    		if (typeof slot.height !== 'number' || slot.height <= 1) {
    			continue;
    		}

			var imp = {
				id: slot.id,
				banner: {
					w: slot.width,
					h: slot.height,
					topframe: topframe
				},
				ext: {}
			};

			if (typeof slot.bidfloor === 'number') {
				imp.bidfloor = slot.bidfloor;
				if (typeof slot.bidfloorcur === 'string') {
					imp.bidfloorcur = slot.bidfloorcur;
				}
			}

			if (typeof slot.id === 'string' || typeof slot.id === 'number') {
				var sid = String(slot.id);
				if (sid.length <= 50 && !sid.match(/^\s*$/)) {
					imp.ext.sid = sid;
				}
			}

			if (typeof slot.siteID !== 'undefined') {
				imp.ext.siteID = slot.siteID;
			}

			json.imp.push(imp);
		}

		return json;
	}

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();
bidAdapters.openx = (function() {
	var bidderInfo = {
        rev_share   : 1,
        bid_grouping: 'page',
        dont_refresh: 1,
        default_bid_ttl: 300000
	};

    var bidder = 'openx';
    var shouldSendBoPixel = true;
    var ENDPOINT_URL = '//propermedia-d.openx.net/w/1.0/arj';

    function formatRequest(slot, tag_id, size, bid) {

        if(typeof bid.requests[tag_id] == 'undefined') {
            bid.requests[tag_id] = {
                'price_floor' : 0,
                'slot_name'   : slot.name,
                'slot_div'    : slot.div_id,
                'tag_id'      : tag_id,
                'sizes'       : []
            };
        }

        var openx_floor = get_floor(bidder, slot, size);
        // Set price floor. Lowest price for possible sizes
        if(openx_floor < bid.requests[tag_id]['price_floor'] || bid.requests[tag_id]['price_floor'] == 0) {
            bid.requests[tag_id]['price_floor'] = openx_floor;
        }

    	bid.requests[tag_id]['sizes'].push(size);

    	return bid;
    }

    function send(bid_level_obj, bid_level, requestData) {

        var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
        var slot = (bid_level == 'slot') ? bid_level_obj : {};

        var isInIframe = (typeof dfp_per_slot !== "undefined" && dfp_per_slot == 1) ? true : false,

        // Default Parameters
    	data = {
            'ju'     : page.url,
            'jr'     : page.referrer,
            'ch'     : document.charSet || document.characterSet,
            'res'    : screen.width+'x'+screen.height+'x'+screen.colorDepth,
            'ifr'    : isInIframe,
            'tz'     : new Date().getTimezoneOffset(),
            'tws'    : getViewportDimensions(isInIframe),
            'aus'    : '',
            'auid'   : '',
            'aumfs'  : '',
            'dddid'  : '',
            'divIds' : '',            
            'be'     : 1,
            'bc'     : 'hb_pb_2.1.6',
            'nocache': new Date().getTime()
        };

        var aus    = [], // slot sizes 
            auid   = [], // tag ids
            aumfs  = [], // price floors
            dddid  = [], // transaction ids
            divIds = []; // div ids

        var request_cnt = {
            'total': 0
        }

        Object.keys(requestData).forEach(function(impid) {
            var obj = requestData[impid];

            aus.push(obj.sizes.join(','));
            auid.push(obj.tag_id);
            aumfs.push(obj.price_floor * 1000);
            dddid.push(generateUUID());
            divIds.push(encodeURIComponent(obj.slot_div));

            request_cnt['total'] += obj.sizes.length;
            if(typeof request_cnt[obj.slot_name] == 'undefined') {
                request_cnt[obj.slot_name] = 0;
            }
            request_cnt[obj.slot_name] += obj.sizes.length;
        });

        data.aus = aus.join('|');
        data.auid = auid.join(',');
        data.aumfs = aumfs.join(',');
        data.dddid = dddid.join(',');
        data.divIds = divIds.join(',');

        // Check Do Not Tack
        if(ProperMedia.utils.getDNT()) {
            data.ns = 1
        }

        // Check GDPR
		if (gdprConsent.cmpPresent) {
			if (gdprConsent.consentString !== undefined) {
                data.gdpr_consent = gdprConsent.consentString;
			}
			if (gdprConsent.gdprApplies !== undefined) {
				data.gdpr = Number(gdprConsent.gdprApplies);
			}
            data.x_gdpr_f = 1;
		}

        // Must encode data
        var y = '', e = encodeURIComponent;
        Object.keys(data).forEach(function(x) {
            if(data[x]) {
                y += '&' + e(x) + '=' + e(data[x]);
            }
        });
        var post_data = y.slice(1);

        // request url
        var request_url = page.protocol + ENDPOINT_URL + '?' + post_data;

    	//logging
    	page.log.mylog(request_url,bidder);

    	// log requests
    	page.requests_sent += request_cnt['total'];
        Object.keys(request_cnt).forEach(function(slot_name) {
            if(slot_name !== 'total') {
                if(typeof page.slots[slot_name] !== 'undefined') {
                    page.slots[slot_name].bids_sent += request_cnt[slot_name];
                }
            }
        });
        bid_level_obj.bids[bidder].sent += request_cnt['total'];

    	var bid_sent_ts = getTimestampMs();
        var startTime = new Date();

    	//send request
    	$.ajax({
    		url: request_url,
    		requestType: "cors",
            cache: true,
            data: data,
    		success: function(resp) {

                try {

        			//logging
        			page.log.mylog(resp,bidder);

					var respObj = ProperMedia.utils.safeJsonParse(resp) || {};
                    if(respObj && typeof respObj == 'object' && respObj.ads && typeof respObj.ads == 'object') {

                        var bids_received_ts = getTimestampMs();
                        var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

                        var ads = respObj.ads.ad || [];
                        if (Array.isArray(ads) && ads.length > 0) {

                            for(var i = 0; i < ads.length; i++) {

                                var adUnit = ads[i] || {};

                                //log bid
                                var creative = adUnit.creative[0] || {},
                                    cpm      = Number(adUnit.pub_rev) / 1000 || 0,
                                    adcode   = adUnit.html     || '',
                                    width    = creative.width  || 1,
                                    height   = creative.height || 1,
                                    tag_id   = adUnit.adunitid || 0,
                                    size     = width + 'x' + height;

                                registerBeacon(adUnit, startTime);

                                if(bid_level == 'page') slot = page.slots[requestData[tag_id]['slot_name']] || {};

                                var price_floor = requestData[tag_id]['price_floor'] || 0;

                                if(slot instanceof slotObj) {
                                    // log bid
                                    slot.logBidResponse(bidder, size, cpm, adcode, tag_id, request_url, respObj, {}, bid_response_ms, price_floor);
                                    page.log.log_bid(bidder, slot, size, cpm);
                                }

                            }
                        }
                        addUserSyncs(respObj);
                    }

        			//log request as received regardless
                    if(bid_level == 'page') {
                        Object.keys(request_cnt).forEach(function(slot_name) {
                            if(slot_name == 'total') return;
                            if(typeof page.slots[slot_name] !== 'undefined')
                                page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
                        });
                    } else if(bid_level == 'slot') {
                        slot.incrementBidResponseCount(bidder,request_cnt['total']);
                    }

                } catch(e) { 
                    e.bidder = bidder;
                    throw e;
                }

    		},
    		error: function(resp) {
                try {
        			//log request as received regardless
                    if(bid_level == 'page') {
                        Object.keys(request_cnt).forEach(function(slot_name) {
                            if(slot_name == 'total') return;
                            if(typeof page.slots[slot_name] !== 'undefined')
                                page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
                        });
                    } else if(bid_level == 'slot') {
                        slot.incrementBidResponseCount(bidder,request_cnt['total']);
                    }

                } catch(e) { 
                    e.bidder = bidder;
                    throw e;
                }
    		}
    	});
    }

    function getViewportDimensions(isIfr) {
        var body,
            width,
            height,
            tWin  = window,
            tDoc  = document,
            docEl = tDoc.documentElement;

        if (isIfr) {
            try {
                tWin = window.top;
                tDoc = window.top.document;
            } catch (e) {
                return;
            }
            docEl = tDoc.documentElement;
            body  = tDoc.body;

            width  = tWin.innerWidth || docEl.clientWidth || body.clientWidth;
            height = tWin.innerHeight || docEl.clientHeight || body.clientHeight;
        } else {
            docEl  = tDoc.documentElement;
            width  = tWin.innerWidth || docEl.clientWidth;
            height = tWin.innerHeight || docEl.clientHeight;
        }

        return width + 'x' + height;
    }

    function buildQueryStringFromParams(params) {
        for (var key in params) {
            if (params.hasOwnProperty(key)) {
                if (!params[key]) {
                    delete params[key];
                }
            }
        }
        return Object.keys(params).map(function(key) { return key + '=' + params[key]; } ).join('&');
    }

    function registerBeacon(adUnit, startTime) {
        // only register beacon once
        if (!shouldSendBoPixel) {
            return;
        }
        shouldSendBoPixel = false;

        var bt = 3000;
        var beaconUrl;

        var beaconParams = {
            bd: +(new Date()) - startTime,
            bp: adUnit.pub_rev,
            br: '0', // may be 0, t, or p
            bs: getPageDomain(),
            bt: bt,
            ts: adUnit.ts
        };

        beaconParams.br = beaconParams.bt < beaconParams.bd ? 't' : 'p';

        var recordPixel = (adUnit && adUnit.creative && adUnit.creative[0] && adUnit.creative[0].tracking && adUnit.creative[0].tracking.impression) || '';
        var boBase = recordPixel.match(/([^?]+\/)ri\?/);

        if (boBase && boBase.length > 1) {
            beaconUrl = boBase[1] + 'bo?' + buildQueryStringFromParams(beaconParams);
        }

        if (beaconUrl) {
            userSyncs.add({ type: 'image', url: beaconUrl });
        }
    }

	function addUserSyncs(resp) {
		var url = '//u.openx.net/w/1.0/pd';
		if (resp) {
			if (resp.ads && resp.ads.pixels) {
				url = resp.ads.pixels;
			} else if (resp.pixels) {
				url = resp.pixels;
			}
		}
		userSyncs.add({ type: 'iframe', url: url });
	}

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();
bidAdapters.a9 = (function() {
    var bidderInfo = {
        rev_share   : 1,
        bid_grouping: 'page'
    };
    var amazon_ready = 0;
    var amazon_loading = 0;

    /*
    bid.requests = {
        {slot_name_1} : {
            slotID : {slot_name_1},
            sizes : [[728,90], [970,250], ...]
        }, 
        ...
    }
    */
    function formatRequest(slot, tag_id, size, bid) {
        if(typeof bid.requests[slot.name] == 'undefined') bid.requests[slot.name] = { 'slotID': slot.name, 'sizes': [] };

        bid.requests[slot.name].sizes.push(size.split("x").map(function(s) { return parseInt(s); }));
        return bid;
    }

    // Send a9 Ad Request For Slots
    function send(bid_level_obj, bid_level, requestData) {

        //determine page/slot objects
        var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
        var slot = (bid_level == 'slot') ? bid_level_obj : {};

        // Don't send amazon if page is isolated and amazon price map isn't included
        if(page.isolated == 1 && typeof special_ops.amzn_price_map == 'undefined' && ops.testing_mode == 0) return;

        //load or queue request
        if (amazon_ready==1) { //good to go, request ads
            a9Payload(requestData);
        } else {

            //queue request
            if(typeof page.amazon_queue == "undefined") page.amazon_queue = {};
            for (var id in requestData) { page.amazon_queue[id] = requestData[id]; }

            //load library if not loaded
            if(amazon_loading==0) loadA9();
        }

        function loadA9() {
            amazon_loading = 1;
            !function(a9,a,p,s,t,A,g) {

                if( a[a9] ) return;

                function q(c,r) {
                    a[a9]._Q.push([c,r])
                }

                a[a9] = {
                    init: function() {
                        q("i", arguments)
                    },
                    fetchBids: function() {
                        q("f", arguments)
                    },
                    _Q: []
                };

                var r = false;
                A = p.createElement(s);
                A.async = 1;
                A.src = t;
                A.addEventListener('load', TraceKit.wrap(function() {
                    try {
                        window.apstag.init({ pubID: "cb3b5777-430d-4622-b7fc-358cfa27d518" });
                        amazon_ready = 1;

                        //loop through each page and send queue if exists
                        for (var pg_number in pages) {
                            if(typeof pages[pg_number].amazon_queue != "undefined") a9Payload(pages[pg_number].amazon_queue);
                        }
                    } catch(e) {
                        e.bidder = 'a9';
                        throw e;
                    }

                }));
                g = p.getElementsByTagName(s)[0];
                g.parentNode.insertBefore(A,g)

            } ("apstag", window, document, "script", "//c.amazon-adsystem.com/aax2/apstag.js");
        }

        function a9Payload(data) {

            // check debug mode
            if(typeof window.apstag.debug == 'function') {
                if(ops.testing_mode == 1) {
                    window.apstag.debug('enable');
                } else {
                    window.apstag.debug('disable');
                }
            }

            var request_cnt = 0;
            var slots = [];
            for(slot_name in data) {
                if(data[slot_name].sizes.length > 0) {
                    slots.push(data[slot_name]);
                    request_cnt += data[slot_name].sizes.length;
                }
            }

            if(slots.length == 0) return false;

            //logging
            page.log.mylog("amazon bids sent",'a9');

            // log requests
            page.requests_sent += request_cnt;
            if(bid_level == 'page') {
                for(slot_name in data) {
                    if(typeof page.slots[slot_name] !== 'undefined') {
                        page.slots[slot_name].bids_sent += data[slot_name].sizes.length;
                    }
                }
            } else if(bid_level == 'slot') {
                slot.bids_sent += request_cnt;
            }
            bid_level_obj.bids.a9.sent += request_cnt;

            var bid_sent_ts = getTimestampMs();

            var astcallback = function(bids) {
                try {
                    //log bids
                    page.log.mylog('amazon bids returned: '+bids.length);

                    var bids_received_ts = getTimestampMs();
                    var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

                    for(key in bids) {
                        var bid = bids[key];

                        if(page.slots[bid.slotID] !== 'undefined') {
                            var slot = page.slots[bid.slotID];

                            if(typeof slot.bids.a9 == "undefined") {
                                slot.bids.a9 = new bidObj();
                                slot.bids.a9.bidder = "a9";
                            }

                            // DFP Disabled
                            if(page.isolated == 1 || (slot.adPool instanceof adPoolObj && typeof special_ops.amzn_price_map !== 'undefined' && typeof special_ops.amzn_price_map[bid.amznbid] !== 'undefined')) {
                                //log bid
                                var request_url = 'http://aax.amazon-adsystem.com/e/dtb/bid';
                                if(ops.testing_mode == 1) {
                                    var price = 100;
                                } else {
                                    var price = (typeof special_ops.amzn_price_map !== 'undefined' && typeof special_ops.amzn_price_map[bid.amznbid] !== 'undefined') ? special_ops.amzn_price_map[bid.amznbid] : 0;
                                }

                                var adcode = '<script>var amzn_win=window,amzn_c=5,amzn_x=0;while(amzn_x<amzn_c){amzn_win=amzn_win.parent;if(amzn_win.apstag)try{amzn_win.apstag.renderImp(document,"'+bid.amzniid+'");amzn_x=amzn_c}catch(e){}amzn_x++};</script>';

                                slot.logBidResponse('a9', bid.size, price, adcode, bid.slotID, request_url, bid, {}, bid_response_ms, 0);
                                page.log.log_bid('a9', slot, bid.size, price);

                            } else if(Object.keys(bid).length > 0) {
                                slot.bids.a9.responses = bid;
                            }
                        }
                    }

                    //save bids
                    if(typeof page.bids.a9 == "undefined") {
                        page.bids.a9 = new bidObj();
                        page.bids.a9.bidder = "a9";
                    }
                    page.bids.a9.responses = bids;

                    //log request as received
                    for(slot_name in data) {
                        if(typeof page.slots[slot_name] !== 'undefined')
                            page.slots[slot_name].incrementBidResponseCount('a9',data[slot_name].sizes.length);
                    }
                } catch(e) {
                    e.bidder = 'a9';
                    throw e;
                }
            };

            // Wrap function with TraceKit
            if(typeof TraceKit !== 'undefined') {
                TraceKit.wrap(astcallback)
            }

            window.apstag.fetchBids({
                slots: slots,
                timeout: 2e3,
            }, astcallback);
        }
    }

    return {
        formatRequest: formatRequest,
        send: send,
        bidderInfo: bidderInfo
    };
})();
bidAdapters.sharethrough = (function() {
	var bidderInfo = {
        rev_share   : 1,
        bid_grouping: 'slot',
        default_bid_ttl: 360000
	};

    var bidder = 'sharethrough';
    var ENDPOINT_URL = '//btlr.sharethrough.com/header-bid/v1';

    function formatRequest(slot, tag_id, size, bid) {

        if(typeof bid.requests[tag_id] == 'undefined') {
            bid.requests[tag_id] = {
                'slot_name': slot.name,
                'tag_id'   : tag_id,
                'pkey'     : tag_id,
                'sizes'    : [],
            }
        }

        // Add converted rubicon size 
        bid.requests[tag_id]['sizes'].push(size);

    	return bid;
    }

    function send(bid_level_obj, bid_level, requestData) {

    	var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
    	var slot = (bid_level == 'slot') ? bid_level_obj : {};

        // request count
        Object.keys(requestData).forEach(function(tag_id) {
            send_slot(requestData[tag_id]);
        });

        function send_slot(request_data) {

            var pkey  = request_data['pkey'];
            var bidId = request_data['slot_name'];

            var data = {
                'placement_key'       : pkey,
                'bidId'               : bidId,
                'consent_required'    : false,
                'instant_play_capable': canAutoPlayHTML5Video(),
                'hbSource'            : 'prebid',
                'hbVersion'           : '2.3.0',
                'strVersion'          : '3.0.1'
            };

            if (gdprConsent.cmpPresent) {
                if (gdprConsent.consentString) {
                    data.consent_string = gdprConsent.consentString;
                }
                data.consent_required = !!gdprConsent.gdprApplies;
            }        

            // Must encode data
            var y = '', e = encodeURIComponent;
            Object.keys(data).forEach(function(key) {
                y += '&' + e(key) + '=' + e(data[key]);
            });
            query = y.slice(1);

            // build request url
            var request_url = page.protocol+ENDPOINT_URL+'?'+query;

            //logging
            page.log.mylog(request_url,bidder);

             // log requests
            page.requests_sent += 1;
            if(bid_level == 'page') {
                for(i in requestData) {
                    slot_name = requestData[i].slot_name;
                    if(typeof page.slots[slot_name] !== 'undefined')
                        page.slots[slot_name].bids_sent += 1;
                }
            } else if(bid_level == 'slot') {
                slot.bids_sent += 1;
            }
            bid_level_obj.bids[bidder].sent += 1;

            var bid_sent_ts = getTimestampMs();

        	//send request
        	$.ajax({
        		url: request_url,
                method: "GET",
        		requestType: "cors",
        		success: function(json) {

    				try {

    					//logging
        				page.log.mylog(json,bidder);

    					var resp = ProperMedia.utils.safeJsonParse(json);

        				//handle response
        				if(resp && resp.creatives.length > 0) {

        					var bids_received_ts = getTimestampMs();
        					var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

        					var creative = resp.creatives[0];

        					var bidId  = resp.bidId || '';
        					var cpm    = creative.cpm || 0;
        					var size   = "1x1";

        					var windowLocation = 'str_response_'+bidId;
        					var bidJsonString = ProperMedia.utils.b64EncodeUnicode(JSON.stringify(resp));

        					var adcode = '<div data-str-native-key="'+pkey+'" data-stx-response-name="'+windowLocation+'"></div>';
                        		adcode += '<script>var '+windowLocation+' = "'+bidJsonString+'"</script>';
                                // Don't break out of iframe
                                adcode += '<script src="//native.sharethrough.com/assets/sfp.js"></script>';

        					//figure out what slot we got back
        					if(typeof page.slots[bidId] !== 'undefined') {
        						slot = page.slots[bidId];

        						//identify ad
        						var ad_details = {};

        						//log bid
        						slot.logBidResponse(bidder, size, cpm, adcode, pkey, request_url, resp, ad_details, bid_response_ms, 0);
        						page.log.log_bid(bidder, slot, size, cpm);
        					}
        				}

                        // user syncs
                        addUserSyncs(resp);

            			//log request as received regardless
                        if(bid_level == 'page') {
                            Object.keys(requestData).forEach(function(i) {
                                slot_name = requestData[i].slot_name
                                if(typeof page.slots[slot_name] !== 'undefined')
                                    page.slots[slot_name].incrementBidResponseCount(bidder,1);
                            });
                        } else if(bid_level == 'slot') {
                            slot.incrementBidResponseCount(bidder,1);
                        }

                    } catch(e) { 
                        e.bidder = bidder;
                        throw e;
                    }

        		},
        		error: function(resp) {
                    try { 
            			//log request as received regardless
            			if(bid_level == 'page') {
                            Object.keys(requestData).forEach(function(i) {
            					slot_name = requestData[i].slot_name
            					if(typeof page.slots[slot_name] !== 'undefined')
            						page.slots[slot_name].incrementBidResponseCount(bidder,1);
            				});
            			} else if(bid_level == 'slot') {
            				slot.incrementBidResponseCount(bidder,1);
            			}

                    } catch(e) { 
                        e.bidder = bidder;
                        throw e;
                    }
        		}
        	});
        }
    }


    function canAutoPlayHTML5Video() {
        var userAgent = navigator.userAgent;
        if (!userAgent) return false;

        var isAndroid = /Android/i.test(userAgent);
        var isiOS = /iPhone|iPad|iPod/i.test(userAgent);
        var chromeVersion = parseInt((/Chrome\/([0-9]+)/.exec(userAgent) || [0, 0])[1]);
        var chromeiOSVersion = parseInt((/CriOS\/([0-9]+)/.exec(userAgent) || [0, 0])[1]);
        var safariVersion = parseInt((/Version\/([0-9]+)/.exec(userAgent) || [0, 0])[1]);

        if (
            (isAndroid && chromeVersion >= 53) ||
            (isiOS && (safariVersion >= 10 || chromeiOSVersion >= 53)) ||
            !(isAndroid || isiOS)
        ) {
            return true;
        } else {
            return false;
        }
    }

	function addUserSyncs(resp) {
		if (resp && resp.cookieSyncUrls) {
			var syncs = resp.cookieSyncUrls.map(function(url) {
				return { type: 'image', url: url };
			});
			userSyncs.add(syncs);
		}
	}

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();
bidAdapters.mantis = (function() {
    var bidderInfo = {
        rev_share   : 1,
        bid_grouping: 'page',
        default_bid_ttl: 1800000
    };

    var bidder = 'mantis';
    var SITE_ID = '5b32cf14d866814de2efe8c2';
    // Mantis requires https. http requests are redirected, breaking CORS support.
    var ENDPOINT_URL = 'https://mantodea.mantisadnetwork.com';

    function formatRequest(slot, tag_id, size, bid) {

        var key = (tag_id == 1) ? slot.name : tag_id;

        if(typeof bid.requests[key] == 'undefined') {
            bid.requests[key] = {
                "slot_name": slot.name,
                "sizes": []
            };
        }

        var s = size.split("x");
        bid.requests[key]["sizes"].push(
            {
                "width"  : parseInt(s[0]),
                "height" : parseInt(s[1])
            }
        );

        return bid;
    }

    function send(bid_level_obj, bid_level, requestData) {

    	var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
    	var slot = (bid_level == 'slot') ? bid_level_obj : {};

    	//build script url
    	if(ops.testing_mode == 1) {
    		var site_id = 'demo';
    	} else {
            var site_id = (typeof ops.site_ids[bidder] != "undefined") ? ops.site_ids[bidder] : SITE_ID;
    	}

    	var json = {
            "measurable": true,
    		"property"  : site_id,
    		"bids"      : []
    	}

    	var request_cnt = {
            'total': 0
        };
    	for(bidId in requestData)  {
    		var sizes = requestData[bidId]['sizes'];
            if(sizes.length > 0) {
        		var bid = {
        			"bidId" : bidId,
        			"sizes" : sizes
        		};
        		json.bids.push(bid);
        		request_cnt['total'] += sizes.length;
                if(typeof request_cnt[slot_name] == 'undefined') {
                    request_cnt[slot_name] = 0;
                }
                request_cnt[slot_name] += sizes.length;
            }
        }

        if(request_cnt['total'] == 0) return;

        var request_url = buildMantisUrl('/prebid/display', json) + '&foo';

    	//logging
    	page.log.mylog(request_url,bidder);

    	// log requests
        page.requests_sent += request_cnt['total'];
        Object.keys(request_cnt).forEach(function(slot_name) {
            if(slot_name !== 'total') {
                if(typeof page.slots[slot_name] !== 'undefined') {
                    page.slots[slot_name].bids_sent += request_cnt[slot_name];
                }
            }
        });
        bid_level_obj.bids[bidder].sent += request_cnt['total'];

    	var bid_sent_ts = getTimestampMs();

    	//send request
    	$.ajax({
    		url: request_url,
    		requestType: "cors",
    		success: function(resp) {

                try {

        			//logging
        			page.log.mylog(resp,bidder);

                    // Parse response
                    resp = ProperMedia.utils.safeJsonParse(resp);

    				//handle response
    				if(resp) {

    					var bids_received_ts = getTimestampMs();
    					var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

                        // Store unique user id
                        if(typeof resp['uuid'] !== 'undefined') {
                            storeUuid(resp['uuid']);
                        }

    					//process data
    					if(typeof resp['ads'] !== 'undefined') {

                            for (var i = 0; i < resp['ads'].length; i++) {

    							var obj = resp['ads'][i];

    							//we got one!
    							var tagid      = obj.bid;
    							var cpm        = obj.cpm;
    							var width      = obj.width;
    							var height     = obj.height;
    							var adcode     = obj.html;
    							var size       = width+"x"+height;

    							//figure out what slot we got back
    							if(typeof requestData[tagid] !== 'undefined') {
    								slot_name = requestData[tagid]['slot_name'];
    								slot = page.slots[slot_name];

    								//identify ad
    								var ad_details = {};

    								//log bid
    								slot.logBidResponse(bidder, size, cpm, adcode, tagid, request_url, resp, ad_details, bid_response_ms, 0);
    								page.log.log_bid(bidder, slot, size, cpm);
    							}
        					}
                        }
    				}

        			//log request as received regardless
                    if(bid_level == 'page') {
                        Object.keys(request_cnt).forEach(function(slot_name) {
                            if(slot_name !== 'total') {
                                if(typeof page.slots[slot_name] !== 'undefined') {
                                    page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
                                }
                            }
                        });
                    } else if(bid_level == 'slot') {
                        slot.incrementBidResponseCount(bidder,request_cnt['total']);
                    }
                } catch(e) {
                    e.bidder = bidder;
                    throw e;
                }

    		},
    		error: function(resp) {
                try {
                    //log request as received regardless
                    if(bid_level == 'page') {
                        Object.keys(request_cnt).forEach(function(slot_name) {
                            if(slot_name !== 'total') {
                                if(typeof page.slots[slot_name] !== 'undefined') {
                                    page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
                                }
                            }
                        });
                    } else if(bid_level == 'slot') {
                        slot.incrementBidResponseCount(bidder,request_cnt['total']);
                    }
                } catch(e) {
                    e.bidder = bidder;
                    throw e;
                }
    		}
    	});
    }

    function buildMantisUrl(path, data, domain) {
        var params = {
            'referrer': document.referrer,
            'tz'      : new Date().getTimezoneOffset(),
            'buster'  : new Date().getTime(),
            'secure'  : isSecure(),
            'version' : 9
        };
        
        if (!inIframe() || isAmp()) {
            params.mobile = !isAmp() && isDesktop(true) ? 'false' : 'true';
        }
        if (window.mantis_uuid) {
            params.uuid = window.mantis_uuid;
        } else if (window.localStorage) {
            var localUuid = window.localStorage.getItem('mantis:uuid');
            if (localUuid) {
                params.uuid = localUuid;
            }
        }
        if (!inIframe()) {
            try {
                params.title = window.top.document.title;
                params.referrer = window.top.document.referrer;
                params.url = window.top.document.location.href;
            } catch (ex) { }
        } else {
            params.iframe = true;
        }
        if (isAmp()) {
            params.amp = true;
            if (!params.url && window.context.canonicalUrl) {
                params.url = window.context.canonicalUrl;
            }
            if (!params.url && window.context.location) {
                params.url = window.context.location.href;
            }
            if (!params.referrer && window.context.referrer) {
                params.referrer = window.context.referrer;
            }
        }
        Object.keys(data || {}).forEach(function (key) {
            params[key] = data[key];
        });
        var query = jsonToQuery(params);
        return (window.mantis_domain === undefined ? domain || ENDPOINT_URL : window.mantis_domain) + path + '?' + query;
    }

    function inIframe() {
        try {
            return window.self !== window.top && !window.mantis_link;
        } catch (e) {
            return true;
        }
    }

    function isDesktop(ignoreTouch) {
        var supportsTouch = !ignoreTouch && ('ontouchstart' in window || navigator.msMaxTouchPoints);
        if (inIframe()) {
            return !supportsTouch;
        }
        var width = window.innerWidth || window.document.documentElement.clientWidth || window.document.body.clientWidth;
        return !supportsTouch && (!width || width >= (window.mantis_breakpoint || 768));
    }

    function getUuid() {
        var uuid = false;
        if (window.mantis_uuid) {
            uuid = window.mantis_uuid;
        } else if (window.localStorage) {
            var localUuid = window.localStorage.getItem('mantis:uuid');
            if (localUuid) {
                uuid = localUuid;
            }
        }
        return uuid;
    }

    function storeUuid(uuid) {
        if (window.mantis_uuid) {
            return false;
        }
        window.mantis_uuid = uuid;
        if (window.localStorage) {
           try {
                window.localStorage.setItem('mantis:uuid', uuid);
            } catch (ex) {}
        }
    }

    function jsonToQuery(data, chain, form) {
        if (!data) {
            return null;
        }

        var parts = form || [];

        for (var key in data) {
            var queryKey = key;

            if (chain) {
                queryKey = chain + '[' + key + ']';
            }

            var val = data[key];

            if (isArray(val)) {
                for (var index = 0; index < val.length; index++) {
                    var akey = queryKey + '[' + index + ']';
                    var aval = val[index];

                    if (isObject(aval)) {
                        jsonToQuery(aval, akey, parts);
                    } else if (isSendable(aval)) {
                        parts.push(akey + '=' + encodeURIComponent(aval));
                    }
                }
            } else if (isObject(val)) {
                jsonToQuery(val, queryKey, parts);
            } else if (isSendable(val)) {
                parts.push(queryKey + '=' + encodeURIComponent(val));
            }
        }

        return parts.join('&');
    }

    function isSendable(val) {
        if (val === null || val === undefined) {
            return false;
        }

        if (typeof val === 'string') {
            return !(!val || /^\s*$/.test(val));
        }

        if (typeof val === 'number') {
            return !isNaN(val);
        }

        return true;
    }

    function isAmp() {
      return typeof window.context === 'object' && (window.context.tagName === 'AMP-AD' || window.context.tagName === 'AMP-EMBED');
    }

    function isSecure() {
      return document.location.protocol === 'https:';
    }

    function isArray(value) {
        return Object.prototype.toString.call(value) === '[object Array]';
    }

    function isObject(value) {
        return Object.prototype.toString.call(value) === '[object Object]';
    }

    function onMessage(type, callback) {
        window.addEventListener('message', TraceKit.wrap(function (event) {
            if (event.data.mantis && event.data.type == type) {
                callback(event.data.data);
            }
        }), false);
    }

    function onVisible(element, doOnVisible, time, pct) {
        var started = null;
        var notified = false;
        var onNotVisible = null;
        var whenNotVisible = function () {
            if (notified && onNotVisible) {
                onNotVisible();
            }
            notified = false;
        };
        var interval;
        var listener;
        var doCheck = function (winWidth, winHeight, rect) {
            var hidden = typeof document.hidden !== 'undefined' && document.hidden;
            if (rect.width == 0 || rect.height == 0 || hidden) {
                return whenNotVisible();
            }
            var minHeight = (rect.height * pct);
            var minWidth = (rect.width * pct);
            var inView = (
                (
                    (rect.top < 0 && rect.bottom >= minHeight) ||
                    (rect.top > 0 && (winHeight - rect.top) >= minHeight)
                ) &&
                (
                    (rect.left < 0 && rect.right >= minWidth) ||
                    (rect.left > 0 && (winWidth - rect.left) >= minWidth)
                )
            );
            if (!inView) {
                return whenNotVisible();
            }
            if (!started && time) {
                started = Date.now();
                return whenNotVisible();
            }
            if (time && Date.now() - started < time) {
                return whenNotVisible();
            }
            if (notified) {
                return;
            }
            doOnVisible(function (ack) {
                if (ack) {
                    notified = true;
                } else {
                    interval && clearInterval(interval);
                    listener && listener();
                }
            }, function (onHidden) {
                onNotVisible = onHidden;
            });
        };
        if (isAmp()) {
            listener = window.context.observeIntersection(function (changes) {
                changes.forEach(function (change) {
                    doCheck(change.rootBounds.width, change.rootBounds.height, change.boundingClientRect);
                });
            });
        }
        interval = setInterval(function () {
            var winHeight = (window.innerHeight || document.documentElement.clientHeight);
            var winWidth = (window.innerWidth || document.documentElement.clientWidth);
            doCheck(winWidth, winHeight, element.getBoundingClientRect());
        }, 100);
    }

    function pixel(url, parent) {
        var img = document.createElement('img');
        img.src = url;
        img.style.cssText = 'display:none !important;';
        (parent || document.body).appendChild(img);
    }

    onMessage('iframe', function (data) {
        if (window.$sf) {
            var viewed = false;
            $sf.ext.register(data.width, data.height, function () {
                if ($sf.ext.inViewPercentage() < 50 || viewed) {
                    return;
                }
                viewed = true;
                pixel(data.pixel);
            });
        } else {
            var frames = document.getElementsByTagName('iframe');
            for (var i = 0; i < frames.length; i++) {
                var frame = frames[i];
                if (frame.name == data.frame) {
                    onVisible(frame, function (stop) {
                        pixel(data.pixel);
                        stop();
                    }, 1000, 0.50);
                }
            }
        }
    });
    
    userSyncs.add({
        type: 'iframe',
        url: buildMantisUrl('/prebid/iframe')
    });

    return {
        formatRequest: formatRequest,
        send: send,
        bidderInfo: bidderInfo
    };
})();
bidAdapters.criteo = (function() {
	var bidderInfo = {
        rev_share   : 1,
        bid_grouping: 'page',
        default_bid_ttl : 60000
	};

    var bidder = 'criteo';
    var ENDPOINT_URL = '//bidder.criteo.com/cdb';

    var ADAPTER_VERSION   = 16,
        PROFILE_ID_INLINE = 207,
        INTEGRATION_MODES = {
          'amp': 1,
        };

    function formatRequest(slot, tag_id, size, bid) {

    	if(typeof bid.requests[slot.name] == "undefined") {
    		bid.requests[slot.name] = {
                'slot_name' : slot.name,
                'tag_id'    : tag_id,
                'sizes'     : []
            };
    	}

        // Add Size
        bid.requests[slot.name]['sizes'].push(size);

    	return bid;
    }

    function send(bid_level_obj, bid_level, requestData) {

    	var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
    	var slot = (bid_level == 'slot') ? bid_level_obj : {};

    	var data = {
    		'publisher': {
    			'url': page.url
    		},
    		'slots': []
    	}

        request_cnt = {
            'total': 0
        }

        Object.keys(requestData).forEach(function(slot_name) {

            var tag_id = requestData[slot_name]['tag_id'];
            var sizes  = requestData[slot_name]['sizes'];

    		data.slots.push({
    			'impid' : slot_name + '-' + tag_id,
    			'zoneid': tag_id,
                'sizes' : sizes
            });

            request_cnt['total'] += sizes.length;
            if(typeof request_cnt[slot_name] == 'undefined') {
                request_cnt[slot_name] = 0;
            }
            request_cnt[slot_name] += sizes.length;
    	});

        if(data.slots.length == 0) return false;

        // GDPR Consent
		if (gdprConsent.cmpPresent) {
			data.gdprConsent = {};
			if (typeof gdprConsent.gdprApplies !== 'undefined') {
				data.gdprConsent.gdprApplies = !!gdprConsent.gdprApplies;
			}
			if (typeof gdprConsent.consentString !== 'undefined') {
				data.gdprConsent.consentData = gdprConsent.consentString;
			}
			if (gdprConsent.vendorData &&
				gdprConsent.vendorData.vendorConsents &&
				typeof gdprConsent.vendorData.vendorConsents['91'] !== 'undefined'
			) {
				data.gdprConsent.consentGiven = !!(gdprConsent.vendorData.vendorConsents['91']);
			}
		}

        var request_url = ENDPOINT_URL;
        request_url += '?profileId=' + PROFILE_ID_INLINE;
        request_url += '&av=' + String(ADAPTER_VERSION);
        request_url += '&wv=' + encodeURIComponent('2.3.0');
        request_url += '&cb=' + String(Math.floor(Math.random() * 99999999999));
        request_url += '&im=' + INTEGRATION_MODES['amp'];

        // check debug mode
        if(ops.testing_mode == 1) {
            request_url += '&debug=1';
        }

    	//logging
    	page.log.mylog(request_url,bidder);


        // log requests
        page.requests_sent += request_cnt['total'];
        Object.keys(request_cnt).forEach(function(slot_name) {
            if(slot_name !== 'total') {;
                if(typeof page.slots[slot_name] !== 'undefined') {
                    page.slots[slot_name].bids_sent += request_cnt[slot_name];
                }
            }
        });
        bid_level_obj.bids[bidder].sent += request_cnt['total'];

    	var bid_sent_ts = getTimestampMs();

    	//send request
    	$.ajax({
    		url: request_url,
    		requestType: "cors",
    		method: "POST",
    		data: JSON.stringify(data),
    		success: function(json) {

			    try {

    				//logging
    				page.log.mylog(json,bidder);

					var resp = ProperMedia.utils.safeJsonParse(json);

    				//handle response
    				if(resp) {

    					var bids_received_ts = getTimestampMs();
    					var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

    					//process data
    					if(typeof resp['slots'] !== 'undefined') {
                            Object.keys(resp['slots']).forEach(function(key) {

    							var obj = resp['slots'][key];

    							//we got one!
    							var impid  = obj.impid.split('-');
    							var tagid  = obj.zoneid;
    							var cpm    = obj.cpm;
    							var width  = obj.width;
    							var height = obj.height;
    							var adcode = obj.creative;
    							var size   = width+"x"+height;

    							//figure out what slot we got back
    							if(typeof page.slots[impid[0]] !== 'undefined') {
                                    // Get slot object
                                    var slot = page.slots[impid[0]]
    								//identify ad
    								var ad_details = {};

    								//log bid
    								slot.logBidResponse(bidder, size, cpm, adcode, tagid, request_url, resp, ad_details, bid_response_ms, 0);
    								page.log.log_bid(bidder, slot, size, cpm);
    							}
    						});
    					}
    				}

        			//log request as received regardless
                    if(bid_level == 'page') {
                        Object.keys(request_cnt).forEach(function(slot_name) {
                            if(slot_name !== 'total') {
                                if(typeof page.slots[slot_name] !== 'undefined') {
                                    page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
                                }
                            }
                        });
                    } else if(bid_level == 'slot') {
                        slot.incrementBidResponseCount(bidder,request_cnt['total']);
                    }

                } catch(e) { 
                    e.bidder = bidder;
                    throw e;
                }

    		},
    		error: function(resp) {
                try {
        			//log request as received regardless
                    if(bid_level == 'page') {
                        Object.keys(request_cnt).forEach(function(slot_name) {
                            if(slot_name !== 'total') {
                                if(typeof page.slots[slot_name] !== 'undefined') {
                                    page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
                                }
                            }
                        });
                    } else if(bid_level == 'slot') {
                        slot.incrementBidResponseCount(bidder,request_cnt['total']);
                    }

                } catch (e) { 
                    e.bidder = bidder;
                    throw e;
                }

    		}
    	});
    }

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();
bidAdapters.conversant = (function() {
	var bidderInfo = {
        rev_share   : 1,
        bid_grouping: 'page',
        default_bid_ttl : 300000
	};

	var ENDPOINT_URL = "//web.hb.ad.cpe.dotomi.com/s2s/header/24";
    var bidder = 'conversant';

    function formatRequest(slot, tag_id, size, bid) {

    	if(tag_id == 1) tag_id = slot.name;

    	if(typeof bid.requests[tag_id] === 'undefined') { 
    		bid.requests[tag_id] = { 
	    		'slot_name'  : slot.name, 
	    		'tag_id'     : tag_id,
	    		'price_floor': 0,
	    		'sizes'      : []
	    	};
	    }

	    var conversant_floor = get_floor(bidder, slot, size);
	    // Set price floor. Lowest price for possible sizes
	    if(conversant_floor < bid.requests[tag_id]['price_floor'] || bid.requests[tag_id]['price_floor'] == 0) {
	    	bid.requests[tag_id]['price_floor'] = conversant_floor;
	    }

	    var s = size.split("x");
	    var sizeObj = {
	    	'w' : s[0],
	    	'h' : s[1]
	    }
	    bid.requests[tag_id]['sizes'].push(sizeObj);

    	return bid;
    }

    function send(bid_level_obj, bid_level, requestData) {

    	var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
    	var slot = (bid_level == 'slot') ? bid_level_obj : {};

		//build url
    	var request_url = page.protocol + ENDPOINT_URL; // API endpoint

		// Check for global site id.
		var site_id = ops.site_ids[bidder] || undefined;

		// Check site id has a value
		if(!site_id) {
			page.log.mylog("No site ID for conversant set.");
		 	return false;	
		}

		var post_data = {
    		'id'  : Date.now().toString(),
    		'at'  : 1,
    		'imp' : [],
    		'site': {
    			'id'    : site_id.toString(),
    			'mobile': (page.is_mobile ? 1 : 0),
				'page'  : page.url
    		},
			'device' : getDevice(),
			'user': {
				'ext': {
					'fpc': user.pubcid
				}
			}
    	}

    	// request count
		var request_cnt = {
			'total' : 0
		};

		Object.keys(requestData).forEach(function(impid) {

    		var obj = requestData[impid];

    		// Set slot obj if page level
    		if(bid_level == 'page') slot = page.slots[obj.slot_name] || undefined;

    		// Check if slot is set
    		if(slot === undefined || !(slot instanceof slotObj)) return;

	    	var imp = {
    			'id': impid.toString(),
				'bidfloor': obj.price_floor,
    			'secure': (page.use_ssl ? 1 : 0),
    			'displaymanager': 'propermedia',
    			'displaymanagerver': '2.2.4'
    		}

	    	// Banner
	    	if(slot.type == 'display') {
	    		imp.banner = {
					'format': obj.sizes,
					'pos': {'atf': 1, 'btf': 2}[slot.position] || 0
	    		}

	    		post_data.imp.push(imp);
	    	
	    	// Video 
	    	} else if(slot.type == 'video') {
	    		imp.video = {
					'format': {
						'w': obj.sizes[0].w || 0,
						'h': obj.sizes[0].h || 0
					},
					'pos': {'atf': 1, 'btf': 2}[slot.position] || 0,
					'maxduration': 30,
					'mimes'      : ['video/mp4'],
					'protocols'  : [1,2,3], // VAST 1.0, VAST 2.0, VAST 3.0
					'api'        : [1,2]    // VPAID 1.0, VPAID 2.0
    			}

	    		post_data.imp.push(imp);
	    	}

			// Increment request count
			request_cnt['total'] += obj.sizes.length;
			if(typeof request_cnt[slot.name] == 'undefined') {
				request_cnt[slot.name] = 0;	
			}
			request_cnt[slot.name] += obj.sizes.length;

    	});

    	if (gdprConsent.cmpPresent) {
			post_data.user.ext.consent = gdprConsent.consentString;
			if (typeof gdprConsent.gdprApplies === 'boolean') {
				post_data.regs = {
					ext: { gdpr: Number(gdprConsent.gdprApplies) }
				};
			}
		}

		// log requests
		page.requests_sent += request_cnt['total'];
		Object.keys(request_cnt).forEach(function(slot_name) {
			if(slot_name !== 'total') {
				if(typeof page.slots[slot_name] !== 'undefined') {
					page.slots[slot_name].bids_sent += request_cnt[slot_name];
				}
			}
		});
		bid_level_obj.bids[bidder].sent += request_cnt['total'];	

		//logging
		page.log.mylog(request_url, bidder);

		var bid_sent_ts = getTimestampMs();

		//send request
		$.ajax({
			url: request_url,
			method: "POST",
			requestType: "cors",
			data: JSON.stringify(post_data),
			success: function(resp) {

				try {
					
					resp = ProperMedia.utils.safeJsonParse(resp);

					//process response
			        if(!resp || !resp.seatbid || resp.seatbid.length==0 || !resp.seatbid[0].bid) {
		          		page.log.mylog("no conversant bids returned");

			        } else {

						var bids_received_ts = getTimestampMs();
						var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

			        	//logging
						page.log.mylog(resp, bidder);

						Object.keys(resp.seatbid).forEach(function(x) {
							Object.keys(resp.seatbid[x].bid).forEach(function(i) {

								var obj = resp.seatbid[x].bid[i];

								if(typeof obj.adm !== 'undefined') {

									var id      = obj.id      || '',
										impid   = obj.impid   || '',
										price   = obj.price   || 0,
										width   = obj.w       || 1,
										height  = obj.h       || 1,
										adm     = obj.adm     || '',
										nurl    = obj.nurl    || '';
									
									var adcode  = (nurl) ? adm + '<img src="' + nurl + '" />' : adm;

									//log bid
									var slot_data = requestData[impid];

									// if all slots for page were sent at once
									if(bid_level == 'page') slot = page.slots[slot_data.slot_name];

									slot.logBidResponse(bidder, width+"x"+height, parseFloat(price), adcode, impid, request_url, obj, {}, bid_response_ms, slot_data.price_floor);
									page.log.log_bid(bidder, slot, width+"x"+height, parseFloat(price));
								}
							});
						});
					}
					
					//log request as received regardless
					if(bid_level == 'page') {
						Object.keys(request_cnt).forEach(function(slot_name) {
							if(slot_name !== 'total') {
								if(typeof page.slots[slot_name] !== 'undefined') {
									page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
								}
							}
						});
					} else if(bid_level == 'slot') {
						slot.incrementBidResponseCount(bidder,request_cnt['total']);
					}
				
				} catch (e) { 
					e.bidder = bidder;
					throw e;
				}

			},
			error: function(resp) {
				try {
					//log request as received regardless
					if(bid_level == 'page') {
						Object.keys(request_cnt).forEach(function(slot_name) {
							if(slot_name !== 'total') {
								if(typeof page.slots[slot_name] !== 'undefined') {
									page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
								}
							}
						});
					} else if(bid_level == 'slot') {
						slot.incrementBidResponseCount(bidder,request_cnt['total']);
					}

				} catch (e) { 
					e.bidder = bidder;
					throw e;
				}
			}
		});
    }

	function getDNT() {
		return navigator.doNotTrack === '1' || window.doNotTrack === '1' || navigator.msDoNoTrack === '1' || navigator.doNotTrack === 'yes';
	}

	function getDevice() {
	  var language = navigator.language ? 'language' : 'userLanguage';
	  return {
	    h: screen.height,
	    w: screen.width,
	    dnt: getDNT() ? 1 : 0,
	    language: navigator[language].split('-')[0],
	    make: navigator.vendor ? navigator.vendor : '',
	    ua: navigator.userAgent
	  };
	}

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();
bidAdapters.s2s = (function() {
	var bidderInfo = {
        rev_share   : 1,
        bid_grouping: 'slot'
	};

    /*
    bid.requests = {
        slots : [
            {slot_name_1}@{size},
            {slot_name_2}@{size}
            ...
        ]
    }
    */
    function formatRequest(slot, tag_id, size, bid) {
    	if(typeof bid.requests.slots == 'undefined') bid.requests.slots = [];
    	if(bid.requests.slots.indexOf(slot.name+"@"+size) == -1) bid.requests.slots.push(slot.name+"@"+size);

    	return bid;
    }

    function send(bid_level_obj, bid_level, requestData) {

    	var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
    	var slot = (bid_level == 'slot') ? bid_level_obj : {};

        if(requestData.slots.length == 0) return false;

    	//create bid request
        var data = { 
            "publisher"  : ops.site_name,
            "domain"     : page.domain,
            "page"       : page.url, 
            "refer"      : page.referrer,
            "resolution" : page.width+'x'+page.height, 
            "page_width" : page.width,
            "page_height": page.height,
            "is_mobile"  : page.is_mobile.toString(),
            "os"         : window.device.os,
            "os_group"   : window.device.os_group,
            "device_type": window.device.device_type,
            "language"   : navigator.language,
            "ad_slots"   : requestData.slots, 
            "version_id" : ops.split_version.toString()
        };    	
        
        var request_url = page.protocol+"//s2s.proper.io/?proper_uid="+cookieMatching.proper_tracker_cookie.proper_uid+"&data="+encodeURIComponent(JSON.stringify(data));
    	var request_cnt = requestData.slots.length;

    	//logging
    	page.log.mylog(request_url,'s2s');

    	//log requests
        page.requests_sent += request_cnt;
        slot.bids_sent     += request_cnt;
        slot.bids.s2s.sent += request_cnt;

    	var bid_sent_ts = getTimestampMs();

    	//send request
    	$.ajax({
    		url: request_url,
    		requestType: "jsonp",
    		success: function(resp) {

                try {

        			//logging
        			page.log.mylog(resp,'s2s');

    				var bids_received_ts = getTimestampMs();
    				var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

    				for(var key in resp.bids) { //log bids

    					var ad 		= resp.bids[key];
    					var adcode  = decodeURIComponent(ad.adcode);
                        var bidder  = ad.bidder+'_s2s';
    					var price   = ad.price;
    					var impid  	= ad.impid;

    					//pixel
    					if(ad.nurl && ad.nurl!="") adcode += "<img src=\""+ad.nurl+"\" width=1 height=1>";


    					//parse ImpID
    					var d 		  = impid.split("@");
    					var slot_name = d[0];
    					var size      = d[1];
    					var tag_id 	  = "";

    					//log bid
    					slot.logBidResponse(bidder, size, price, adcode, tag_id, request_url, resp, {}, bid_response_ms, 0);
    					page.log.log_bid(bidder, slot, size, price);
    				}

        			//log request as received regardless
        			slot.incrementBidResponseCount('s2s',request_cnt);

                } catch (e) { 
                    e.bidder = 's2s';
                    throw e;
                }

    		},
    		error: function(resp) {
                try {
        			slot.incrementBidResponseCount('s2s',request_cnt);

                } catch (e) { 
                    e.bidder = 's2s';
                    throw e;
                }
    		}
    	});
    }

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();
bidAdapters.districtmdmx = (function() {
	var bidderInfo = {
        rev_share   : 1,
        bid_grouping: 'page',
        default_bid_ttl : 60000
	};

    var ENDPOINT_URL  = '//dmx.districtm.io/b/v1',
        TEST_ENDPOINT = '//demo.arrepiblik.com/dmx2',
        memberID      = 100275,
        bidder        = 'districtmdmx';

    function formatRequest(slot, tag_id, size, bid) {

        if(typeof bid.requests[tag_id] === 'undefined') {
            bid.requests[tag_id] = {
                'slot_name'  : slot.name,
                'tag_id'     : tag_id,
                'sizes'      : []
            };
        }

        var s = size.split("x");
        var sizeObj = {
            'w' : parseInt(s[0]),
            'h' : parseInt(s[1])
        }
        bid.requests[tag_id]['sizes'].push(sizeObj);

        return bid;
    }

    function send(bid_level_obj, bid_level, requestData) {

        var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
        var slot = (bid_level == 'slot') ? bid_level_obj : {};

        //build url
        var request_url = page.protocol + (ops.testing_mode == 1 ? TEST_ENDPOINT : ENDPOINT_URL); // API endpoint

        var post_data = {
            'id'  : generateUUID(),
            'cur' : ['USD'],
            'tmax': 2700,
            'site': {
                'publisher': {
                    'id': String(memberID)
                }
            },
            'imp': []
        }

        // request count
        var request_cnt = {
            'total' : 0
        };

        Object.keys(requestData).forEach(function(tag_id) {

            var obj = requestData[tag_id];

            var imp = {
                'id'    : String(tag_id),
                'tagid' : String(tag_id),
                'secure': (page.use_ssl ? 1 : 0),
                'banner': {
                    'topframe': (typeof dfp_per_slot !== "undefined" && dfp_per_slot == 1) ? 0 : 1,
                    'w'       : obj.sizes[0]['w'] || 0,
                    'h'       : obj.sizes[0]['h'] || 0,
                    'format'  : obj.sizes || []
                }
            };

            post_data.imp.push(imp);

            // Increment request count
            request_cnt['total'] += obj.sizes.length;
            if(typeof request_cnt[slot.name] == 'undefined') {
                request_cnt[slot.name] = 0;
            }
            request_cnt[slot.name] += obj.sizes.length;
        });

        // GDPR Consent
        if (gdprConsent.cmpPresent) {
            post_data.user = {
                ext: {
                    consent: gdprConsent.consentString
                }
            };
            if (typeof gdprConsent.gdprApplies === 'boolean') {
                post_data.regs = {
                    ext: {
                        gdpr: Number(gdprConsent.gdprApplies)
                    }
                };
            }
        }

        // check debug mode
        if(ops.testing_mode == 1) {
            post_data.test = 1;
        }

        // log requests
        page.requests_sent += request_cnt['total'];
        Object.keys(request_cnt).forEach(function(slot_name) {
            if(slot_name !== 'total') {
                if(typeof page.slots[slot_name] !== 'undefined') {
                    page.slots[slot_name].bids_sent += request_cnt[slot_name];
                }
            }
        });
        bid_level_obj.bids[bidder].sent += request_cnt['total'];

        //logging
        page.log.mylog(request_url, bidder);

        var bid_sent_ts = getTimestampMs();

        //send request
        $.ajax({
            url: request_url,
            method: "POST",
            requestType: "cors",
            data: JSON.stringify(post_data),
            success: function(resp) {

                try {

                    resp = ProperMedia.utils.safeJsonParse(resp);

                    //process response
                    if(!resp || !resp.seatbid || resp.seatbid.length==0 || !resp.seatbid[0].bid) {
                        page.log.mylog("no conversant bids returned");

                    } else {

                        var bids_received_ts = getTimestampMs();
                        var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

                        //logging
                        page.log.mylog(resp, bidder);

                        Object.keys(resp.seatbid).forEach(function(x) {
                            Object.keys(resp.seatbid[x].bid).forEach(function(i) {

                                var obj = resp.seatbid[x].bid[i];

                                if(typeof obj.adm !== 'undefined') {

                                    var id      = obj.id      || '',
                                        impid   = obj.impid   || '',
                                        price   = obj.price   || 0,
                                        width   = obj.w       || 1,
                                        height  = obj.h       || 1,
                                        adm     = obj.adm     || '',
                                        nurl    = obj.nurl    || '';

                                    var adcode  = (nurl) ? adm + '<img src="' + nurl + '" />' : adm;

                                    //log bid
                                    var slot_data = requestData[impid];

                                    // if all slots for page were sent at once
                                    if(bid_level == 'page') slot = page.slots[slot_data.slot_name];

                                    if(width == 1 && height == 1 && slot_data.sizes.length == 1) {
                                        width  = slot_data.sizes[0].w;
                                        height = slot_data.sizes[0].h;
                                    }

                                    slot.logBidResponse(bidder, width+"x"+height, parseFloat(price), adcode, impid, request_url, obj, {}, bid_response_ms, 0);
                                    page.log.log_bid(bidder, slot, width+"x"+height, parseFloat(price));
                                }
                            });
                        });
                    }

                    //log request as received regardless
                    if(bid_level == 'page') {
                        Object.keys(request_cnt).forEach(function(slot_name) {
                            if(slot_name !== 'total') {
                                if(typeof page.slots[slot_name] !== 'undefined') {
                                    page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
                                }
                            }
                        });
                    } else if(bid_level == 'slot') {
                        slot.incrementBidResponseCount(bidder,request_cnt['total']);
                    }

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }

            },
            error: function(resp) {
                try {
                    //log request as received regardless
                    if(bid_level == 'page') {
                        Object.keys(request_cnt).forEach(function(slot_name) {
                            if(slot_name !== 'total') {
                                if(typeof page.slots[slot_name] !== 'undefined') {
                                    page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
                                }
                            }
                        });
                    } else if(bid_level == 'slot') {
                        slot.incrementBidResponseCount(bidder,request_cnt['total']);
                    }

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
            }
        });
    }

	userSyncs.add({
		type: 'iframe',
		url: 'https://cdn.districtm.io/ids/index.html'
    });

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();
bidAdapters.lockerdome = (function() {
	var bidderInfo = {
        rev_share   : 1,
        bid_grouping: 'page'
	};

    var bidder       = 'lockerdome',
		// Lockerdome requires https. http requests are redirected, breaking CORS support.
        ENDPOINT_URL = 'https://lockerdome.com/ladbid/prebid';

    function formatRequest(slot, tag_id, size, bid) {

        if(typeof bid.requests[slot.name] == 'undefined') {
        	bid.requests[slot.name] = {
                'slot_name': slot.name,
                'slot_div': slot.div_id,
                'tag_id': tag_id,
                'sizes': []
            }
        }

        bid.requests[slot.name].sizes.push(size);

    	return bid;
    }

    function send(bid_level_obj, bid_level, requestData) {

    	var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
    	var slot = (bid_level == 'slot') ? bid_level_obj : {};

        var request_cnt = 0;

        var postData = {
            'bidRequests': [],
            'referrer': page.referrer,
            'url': page.url
        };

        Object.keys(requestData).forEach(function(slot_name) {
            var bidData = requestData[slot_name];

            postData.bidRequests.push({
                'requestId' : bidData.slot_name,
                'adUnitCode': bidData.slot_div,
                'adUnitId'  : bidData.tag_id,
                'sizes'     : bidData.sizes
            });

            request_cnt += bidData.sizes.length;
        });

        if(postData.bidRequests.length == 0) return;

		if (gdprConsent.cmpPresent) {
			postData.gdpr = {
				applies: gdprConsent.gdprApplies,
				consent: gdprConsent.consentString
			};
		}

    	// log requests
    	page.requests_sent += request_cnt;
    	if(bid_level == 'page') {
            Object.keys(requestData).forEach(function(slot_name) {
    			if(typeof page.slots[slot_name] !== 'undefined')
    				page.slots[slot_name].bids_sent += requestData[slot_name].sizes.length;
    		});
    	} else if(bid_level == 'slot') {
    		slot.bids_sent += requestData[slot.name].sizes.length;
    	}
    	bid_level_obj.bids[bidder].sent += request_cnt;

    	var bid_sent_ts = getTimestampMs();

        var request_url = ENDPOINT_URL;

        page.log.mylog(request_url,bidder); // logging

    	//send request
    	$.ajax({
            method: "POST",
    		url: request_url,
    		requestType: "cors",
            data: JSON.stringify(postData),
    		success: function(resp) {

                try {

        			//logging
        			page.log.mylog(resp,bidder);

                    var resp = ProperMedia.utils.safeJsonParse(resp);

                    var bids_received_ts = getTimestampMs();
                    var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

                    if(resp && resp.bids) {

                        Object.keys(resp.bids).forEach(function(x) {

                            var bid = resp.bids[x];

                            var requestId  = bid.requestId,
                                price      = bid.cpm,
                                width      = bid.width,
                                height     = bid.height,
                                creativeId = bid.creativeId,
                                currency   = bid.currency,
                                netRevenue = bid.netRevenue,
                                adcode     = bid.ad,
                                ttl        = bid.ttl,
                                size       = width+"x"+height;

                            if(bid_level == 'page') slot = page.slots[requestId];

                            tag_id = requestData[slot.name].tag_id;

    						//log bid
    						slot.logBidResponse(bidder, size, price, adcode, tag_id, request_url, resp, {}, bid_response_ms, 0);
    						page.log.log_bid(bidder, slot, size, price);
    					});
    				}

        			//log request as received regardless
        			if(bid_level == 'page') {
                        Object.keys(requestData).forEach(function(slot_name) {
        					if(typeof page.slots[slot_name] !== 'undefined')
        						page.slots[slot_name].incrementBidResponseCount(bidder,request_cnt);
        				});
        			} else if(bid_level == 'slot') {
        				slot.incrementBidResponseCount(bidder,request_cnt);
        			}

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }

    		},
    		error: function(resp) {
                try {
        			//log request as received regardless
        			if(bid_level == 'page') {
                        Object.keys(requestData).forEach(function(slot_name) {
        					if(typeof page.slots[slot_name] !== 'undefined')
        						page.slots[slot_name].incrementBidResponseCount(bidder,request_cnt);
        				});
        			} else if(bid_level == 'slot') {
        				slot.incrementBidResponseCount(bidder,request_cnt);
        			}

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }

    		}
    	});

    }

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();
bidAdapters.teads = (function() {
	var bidderInfo = {
        rev_share   : 1,
        bid_grouping: 'page'
	};

	var ENDPOINT = "//a.teads.tv/hb/bid-request",
		USYNCURL = "//sync.teads.tv/iframe";

    function formatRequest(slot, tag_id, size, bid) {
    	// tag_id = {placementId}-{pageID}
    	var ids = tag_id.split('-');
    	if(ids.length == 2) {

    		placementId = parseInt(ids[0]);
    		pageId      = parseInt(ids[1]);

    		var adUnitCode = slot.div_id;
    		if(slot.adPool instanceof adPoolObj) {
    			adUnitCode = "teads-"+generateUUID();
    		}

	    	if(typeof bid.requests[slot.name] == 'undefined') {
		    	bid.requests[slot.name] = {
		    		'bidId'           : slot.name,
		    		'placementId'     : placementId,
		    		'pageId'          : pageId,
		    		'adUnitCode'      : adUnitCode,
		    		'bidderRequestId' : generateUUID(),
		    		'transactionId'   : generateUUID(),
		    		'auctionId'       : generateUUID(),
		    		'sizes'           : []
		    	}
		    }
			bid.requests[slot.name]['sizes'].push(size);
		}

    	return bid;
    }

    function send(bid_level_obj, bid_level, requestData) {

    	var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
    	var slot = (bid_level == 'slot') ? bid_level_obj : {};

		var request_url = page.protocol + ENDPOINT;
		var request_cnt = { 'total': 0 }

		var bids = [];
    	for(var key in requestData) {
    		// Append slot to post data
    		bids.push(requestData[key]);
    		// Increment request count
    		if(typeof request_cnt[key] == 'undefined') request_cnt[key] = 0;
    		request_cnt[key]     += requestData[key].sizes.length || 0;
    		request_cnt['total'] += requestData[key].sizes.length || 0;
    	}

    	var postData = {
    		'referrer'   : page.url,
    		'data'       : bids,
    		'deviceWidth': page.width
    	}

		// log requests
		page.requests_sent += request_cnt['total'];
		for(var slot_name in request_cnt) {
			if(slot_name == 'total') continue;
			if(typeof page.slots[slot_name] !== 'undefined')
				page.slots[slot_name].bids_sent += request_cnt[slot_name];
		}
		bid_level_obj.bids['teads'].sent += request_cnt['total'];

		//logging
		page.log.mylog(request_url, 'teads');

		var bid_sent_ts = getTimestampMs();

		//send request
		$.ajax({
			url: request_url,
			method: "POST",
			requestType: "cors",
			data: JSON.stringify(postData),
			success: function(resp) {

				try {

					resp = ProperMedia.utils.safeJsonParse(resp);

					var bids_received_ts = getTimestampMs();
					var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

					//process response
			        if(resp && resp.responses && resp.responses.length > 0) {

			        	//logging
						page.log.mylog(resp,'teads');

						for(var i = 0; i < resp.responses.length; i++) {

							var respObj = resp.responses[i];

							var bidId  = respObj.bidId  || '',
								width  = respObj.width  || 1,
								height = respObj.height || 1,
								price  = respObj.cpm    || 0,
								adcode = respObj.ad     || '',
								ttl    = respObj.ttl    || 30000;

							// if all slots for page were sent at once
							if(bid_level == 'page') slot = page.slots[bidId];

							var ad_details = {};
							if(slot.adPool instanceof adPoolObj) {
								ad_details.ad_code_prepend = "<script>var slot_div = window.top.document.getElementById(\"{SLOT_DIV_ID}\"); var div = document.createElement('div'); div.setAttribute(\"id\", \""+requestData[bidId]['adUnitCode']+"\"); slot_div.appendChild(div);<\/script>";
							}

							// Set Size
	                        var size = '1x1';
	                        if( requestData[bidId]['sizes'].indexOf(width + 'x' + height) !== -1 ) {
	                            size = width + 'x' + height;
	                        }

							var impid = requestData[bidId]['placementId'] + '-' + requestData[bidId]['pageId'];

							slot.logBidResponse('teads', size, parseFloat(price), adcode, impid, request_url, respObj, ad_details, bid_response_ms, 0);
							page.log.log_bid('teads', slot, size, parseFloat(price));
						}

			        } else {
			        	page.log.mylog("no teads bids returned");
					}

					//log request as received regardless
					if(bid_level == 'page') {
						for(slot_name in request_cnt) {
							if(slot_name == 'total') continue;
							if(typeof page.slots[slot_name] !== 'undefined')
								page.slots[slot_name].incrementBidResponseCount('teads', request_cnt[slot_name]);
						}
					} else if(bid_level == 'slot') {
						slot.incrementBidResponseCount('teads',request_cnt['total']);
					}

				} catch (e) {
					e.bidder = 'teads';
					throw e;
				}

			},
			error: function(resp) {
				try {
					//log request as received regardless
					if(bid_level == 'page') {
						for(slot_name in request_cnt) {
							if(slot_name == 'total') continue;
							if(typeof page.slots[slot_name] !== 'undefined')
								page.slots[slot_name].incrementBidResponseCount('teads', request_cnt[slot_name]);
						}
					} else if(bid_level == 'slot') {
						slot.incrementBidResponseCount('teads',request_cnt['total']);
					}

				} catch (e) {
					e.bidder = 'teads';
					throw e;
				}

			}
		});
    }

	userSyncs.add({ type: 'iframe', url: USYNCURL });

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();
bidAdapters.emx = (function() {
	var bidderInfo = {
        rev_share   : 1,
        bid_grouping: 'page'
	};

	var ENDPOINT_URL = "//hb.emxdgt.com";
    var bidder = 'emx';

    function formatRequest(slot, tag_id, size, bid) {

    	if(typeof bid.requests[slot.name] === 'undefined') {
    		bid.requests[slot.name] = {
	    		'slot_name'  : slot.name,
	    		'tag_id'     : tag_id,
	    		'price_floor': 0,
	    		'sizes'      : []
	    	};
	    }

	    var price_floor = get_floor(bidder, slot, size);
	    // Set price floor. Lowest price for possible sizes
	    if(price_floor < bid.requests[slot.name]['price_floor'] || bid.requests[slot.name]['price_floor'] == 0) {
	    	bid.requests[slot.name]['price_floor'] = price_floor;
	    }

	    var s = size.split("x");
	    var sizeObj = {
	    	'w' : parseInt(s[0]),
	    	'h' : parseInt(s[1])
	    }
	    bid.requests[slot.name]['sizes'].push(sizeObj);

    	return bid;
    }

    function send(bid_level_obj, bid_level, requestData) {

    	var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
    	var slot = (bid_level == 'slot') ? bid_level_obj : {};

		//build url
    	var request_url = page.protocol + ENDPOINT_URL + ('?t=' + 3000 + '&ts=' + Date.now()); // API endpoint

		var post_data = {
    		'id'  : Date.now().toString(),
    		'imp' : [],
    		'site': {
    			'domain': getPageDomain(),
				'page'  : page.url
    		}
    	}

    	// request count
		var request_cnt = {
			'total' : 0
		};

		Object.keys(requestData).forEach(function(slot_name) {

    		var obj = requestData[slot_name];

    		// Set slot obj if page level
    		if(bid_level == 'page') slot = page.slots[obj.slot_name] || undefined;

    		// Check if slot is set
    		if(slot === undefined || !(slot instanceof slotObj)) return;

	    	var imp = {
    			'id': obj.slot_name.toString(),
    			'tid': generateUUID(),
    			'tagid': obj.tag_id,
				'bidfloor': obj.price_floor,
    			'secure': page.use_ssl ? 1 : 0,
    			'banner': {
    				'format': obj.sizes,
    				'w': obj.sizes[0]['w'],
    				'h': obj.sizes[0]['h']
    			}
    		}

    		post_data['imp'].push(imp);

			// Increment request count
			request_cnt['total'] += obj.sizes.length;
			if(typeof request_cnt[slot.name] == 'undefined') {
				request_cnt[slot.name] = 0;
			}
			request_cnt[slot.name] += obj.sizes.length;

    	});

    	if (gdprConsent.cmpPresent) {
			post_data.user = {
				ext: {
					consent: gdprConsent.consentString
				}
			}
			if (typeof gdprConsent.gdprApplies === 'boolean') {
				post_data.regs = {
					ext: {
						gdpr: Number(gdprConsent.gdprApplies)
					}
				};
			}
		}

		// log requests
		page.requests_sent += request_cnt['total'];
		Object.keys(request_cnt).forEach(function(slot_name) {
			if(slot_name !== 'total') {
				if(typeof page.slots[slot_name] !== 'undefined') {
					page.slots[slot_name].bids_sent += request_cnt[slot_name];
				}
			}
		});
		bid_level_obj.bids[bidder].sent += request_cnt['total'];

		//logging
		page.log.mylog(request_url, bidder);

		var bid_sent_ts = getTimestampMs();

		//send request
		$.ajax({
			url: request_url,
			method: "POST",
			requestType: "cors",
			data: JSON.stringify(post_data),
			success: function(resp) {

				try {

					resp = ProperMedia.utils.safeJsonParse(resp);

					//process response
			        if (resp.seatbid && resp.seatbid.length > 0 && resp.seatbid[0].bid) {

						var bids_received_ts = getTimestampMs();
						var bid_response_ms  = calcResponseMs(bid_sent_ts, bids_received_ts);

			        	//logging
						page.log.mylog(resp, bidder);

						Object.keys(resp.seatbid).forEach(function(x) {

							var obj = resp.seatbid[x].bid[0];

							if(typeof obj.adm !== 'undefined') {

								var id      = obj.id    || '',
									impid   = obj.crid  || obj.id,
									price   = obj.price || 0,
									width   = obj.w     || 1,
									height  = obj.h     || 1,
									adcode  = obj.adm   || '';

									try {
										adcode = decodeURIComponent(adcode) || '';
									} catch (e) {
										adcode = obj.adm || '';
									}
									
								//log bid
								var slot_data = requestData[id];

								// if all slots for page were sent at once
								if(bid_level == 'page') slot = page.slots[slot_data.slot_name];

								slot.logBidResponse(bidder, width+"x"+height, price, adcode, id, request_url, obj, {}, bid_response_ms, slot_data.price_floor);
								page.log.log_bid(bidder, slot, width+"x"+height, price);
							}
						});
					}

					//log request as received regardless
					if(bid_level == 'page') {
						Object.keys(request_cnt).forEach(function(slot_name) {
							if(slot_name !== 'total') {
								if(typeof page.slots[slot_name] !== 'undefined') {
									page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
								}
							}
						});
					} else if(bid_level == 'slot') {
						slot.incrementBidResponseCount(bidder,request_cnt['total']);
					}

				} catch (e) {
					e.bidder = bidder;
					throw e;
				}

			},
			error: function(resp) {
				try {
					//log request as received regardless
					if(bid_level == 'page') {
						Object.keys(request_cnt).forEach(function(slot_name) {
							if(slot_name !== 'total') {
								if(typeof page.slots[slot_name] !== 'undefined') {
									page.slots[slot_name].incrementBidResponseCount(bidder, request_cnt[slot_name]);
								}
							}
						});
					} else if(bid_level == 'slot') {
						slot.incrementBidResponseCount(bidder,request_cnt['total']);
					}

				} catch (e) {
					e.bidder = bidder;
					throw e;
				}
			}
		});
    }

	userSyncs.add({
		type: 'iframe',
		url: '//biddr.brealtime.com/check.html'
    });

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();


	// END FORMAT REQUEST DATA
	//~~~~~~~~~~~~~~~~~~~~~~~~~

	gdprConsent.ready(function(data) {
		if (data.isolated) {
			// disable DFP/Adsense/etc if no consent for "Storage and access of
			// information" or "Personalisation"...
			ops.isolated = 1;
			for (var i = 0; i < pages.length; i++) {
				pages[i].isolated = 1;
			}
		}
	});

	//~~~~~~~~~~~~~~~~~~~~~~
	// SEND BIDDER REQUESTS

	function send_bidders(data) {
		gdprConsent.ready(function() { deferred_send_bidders(data); });
	}

	function deferred_send_bidders(data) {

		//testing mode (turn off all other bidders)
		if(ops.testing_mode == 1) {
			data = {};
			data[0] = [];
			data[0][pages[0].get_vars.proper_test] = 1;
		}

		// Setup page
		var page = pages[0];

		//kill all ads
		if(typeof special_ops.kill_all_ads !== 'undefined' && special_ops.kill_all_ads == "yes") {
			page.log.mylog("Kill All Ads enabled! Good bye!");
			return false;
		}

		// Dont send bids out for this page
		if(page.dont_send_bids === true) return;

		// Remove bidders outside of start/stop ranges
		data = removeStartStopBidders(page, data);

		// shuffle bidder order
		data = shuffleBidders(data);

		// send page bidders
		ops.enabled_bidders = data;
		setupBids(page.slots, data[0]);
		sendBids(page, 'page', data[0]);

		// do cookie matching for server to server bidders
		if(typeof data[0].s2s !== 'undefined' && data[0].s2s == 1) {
			cookieMatching.page = page;
			cookieMatching.s_to_s_bidders = { 'sovrn' : 1, 'pubmatic' : 1, 'districtm' : 1 };
			cookieMatching.cookieMatch();
		}

		// Loop through each slot on page
		for (slot_name in page.slots) {
			var slot = ProperMedia.utils.getSlotFromPageObject(page, slot_name);

			if(slot) {
				// send bids by slot
				sendBids(slot, 'slot', data[0]);
			}
		}

		// sovrn pixel
		if(data[0].sovrn && data[0].sovrn == 1 && page.protocol == "http:") {
			var sovrn_pixel = document.createElement("script");
			sovrn_pixel.type = "text/javascript"; sovrn_pixel.id = "sBeacon";
			sovrn_pixel.src = page.protocol+"//ap.lijit.com/www/sovrn_beacon_standalone/sovrn_standalone_beacon.js?iid=13387626&amp;uid=proper_media";
			document.getElementsByTagName('head')[0].appendChild(sovrn_pixel);
		}

		// Load DFP
		if(page.isolated == 1) {
			page.log.mylog("Isolated Mode! - NO DFP");
		}

		//async support for catching up
		propertag.cmd.push = function (cmd) {
			cmd.call();
		}
		for (i = 0; i < propertag.cmd.length; i++) {
			propertag.cmd[i].call();
		}
	}

	function bidderToAdapterName(bidder) {
		var bidderAdapterName;
		if (bidder == 'appnexus' || bidder == 'brealtime' || bidder == 'districtm') {
			bidderAdapterName = 'appnexus';
		} else if(bidder == 'remnant_rubicon' || bidder == 'remnant_adsense' || bidder == 'remnant_adx') {
			bidderAdapterName = 'remnant';
		} else {
			bidderAdapterName = bidder;
		}

		return bidderAdapterName;
	}

	function setupBids(slots, bidders) {

		// check if there are multiple slots
		var multiple_slots = (Object.keys(slots).length > 1) ? 1 : 0;

		// loop through each slot
		for(slot_name in slots) {
			var slot = slots[slot_name];

			// loop through each slot size
			for(size in slot.sizes) {

				// Only refresh to current displayed size for sticky slot
        		if(
                    slot.sticky == 1 && 
                    slot.refresh_cnt > 0 && 
                    slot.size.join('x') !== size
                ) {
                    continue;
                }

				// loop through each bidder tag in slot size
				for(bidder in slot.sizes[size]) {

					if(typeof bidders[bidder] !== 'undefined' && bidders[bidder] == 1) {

						// if bidder is enabled
						if(typeof slot.sizes[size][bidder] !== 'undefined' && slot.sizes[size][bidder] !== '') {

							var tagId = slot.sizes[size][bidder],
								bid   = new bidObj();

							if(ops.bidder_info[bidder].bid_grouping == 'page' && (multiple_slots == 1 || (bidder == 's2s' && slot.page.page_number == 1)) ) {
								bid = (typeof slot.page.bids[bidder] !== 'undefined') ? slot.page.bids[bidder] : new bidObj();
							// bids sent out per slot
							} else if(ops.bidder_info[bidder].bid_grouping == 'slot' || multiple_slots == 0) {
								bid = (typeof slot.bids[bidder] !== 'undefined') ? slot.bids[bidder] : new bidObj();
							}

							var bidderAdapterName = bidderToAdapterName(bidder);

							try {
								if (typeof bidAdapters[bidderAdapterName] !== 'undefined') {
									bid = bidAdapters[bidderAdapterName].formatRequest(slot, tagId, size, bid);
								} else if(bidderAdapterName == 'remnant') {
									bid = formatRemnantRequests(slot, tagId, size, bid);
								}
							} catch (e) {
								console.error(e);
                                // Log error formatting request
                                e.bidder = bidderAdapterName;
                                sendError(TraceKit.computeStackTrace(e));
                            }

							if(bid && bid.bidder == '') {
								bid.bidder = bidder;
							}

							// bids sent out for whole page
							if(ops.bidder_info[bidder].bid_grouping == 'page' && (multiple_slots == 1 || (bidder == 's2s' && slot.page.page_number == 1)) ) {
								slot.page.bids[bidder] = bid; // set page bids
							} else if(ops.bidder_info[bidder].bid_grouping == 'slot' || multiple_slots == 0) {
								slot.bids[bidder] = bid; // set slot bids
							}
						}
					}
				}
			}
		}
	}

	// Remove bidders outside of start/stop ranges
	function removeStartStopBidders(page, data) {

		var depth = page.sessionHandler.sessionData.depth;

		// If there are start/stop bidders
		if(Object.keys(ops.start_stop_bidders).length > 0) {
			// loop through each start/stop bidder
			for(var startStopBidder in ops.start_stop_bidders) {

				// Get bidder's start/stop array
				var start_stop_bidder_array = ops.start_stop_bidders[startStopBidder];

				var disable = false;
				// Loop through start/stop rules
				for(var i = 0; i < start_stop_bidder_array.length; i++) {

					// Get bidder's start stop rule
					var startStopRule = start_stop_bidder_array[i];

					// If bidder is should be enabled
					if((startStopRule.start === null || startStopRule.start <= depth) &&
						(startStopRule.stop === null || depth <= startStopRule.stop)) {
						disable = false;
						break;
					// If bidder should be disabled
					} else {
						disable = true;
					}
				}

				// If bidder should be disabled
				if(disable) {
					// Loop through each auction
					for(var i = 0; i < data.length; i++) {
						// If bidder is in auction
						if(typeof data[i][startStopBidder] !== 'undefined') {
							// Disable bidder
							data[i][startStopBidder] = 0
						}
					}
				}
			}
		}
		return data;
	}

	// randomize bidder order
	function shuffleBidders(data) {

		var shuffledBidders = [];

		for(auction_num in data) {

			var keys = Object.keys(data[auction_num]);
			for (var i = keys.length - 1; i > 0; i--) {
				var j = Math.floor(Math.random() * (i + 1));
				var temp = keys[i];
				keys[i] = keys[j];
				keys[j] = temp;
			}

			for(index in keys) {
				if(typeof shuffledBidders[auction_num] == 'undefined') shuffledBidders[auction_num] = {};
				shuffledBidders[auction_num][keys[index]] = data[auction_num][keys[index]];
			}
		}

		return shuffledBidders;
	}

	// bid_level_obj: page or slot
	function sendBids(bid_level_obj, bid_level, enabled_bidders) {

		var page = (bid_level == 'page') ? bid_level_obj : bid_level_obj.page;
		var slot = (bid_level == 'slot') ? bid_level_obj : {};

		if(
            page.dont_send_bids === true || 
            (
                bid_level == 'slot' &&
                slot.lazyload_enabled &&
                slot.lazyload.inFetchZone == false
            )
        ) { 
            return;
        }

		// timestamp bids started sending out
		var d = new Date();
		var ts = d.getTime();
		bid_level_obj.bids_started_ts = ts;

		// start max timeout to send DFP request
		if(bid_level == 'slot') {
			// start timer
			bid_level_obj.wait();
		}

		// loop through each bidder
		for(bidder in enabled_bidders) {

			if(enabled_bidders[bidder] == 1 && typeof bid_level_obj.bids[bidder] !== 'undefined' && typeof bid_level_obj.bids[bidder].requests !== 'undefined' && bidder !== 'remnant_rubicon' && bidder !== 'remnant_adsense' && bidder !== 'remnant_adx') {

				var bidderAdapterName = bidderToAdapterName(bidder);

				if (typeof bidAdapters[bidderAdapterName] !== 'undefined') {

					var requestData = bid_level_obj.bids[bidder].requests;

					if( (typeof requestData.data !== 'undefined' && requestData.data.length > 0) || Object.keys(requestData).length > 0 ) {

						try {
							bidAdapters[bidderAdapterName].send(bid_level_obj, bid_level, requestData, bidder);
						} catch(e) {
							console.error(e);
                            // Log error formatting request
                            e.bidder = bidderAdapterName;
                            sendError(TraceKit.computeStackTrace(e));
                        }
					}
				}
			}
		}
	}

	function initDfp(slot) {
		var iframe_window, iframe_needs_dfp_script = false;

		//Check if slot is using an existing iframe document
		if (slot.iframe_window) {
		  iframe_window = slot.iframe_window;
		  iframe_needs_dfp_script = true;
		}
		//Check if slot is using an existing iframe
		else if (slot.iframe_id) {
		  var iframe = document.getElementById(slot.iframe_id);
		  if(!iframe) {
		    pages[0].log.mylog("ERROR: "+slot.iframe_id+" doesn't exist in the DOM.");
		    return;
		  }
		  iframe_window = iframe.contentWindow;
		  iframe_needs_dfp_script = true;
		} else {

		  //Check if div exists
		  var doc = document.getElementById(slot.div_id);
		  if(!doc) {
		    pages[0].log.mylog("WARNING: "+slot.div_id+" doesn't exist in the DOM. This should re-run when proper_display is called");
		    return;
		  }

		  //build iframe to load DFP without interfering with top level page
		  var iframe = document.createElement('iframe');
		  doc.innerHTML="";
		  doc.appendChild(iframe);
		  iframe.id                  = slot.div_id+"-iframe";
		  iframe.frameBorder         = 0;
		  iframe.scrolling           = "no";
		  iframe.marginWidth         = "0";
		  iframe.marginHeight        = "0";
		  iframe.style.overflow      = "hidden";
		  iframe.style.border        = "0px";
		  iframe.style.width         = "1px";
		  iframe.style.height        = "1px";
		  iframe.style.verticalAlign = "bottom";
		  //iframe.src="javascript:\"<html><head></head><body style='background:transparent'></body></html>\"";
		  var html = "<html><head><script src='https://securepubads.g.doubleclick.net/tag/js/gpt.js' async></script></head><body><div id='"+slot.div_id+"'></div></body></html>";
		  iframe.src="javascript:\""+html+"\"";
		  iframe.contentWindow.document.open();
		  iframe.contentWindow.document.write(html);
		  iframe.contentWindow.document.close();
		  iframe_window = iframe.contentWindow;
		}

		if (iframe_needs_dfp_script) {
			//Load GoogleTag DFP Library
			var gads = document.createElement('script');
			gads.async = true;
			gads.type = 'text/javascript';
			var useSSL = 'https:' == document.location.protocol;
			gads.src = (useSSL ? 'https:' : 'http:') + '//securepubads.g.doubleclick.net/tag/js/gpt.js';
			iframe_window.document.getElementsByTagName('head')[0].appendChild(gads);

			// Load Confiant DFP On-Page Integration
	        if(typeof ops.confiant !== "undefined" && ops.confiant == 1) {
	            confiantWrapper.loadDFPTag();
	        }
		}

		//create googletag object in iframe
		iframe_window.googletag = iframe_window.googletag || {};
		slot.google_tag = iframe_window.googletag || {};
		if(typeof slot.google_tag.cmd == "undefined") slot.google_tag.cmd = [];

		//googletag monitor events
		slot.google_tag.cmd.push(function(){
			if (gdprConsent.noPersonalization) {
				// disable personalized GPT ads
				slot.google_tag.pubads().setRequestNonPersonalizedAds(1);
			}

		  // in view callback function
		  slot.google_tag.pubads().addEventListener('slotRenderEnded', TraceKit.wrap(function(event) {

		    var parts = event.slot.getSlotElementId().split("-");
		    var slot_name   = parts[2];
		    var page_number = (parts.length > 3) ? parseInt(parts[3]) : 1;

		    var page = ProperMedia.utils.getPageObjectByIndex(pages, page_number);
			var slot = ProperMedia.utils.getSlotFromPageObject(page, slot_name);

			if(page && slot) {

				//setup creative
				if(event.advertiserId == ops.amazon_advertiser) {
					event.size = (typeof slot.bids.a9 !== 'undefined' && typeof slot.bids.a9.responses !== 'undefined' && typeof slot.bids.a9.responses.size !== 'undefined' ) ? slot.bids.a9.responses.size.split("x") : slot.default_size.split("x");
				}

				//tracker for non-bidder creatives (proper media didn't win but we still have an ad)
				if(event.advertiserId != ops.proper_advertiser && event.advertiserId != ops.amazon_advertiser && event.isEmpty==false) {
					proper_render_dfp(page_number, slot_name, event.size, event.advertiserId, event.lineItemId, event.yieldGroupIds);
					//add: report ad / sticky slide up / etc
					proper_inview(event.isEmpty, page_number, slot_name, event.size, event.creativeId, event.lineItemId, event.advertiserId);
				}
			}
		  }));

		  //enable googletag
		  slot.google_tag.enableServices();

		});

		slot.dfp_init = 1;

		buildDfpSizeMapping(slot);

	}

	// Build size mapping for slots
	function buildDfpSizeMapping(slot) {

		var page = slot.page;
		//create DFP request
		slot.google_tag.cmd.push(function() {

			var sizes = [[1,1]];
			if( typeof slot.sizes !== 'undefined') {
				for(size in slot.sizes) {
					if(size == '1x1') continue; // exclude 1x1
					var w_h = size.split('x');
					w_h[0] = parseInt(w_h[0]);
					w_h[1] = parseInt(w_h[1]);
					sizes.push(w_h);
				}
			}

			//define slot
			if(checkOutOfPage(slot.name)) slot.dfp_slot = slot.google_tag.defineOutOfPageSlot('/'+ops.dfp_id+'/'+slot.name, slot.div_id).addService(slot.google_tag.pubads());
			else slot.dfp_slot = slot.google_tag.defineSlot('/'+ops.dfp_id+'/'+slot.name, sizes, slot.div_id).addService(slot.google_tag.pubads());

			var proper_slot = (page.page_number > 1) ? page.page_number+"|"+slot.number : slot.number;

			//special tracking
			if(ops.post_id_enabled == 1) {
				if(typeof page.post_id == 'undefined' || page.post_id == null || page.post_id == "") page.post_id = "unknown";
				slot.dfp_slot.setTargeting('post_id', page.post_id.toString());
			}
			if(ops.member_enabled  == 1) {
				if(typeof ops.member  == 'undefined' || ops.member == null || ops.member  == "") ops.member  = "no";
				slot.dfp_slot.setTargeting('member', ops.member);
			}

			// facebook user targeting
			// if(ops.facebook_detection == 1) slot.google_tag.pubads().setTargeting('facebook_user', facebook_user);

			//add identifiers
			slot.dfp_slot.setTargeting("split_version", ops.split_version.toString());
			slot.dfp_slot.setTargeting("is_mobile", page.is_mobile.toString());
			slot.dfp_slot.setTargeting("proper_site", ops.site_name);
			slot.dfp_slot.setTargeting("proper_slot", proper_slot);
			slot.dfp_slot.setTargeting("proper_page", page.page_number);

			// set tag targeting
			var tagArr = [];
			if(typeof page.dfp_tags !== 'undefined' && page.dfp_tags.length > 0) {
				for (var i in page.dfp_tags) {
					var k = page.dfp_tags[i];
					//add desktop/mobile support
					if(page.is_mobile == 1) tagArr.push(k+"_mobile");
					else tagArr.push(k+"_desktop");
				}
				tagArr = tagArr.concat(page.dfp_tags);
			}

			if(tagArr.length > 0) {
				//add tags to DFP request
				slot.dfp_slot.setTargeting('tags',[tagArr.toString()]);
				slot.dfp_targeting['tags'] = 1;
			} else if(slot.dfp_targeting['tags']==1) {
				//remove tags from DFP request
				slot.dfp_slot.clearTargeting("tags");
				slot.dfp_targeting['tags'] = 0;
			}

			// sticky unit
			if(slot.sticky) {
				slot.dfp_slot.setTargeting("proper_sticky", slot.sticky.toString());
			}

			// Loop through each size specific floor
			if(Object.keys(slot.floors.sizes).length > 0) {
				Object.keys(slot.floors.sizes).map(function(size) {
					var floor = slot.floors.sizes[size];
					if(floor > slot.floors.backup_floor) {
						// Round floor to price bucket
						var rounded_size_floor = round_floor(floor);
						// Add dfp targeting for size specific floor
						slot.dfp_slot.setTargeting("proper_floor_"+size, rounded_size_floor.toFixed(2).toString());
					}
				});
			}

			// Round floor to price bucket
			var rounded_slot_floor = round_floor(slot.floors.backup_floor);
			// Add dfp targeting for slot backup floor
			slot.dfp_slot.setTargeting("proper_floor", rounded_slot_floor.toFixed(2).toString());

			//track session depth
			if(page.sessionHandler.sessionData.depth > 20) page.sessionHandler.sessionData.depth = 20;
			if(page.sessionHandler.sessionData.depth > 0) slot.dfp_slot.setTargeting("s_depth", page.sessionHandler.sessionData.depth.toString());

		});

		if(slot.bids_ready == 1 && !slot.dfp_ready) {
      		addBidToDfpSlot(slot);
        }


	}

	//round to match line items
	function roundPriceToDfpBucket(price) {
		if(price > 800.00) {
			price = 800.00; // max of $800
		} else if(price > 100) {
			price = Math.ceil(price).toFixed(2); //round up to nearest dollar
		} else {
			price = (Math.ceil(price * 20)/20).toFixed(2); //round up to nearest 5 cent bucket
		}
		return price;
	}

	function addBidToDfpSlot(slot) {

		// if the slot's div isn't present in the page,
		// slot.google_tag will be undefined.
		if (typeof slot.google_tag === 'undefined') return;

		//create DFP request
		slot.google_tag.cmd.push(function() {
			// run the auction
			slot.getWinningBid();

			// check if there is a winning ad
			if(typeof slot.winning_ad.price !== 'undefined') {

				var ad = slot.winning_ad;

				var price = ad.price;
				var new_price = price;

				try {
					// Adding dynamic bid modifier
					if(
						ops.dynamic_bid_mod.hasOwnProperty('enabled') &&
						ops.dynamic_bid_mod.hasOwnProperty('range') &&
						ops.dynamic_bid_mod.hasOwnProperty('m') &&
						ops.dynamic_bid_mod.hasOwnProperty('b') &&
						ops.dynamic_bid_mod.enabled == 'true' &&
						ops.dynamic_bid_mod.range[0] <= price &&
						ops.dynamic_bid_mod.range[1] >= price
					) {
						// Calculate new Price
						new_price = parseFloat(ops.dynamic_bid_mod.m) * price + parseFloat(ops.dynamic_bid_mod.b);
					} else {
						// google tax!
						new_price = price * ops.adx_bid_modifier;
					}

					// Log old price vs new price
					slot.page.log.mylog("AdX bid modifier. ("+slot.winning_ad.bidder+", "+slot.name+"@"+slot.winning_ad.size+"). Old Price: $" + price + " New Price: $" + new_price);

					//round to match line items
					price = roundPriceToDfpBucket(new_price);

				} catch(e) {
					slot.page.log.mylog("Error adding dynamic bid modifier.");
					console.error(e);
					sendError(TraceKit.computeStackTrace(e));
				}

				slot.winning_ad.dfp_price = price;

				// logging price sent to dfp
				slot.page.log.mylog("Bid Sent to DFP ("+slot.winning_ad.bidder+", "+slot.name+"@"+slot.winning_ad.size+") = "+price+" ("+slot.precent_bids_ready+"% received, "+slot.auctionTimePassed()+" time passed)");

				// add bidder
				slot.dfp_slot.setTargeting("proper_bidder", ops.site_name+"_"+ad.bidder);

				// set targeting for new price
				slot.dfp_slot.setTargeting("proper_bid", price);

				// set refresh timeout for adx config
				var adx_refresh_interval = (slot.refresh_interval < 60000 || slot.inview == 1) ? "30" : "60";
				slot.dfp_slot.setTargeting("adx_refresh_interval", adx_refresh_interval);

			} else {
				slot.dfp_slot.clearTargeting("proper_bid");
				slot.dfp_slot.clearTargeting("proper_bidder");
				slot.page.log.mylog("Bid Sent to DFP ("+slot.name+") = 0.00"+" ("+slot.precent_bids_ready+"% received, "+slot.auctionTimePassed()+" time passed)");
			}

			// add targeting for amazon bids if they exist
			if(typeof slot.bids.a9 !== 'undefined' && typeof slot.bids.a9.responses !== 'undefined' && typeof slot.bids.a9.responses['amznbid'] !== 'undefined' && typeof slot.bids.a9.responses['amzniid'] !== 'undefined') {

				slot.dfp_slot.setTargeting("amznbid", slot.bids.a9.responses['amznbid']);
				slot.dfp_slot.setTargeting("amzniid", slot.bids.a9.responses['amzniid']);
				slot.dfp_targeting["amznslots"] = 1;

			} else if(slot.dfp_targeting["amznslots"] == 1) {
				// clear amazon on refresh
				slot.dfp_slot.clearTargeting("amznbid");
				slot.dfp_slot.clearTargeting("amzniid");
				slot.dfp_targeting["amznslots"] = 0;

			}

			// krux targeting
			if(ops.site_name == "dailydot" && typeof window.Krux !== "undefined")   {
				var kruxIds = [];
				if(typeof window.Krux.segments !== "undefined") kruxIds = kruxIds.concat(window.Krux.segments);
				if(typeof window.Krux.user !== "undefined") kruxIds.push(window.Krux.user);
				if(kruxIds.length>0) slot.dfp_slot.setTargeting("ksg", [kruxIds]);
			}


			// remove proper_floor targeting for secondary auction
			//if(typeof ops.secondary_auction !== 'undefined' && ops.secondary_auction == 1 && slot.auction_num > 0) {
				//slot.dfp_slot.clearTargeting("proper_floor");
			//}

			//exclude advertisers for refresh
			if(slot.refresh_cnt > 0) {

				var list = [];
				if(slot.advertiserId != 0) {
					list.push(slot.advertiserId); // exclude last winner
					slot.advertiserId = 0;        // reset avertiser id
				}

				list = list.concat(slot.exclude_advertiser);

				//set dfp values
				if(list.length > 0) slot.dfp_slot.setTargeting("exclude_advertiser", list);
				else if(slot.dfp_slot.getTargeting("exclude_advertiser").length > 0) slot.dfp_slot.clearTargeting("exclude_advertiser");

			//exclude google on proper_test
			} else if(typeof slot.page.get_vars.proper_dfp !== 'undefined' && slot.page.get_vars.proper_dfp == 1 && ops.testing_mode==1) {
				slot.dfp_slot.setTargeting("exclude_advertiser", [ops.google_advertiser, ops.adsense_advertiser]);
			}

			// additional targeting
			slot.dfp_slot.setTargeting("refresh_count", slot.refresh_cnt.toString());
			slot.dfp_slot.setTargeting("auction_count", slot.auction_num.toString());


			slot.dfp_ready = 1;
			if(slot.iframe_window || slot.iframe_id || typeof $('#'+slot.div_id).obj !== "undefined") {

				if(slot.page.dfp_correlator == false && slot.page.page_number > 1) {
					slot.google_tag.pubads().updateCorrelator();
					slot.page.dfp_correlator = true;
					slot.page.log.mylog("correlator updated for page: "+slot.page.page_number);
				}

				slot.page.log.mylog("display called: "+slot.name);
				// call DFP for initial auction
				if(slot.auction_num < 1 && slot.refresh_cnt < 1) {
					slot.dfp_sent = 1;
					slot.google_tag.display(slot.div_id);

				// call DFP for refresh impressions (only if we have a bid from Amazon or another bidder)
				} else if (slot.dfp_targeting["amznslots"] == 1 || typeof slot.winning_ad.price !== 'undefined' || slot.always_refresh_dfp == 1) {
					slot.google_tag.pubads().refresh([slot.dfp_slot]);
				} else {
					// Treat this as a not-filled event
					dispatchEvent({
						type: 'slot:not-filled',
						slot: slot.name
					});
				}
			}

		});
	}

	function proper_display(id, slot_options) {
		gdprConsent.ready(function() { deferred_proper_display(id, slot_options); });
	}

	function deferred_proper_display(id, slot_options) {
		// kill everything!
		if(typeof special_ops.kill_all_ads !== 'undefined' && special_ops.kill_all_ads == "yes") return false;

		//missing id (try to get it from div above this script)
		if(typeof id == "undefined") {

			try {
				//get last script called
				var scriptTag = document.scripts[document.scripts.length - 1];
				var id = scriptTag.parentNode.id;
				if(typeof scriptTag.parentNode == "undefined" || typeof id == "undefined" || id.indexOf("proper-ad-")<0) return;

				//parse ad name
				id = id.replace("proper-ad-","");
			}
			catch(e) {
				console.error(e);
				sendError(TraceKit.computeStackTrace(e));
			}

			if(typeof id == "undefined") return;
		}

		var parts       = id.split("-");
		id              = parts[0];
		var page_number = (parts.length > 1) ? parts[1] : 1;

		// check if its page exists. Create page if it doesn't
		if(pages.length < (page_number - 1)) { pages[pages.length - 1].log.mylog("Page requested is out of order: "+page_number); return };
		if(typeof pages[page_number - 1] === 'undefined') newPage();
		var page = ProperMedia.utils.getPageObjectByIndex(pages, page_number);

		if(!page) {
			return;
		}

		// Dont send bids out for this page
		if(page.dont_send_bids === true) return;

		if(typeof page.slots[id] !== 'undefined') {
			var slot = page.slots[id];
			// check that page isnt isolated and dfp is ready to be sent
			if(page.isolated != 1) {
				// Init dfp for slot
				if(!slot.dfp_init) {
					initDfp(slot);
				}
				// Add winning bid to dfp slot
				if(slot.bids_ready == 1 && !slot.dfp_ready) {
					addBidToDfpSlot(slot);
				}
				if(slot.dfp_ready == 1 && !slot.dfp_sent) {
					slot.google_tag.cmd.push(function() {
						if(page.dfp_correlator == false && page.page_number > 1) {
							slot.google_tag.pubads().updateCorrelator();
							page.dfp_correlator = true;
							page.log.mylog("correlator updated for page: "+page.page_number);
						}
						slot.page.log.mylog("display called (init): "+slot.name);
						slot.dfp_sent = 1;
						slot.google_tag.display(slot.div_id);
						// slot.google_tag.pubads().refresh([slot.dfp_slot]);
					});
				}
			} else if(page.isolated == 1 && slot.bids_ready == 1 && typeof slot.winning_ad.displayed !== 'undefined' && slot.winning_ad.displayed == 0) {
				showWinningAd(slot);
			}

		} else {
			// get slot number
			var slot_number = 1;
			for (var slot_type in ops.ad_slots) {
				for (var slot_name in ops.ad_slots[slot_type]) {
					if(slot_name == id) {
						// build slot object for page
						page.buildSlot(slot_name, slot_number, slot_type);

						if(typeof page.slots[slot_name] !== 'undefined') {

							var slot = ProperMedia.utils.getSlotFromPageObject(page, slot_name);

							if(slot) {

								// Set/override any custom slot options
								if (slot_options) {
									for (var key in slot_options) {
										slot[key] = slot_options[key];
									}
								}

								// get enabled bidders
								var data = ops.enabled_bidders[slot.auction_num] || {};

								var slots = {};
								slots[slot.name] = slot;
								setupBids(slots, data);

								if(page.isolated != 1) {
									if(slot.dfp_init == 0) initDfp(slot);
								}

								// send bids out for this slot
								sendBids(slot, 'slot', data);

							}
						}
						// exit loop
						break;
					}
					slot_number++;
				}
			}
		}
	}

	// Block Auto play video ads
	function autoplay_detect(slot) {

		//select iframe document
		var iframe = slot.getElement().querySelector("div iframe");
		if (iframe) {
			var iframeInnerSel = (iframe.contentDocument) ? iframe.contentDocument : iframe.contentWindow.document;
		} else {
			//if ad is displayed directly as a div (gumgum), check for video tags in the div
			var iframeInnerSel = slot.getElement().querySelector("div");
		}

		var ad_id = slot.div_id;

		if (iframeInnerSel && iframeInnerSel.getElementsByTagName('video').length>0) return killAd(ad_id);


		//Create Mutation object
		var MutationObserver = window.MutationObserver || window.WebKitMutationObserver || window.MozMutationObserver || false;
		if(!MutationObserver) return false;


		//build watch for <video> tags!
		var observer = new MutationObserver(function(mutations) {

			//check outer iframe
			if (iframeInnerSel.getElementsByTagName('video').length>0) return killAd(ad_id);

			//check each embedded iframe
			var frames = iframeInnerSel.getElementsByTagName("iframe");
			for(var i=0; i<frames.length; i++) {

				//check if we are already monitoring
				var fobj = frames[i];
				if(fobj.getAttribute("proper-verify")==1) continue;
				fobj.setAttribute("proper-verify", 1);

				//check contents of embedded iframe
				if(fobj.getElementsByTagName('video').length>0) return killAd(ad_id);

				//add mutation observer in case embedded iframe changes
				try {
					var iframeInnerSel2 = (fobj.contentDocument) ? fobj.contentDocument : fobj.contentWindow.document;
					
					var observer2 = new MutationObserver(function(mutations) {
						if(iframeInnerSel2.getElementsByTagName('video').length>0) return killAd(ad_id);
					});
					var observerConfig2 = { attributes: false, childList: true, characterData: false, subtree: true };
					observer2.observe(iframeInnerSel2, observerConfig2);
				} catch(err) {
					console.error(err);
					sendError(TraceKit.computeStackTrace(e));
				}
			}
		});

		
		//start watch
		var observerConfig = { attributes: false, childList: true, characterData: false, subtree: true };
		observer.observe(iframeInnerSel, observerConfig);

	}

	//kill ad completely if autoplay video is found
	function killAd(ad_id) {

		//get winning ad for tracker
		var parts = ad_id.split("-");
		var slot_name   = parts[2];
		var page_number = (parts.length > 3) ? (parseInt(parts[3])) : 1;
		var page = ProperMedia.utils.getPageObjectByIndex(pages, page_number);
		var slot = ProperMedia.utils.getSlotFromPageObject(page, slot_name);

		if(page && slot) {

			//check the whitelist
			if(ops.autoplay_whitelist.indexOf(slot.winning_ad.bidder) != -1) {
				page.log.mylog(slot.winning_ad.bidder + " video allowed via whitelist!");
				return false;
			}

			//attempt to get ad's div html
			try{ page.log.autoplay_html[slot.div_id] = $('#'+slot.div_id+' div iframe').contents().find("html").html(); }
			catch(e) {
				page.log.autoplay_html[slot.div_id] = $('#'+slot.div_id).html();
				console.error(e);
				sendError(TraceKit.computeStackTrace(e));
			}

			//block autoplay ad
			$('#'+slot.div_id).html("");

			//track data
			track_rogue(slot,"autoplay");
		}

		return false;
	}

	function track_rogue(slot,rogue_type) {

		// check if ad was from a bidder or dfp
		var ad = {};
		if(typeof slot.winning_ad.displayed !== 'undefined' && slot.winning_ad.displayed == 1) {
			ad = slot.winning_ad;
		} else {
			ad = { "bidder": "static_tag", "price" : 0, "size": "", "adcode": "[DFP STATIC TAG]" }; //static tag
		}

		//log results
		slot.page.log.mylog('rogue '+rogue_type+' detected (slot='+slot.name+", bidder="+ad.bidder+")");

		//track data after 500ms (wait for more ad units to finish)
		slot.page.log.rogue_data.push( { rogue_type: rogue_type, bidder: ad.bidder, cpm: ad.price, size: ad.size, slot: slot.name, website: ops.site_name, device: window.device.device_type, os: window.device.os_group, browser: window.device.browser_group, is_mobile: slot.page.is_mobile, tag_id: ad.tag_id, ad_details: ad.ad_details, split_version: ops.split_version } );
		clearTimeout(slot.page.log.rogue_timeout);
		slot.page.log.rogue_timeout = null;
		slot.page.log.rogue_timeout = properSetTimeout.setTimeout.call(slot.page, function() { slot.page.log.rogue_tracker(); }, slot.page.log.tracker_wait);
	}

	function showWinningAd(slot) {

		// Check if slot exists on page
		if(typeof slot.iframe_window === 'undefined'
			&& typeof slot.iframe_id === 'undefined'
			&& document.getElementById(slot.div_id) == null) return;

		var isEmpty = 1;

		if(typeof slot.winning_ad.price !== 'undefined') { //we have a winner!
			isEmpty = 0;

		} else if(ops.testing_mode == 1) { //testing mode (no ad found)

			isEmpty = 0;
			if(typeof slot.default_size == "undefined" || slot.default_size == "0x0") return;
			var s = slot.default_size.split('x');

			test_ad = new adObj(slot);
			test_ad.bidder = "unfilled";
			test_ad.size   = slot.default_size;
			test_ad.adcode = "<div style=\"text-align:center;width:"+s[0]+"px;height:"+s[1]+"px;background:#ccc;color:#000;padding-top:10px;\">-- no ad found --</div>";

			slot.winning_ad = test_ad;

		} else if(slot.refresh_cnt == 0 && slot.no_remnant_ads !== 1 && slot.sticky !== 1) { //backup ads

			var isBackupAd = build_remnant_code(slot, slot.default_size);
			isEmpty = (isBackupAd === true) ? 0 : 1;
		}

		var id = (slot.page.page_number > 1) ? slot.page.page_number+"|"+slot.number : slot.number;

		// setting placeholder size if there is now winning bid
		var winning_size = (!isEmpty) ? slot.winning_ad.size.split("x") : [0,0];

		if(isEmpty == 0) {
			var doc = slot.iframe_window ?
				slot.iframe_window.document :
				slot.iframe_id ?
				document.getElementById(slot.iframe_id).contentDocument :
				document.getElementById(slot.div_id+"-iframe") ?
				document.getElementById(slot.div_id+"-iframe").contentDocument :
				document;
			proper_render(doc.getElementById(slot.div_id), id, 1);
		} else { // Log unfilled impression
			log_unfilled(slot);
		}
	}

	//log default/unfilled impression
	function log_unfilled(slot){
		dispatchEvent({
			type: 'slot:not-filled',
			slot: slot.name
		});

		//don't log refreshes
		if(slot.refresh_cnt > 0) return;

		//track time to win ad
		var auction_ms = slot.calcAuctionMs();

		// bid data
		slot.page.log.bid_data.ad_slots[slot.name] = {
			slot_name         : validateValue(slot.name, {'type':'string','max_len':50}),
			bidder            : 'unfilled',
			price             : 0,
			gross             : 0,
			size              : validateValue(slot.default_size, {'type':'string','max_len':10}),
			refresh_cnt       : validateValue(slot.refresh_cnt, {'type':'number','max':999}),
			line_item_id      : '',
			response_ms       : validateValue(auction_ms, {'type':'number','max':999999}),
			auction_duration  : validateValue(auction_ms, {'type':'number','max':999999}),
			precent_bids_ready: validateValue(slot.precent_bids_ready, {'type':'number','max':100}),
			tag_id            : ''
		};

		proper_inview(1, slot.page.page_number, slot.name, [0,0], 0, 0, 0);

		// track data after 500ms (wait for more ad units to finish)
		clearTimeout(slot.page.log.tracker_timeout); slot.page.log.tracker_timeout = null;
		slot.page.log.tracker_timeout = properSetTimeout.setTimeout.call(slot.page, function() { slot.page.log.proper_tracker(); }, slot.page.log.tracker_wait);

	}


	// If In-View ad returned, create ad slot
	function proper_inview(isEmpty, page_number, ad_name, size, creativeId, lineItemId, advertiserId){

		// start injecting user sync pixels/frames after 3 seconds
		setTimeout(userSyncs.start, 3000);

		// Set the page object. 
		var page = pages[page_number-1];

		//auto play blocker!!!
		if(ops.autoplay_block == 1 && !isEmpty
			&& (typeof special_ops.exclude_autoplay_block == 'undefined'
			|| typeof special_ops.exclude_autoplay_block[ad_name] == 'undefined'
			|| typeof special_ops.exclude_autoplay_block[ad_name][size] == 'undefined')) {

			try {
				if(typeof page.slots[ad_name] !== 'undefined') {
					autoplay_detect(page.slots[ad_name]);
				}

			} catch(e) {
				console.error(e);
				sendError(TraceKit.computeStackTrace(e));
			}
		}

		if(typeof page.slots[ad_name] !== 'undefined') {
			var slot = page.slots[ad_name];

			//store creative and line item id
			if(!isEmpty) {
				// Log ad info
				page.log.ad_info[slot.name] = { "creative_id": creativeId, "line_item_id": lineItemId, "size": size[0]+"x"+size[1] };
			}

			//stickies (assuming it's not a remnant order responding)
			if(slot.sticky) {

				if (isEmpty) {

					if(slot.refresh_cnt == 0) $('.ad-sticky').hide();

				} else { //we have a sticky

					//store creative and line item id
					slot.displayed = 1;

					// Increment unit impression for sticky slot
                    if(ops.enable_sticky_freq_cap && slot.refresh_cnt == 0) {
                        user.stickyFreqCapHandler.incrementStickyUnitImps();
                    }

					if(typeof slot.winning_ad.bidder == 'undefined' || slot.winning_ad.displayed == 0 || (slot.winning_ad.displayed == 1 && slot.winning_ad.bidder !== 'spoutable' && slot.winning_ad.bidder !== 'gumgum' && slot.winning_ad.bidder !== 'gumgum_s2s' && slot.winning_ad.bidder !== 'justpremium')) {

						//parse ad size
						if(size[0] == 1 && size[1] == 1 && typeof slot.winning_ad.price !== 'undefined') size = slot.winning_ad.size.split("x"); // proper bidders

						var w = parseInt(size[0]);
			            var h = parseInt(size[1]);

                        // Set slot size
                        slot.size = size;
						//add 'close' and 'report ad' buttons
						if(typeof $(".ad-sticky .inner-wrapper").obj == "undefined" && w != 1 && h != 1) {

							//show proper.io brand on our properties
                            var brand = (ops.sticky_brand == "yes") ? "brand" : "";

                            var sticky_close = (ops.remove_sticky_close == "yes") ? '' : '<a class="close-ad"></a>';

							//add buttons and css
							$("#"+slot.div_id).before('<a class="'+brand+'" href="https://proper.io?from=sticky" target="_blank"></a><div class="inner-wrapper">'+sticky_close+'</div>');
							$("#"+slot.div_id).addClass('ad-wrapper');

							//close on click
							var slot_number = slot.number;
							$('.ad-sticky .close-ad').on('click', function (e) {
								e.preventDefault();

								//openClose($('.ad-sticky'), h);
								$('.ad-sticky').removeStyle();
								$('.ad-sticky').removeClass('isOpen');
								$('.ad-sticky').addClass('close');

								// log that sticky has been closed
                                if(ops.disable_sticky_on_close) {
                                    user.stickyFreqCapHandler.setStickyClosedCookie();
                                }

								// disable refresh if sticky slot is closed
								disableSlotRefresh(slot_number, page_number);
							});
						}

					 	// Remove sticky classes
                        $('.ad-sticky').removeClass("sticky-right");
                        $('.ad-sticky').removeClass("sticky-left");
                        $('.ad-sticky').removeClass("sticky-btm");
                        $('.ad-sticky').attr('style','');

                        $('.ad-sticky .inner-wrapper').attr('style','');

                        if(w > 1 && h > 1) {
                            $('.ad-sticky .inner-wrapper').attr('style', "width:"+w+"px; height:"+h+"px;");
                        }

                        // Side Sticky
                        if(w < h) {
                            $('.ad-sticky').addClass("sticky-"+ops.sticky_slot_pos);
							$('.ad-sticky').attr("style", "top: calc(50% - "+ Math.round(h/2) +"px)" );

                        // Bottom Sticky
                        } else {
                            $('.ad-sticky').addClass("sticky-btm");
                        }

						// Detect Swipe
						//swipeDetection('ad-sticky', function(el, dir) { el.style.display = 'none'; });
						// Close Swipe

						//slide in (assuming we now have a real size)
                        if(w != 1 && h != 1) {
                            properSetTimeout.setTimeout(
                                function() {
                                    onStickyLoad($('.ad-sticky'));
                                },
                                800
                            );
                        }
                        else $('.ad-sticky').hide();

					} else if(slot.winning_ad.bidder == 'gumgum' || slot.winning_ad.bidder == 'gumgum_s2s') {
						$('.ad-sticky').addClass('sticky-btm');
						$('.ad-sticky').obj.style.background = 'none';

						properSetTimeout.setTimeout(function() { onStickyLoad($('.ad-sticky')); }, 800);
					}
					else $('.ad-sticky').hide();

				}

			// Non-sticky slots
			} else if (!isEmpty) {

				//display 'report this ad' button (for our properties only)
				if(slot.report_ad_tool == 1 && slot.displayed == 0) {

					if(typeof slot.default_size != "undefined") {
						obj = $("#"+slot.div_id).obj;
						if(obj) {
							obj.style.minWidth  = slot.min_width+"px";
							obj.style.minHeight = slot.min_height+"px";
						}
					}

					$("#"+slot.div_id).after('<a href="#report-ad" data-aid="'+slot.div_id+'" class="call-modal report-ad">Report Advertisement</a>');
				}

				slot.displayed = 1;
			}

			// set displayed ts
            if(slot.displayed == 1) {
                slot.last_displayed_ts = getTimestampMs();
            }

            // Set refresh interval
            if(slot.refresh == 1 && slot.refresh_cnt < slot.refresh_max) {
                slot.setRefreshInterval();
            }

            // put winning ad back in ad array if not displayed
            if(
                !ProperMedia.utils.deepAccess(ops.bidder_info, slot.winning_ad.bidder+'.remnant') &&
                slot.winning_ad.bidder !== 'unfilled' &&
                slot.winning_ad.displayed == 0 &&
                !slot.winning_ad.checkIfExpired()
            ) {
                if(slot.adPool instanceof adPoolObj) {
                    slot.adPool.addBidToPool(slot.winning_ad);
                } else {
                    slot.ads.push(slot.winning_ad);
                }
                slot.winning_ad = {};
            }
		}
	}

	/*
		type: 0 = proper bidder, 1 = isolated page (No DFP), 2 = amazon bidder
	*/
	function proper_render(doc, id, type, price) {

		//default type
		if(typeof type == "undefined") type = 0;

		//parse ID to get page/slot info
		if(typeof id === 'string' && id.indexOf('|') >= 0) {
			var d = id.split("|"); // page number | slot number
			var page_number = d[0];
			var slot_number = d[1];
		} else {
			var page_number = 1;
			var slot_number = id;
		}

		var page    = pages[page_number - 1];
		var slot    = page.getSlotByNumber(slot_number, 'display');
		var ad_id   = slot.div_id;
		var ad      = new adObj(slot);
		var size    = [0,0];

		//get data for winning ad
		if(type == 2) { //a9

			ad.bidder = "a9";
			ad.price  = price;
			ad.size   = slot.default_size;

			// Set Size
            if(
                typeof slot.bids.a9 !== 'undefined' &&
                typeof slot.bids.a9.responses !== 'undefined' &&
                typeof slot.bids.a9.responses.size !== 'undefined'
            ) {
                ad.size = slot.bids.a9.responses.size;
            }

             size = ad.size;

		} else if(typeof slot.winning_ad.bidder !== 'undefined') {

			slot.winning_ad.displayed = 1;
            slot.exclude_bidders[slot.winning_ad.bidder] = 1;

            ad   = slot.winning_ad;
            size = slot.winning_ad.size.split("x");

            if(slot.winning_ad.size == '1x1') {
                size = ["100%","auto"];
            }

            // Prepend js to teads code for ad pooling
            if(
                ad.bidder == 'teads' &&
                slot.adPool instanceof adPoolObj &&
                ad.ad_details.hasOwnProperty('ad_code_prepend') &&
                ad.ad_details.ad_code_prepend !== ""
            ) {
                // replace macro with slot div id
                ad.adcode = ad.ad_details.ad_code_prepend.replace(/{SLOT_DIV_ID}/, slot.div_id) + ad.adcode;
            }

		}

		// If a winning bid was found
		if(ad instanceof adObj && typeof ad.bidder !== 'undefined' && ad.bidder !== '') {

			//sandbox override for facebook
			var sandbox = true;
			if(ad.bidder == "facebook") {
				sandbox = false; type = 1;
				doc = document.getElementById(ad_id);
				if(ad.size=="300x250") size = [320,270]; //override to 320x270 for new native ads
			}

			//resize outer iframe container
			var iobj = window.top.document.getElementById(slot.div_id+"-iframe");
			if(iobj) {
				iobj.style.width  = formatCssSize(size[0]);
				iobj.style.height = formatCssSize(size[1]);
			}

			if(type == 1) { //isolated mode (Not DFP)

				//build iframe and add ad code
				var div = document.createElement('div');
				var iframe = document.createElement('iframe');
				doc.innerHTML="";
				doc.appendChild(div);
				div.appendChild(iframe);

				iframe.frameBorder         = 0;
				iframe.scrolling           = "no";
				iframe.marginWidth         = "0";
				iframe.marginHeight        = "0";
				iframe.width               = size[0];
				iframe.height              = size[1];
				iframe.style.overflow      = "hidden";
				iframe.style.border        = "0px";
				iframe.style.verticalAlign = "bottom";

				if(iframe.height == "auto") {
					iframe.onload = function() {
						this.style.height = this.contentWindow.document.body.scrollHeight + 'px';
					}
				}

				if(sandbox == true) iframe.sandbox = ops.sandbox_options;

				iframe.src="javascript:\"<html><body style='background:transparent'></body></html>\"";
				var html = "<html><body>"+ad.adcode+"</body></html>";
				iframe.contentWindow.document.open();

				//enable our ad blocker
				if(typeof ops.native_blocker!=="undefined" && ops.native_blocker==1) {
					adBlocker.write(slot, iframe.contentWindow.document, html);
				}
				//run ad through confiant redirect check
				else if(typeof ops.confiant!=="undefined" && ops.confiant==1) {
					confiantWrapper.wrapTag(slot, iframe.contentWindow.document, ProperMedia.utils.mergeObject({}, ad, {adCode: html}));
				}
				//just display ad without check
				else {
					iframe.contentWindow.document.write(html);
				}
				iframe.contentWindow.document.close();

			} else if(type == 0) { //proper bidder order

				//adjust internal size
				if (doc.defaultView && doc.defaultView.frameElement) {
					var elementWidth  = size[0],
						elementHeight = size[1];

					doc.defaultView.frameElement.width  = elementWidth;
					doc.defaultView.frameElement.height = elementHeight;
				}

				//enable our ad blocker
				if(typeof ops.native_blocker!=="undefined" && ops.native_blocker==1) {
					adBlocker.write(slot, doc, ad.adcode);
					// if (slot.iframe_window) {
					// 	adBlocker.write(slot, doc, ad.adcode);
					// } else {
					// 	adBlocker.write(slot, iobj.contentWindow.document, ad.adcode);
					// }
				}
				//run ad through confiant redirect check
				else if(typeof ops.confiant!=="undefined" && ops.confiant==1) {
					confiantWrapper.wrapTag(slot, doc, ad);
				}
				//just display ad without check
				else {
					doc.write(ad.adcode);
				}

				// Resize sharethrough iframes
				if(size[1] == "auto") {
					if(iobj) {
						var iobj2 = iobj.contentWindow.document.getElementById('google_ads_iframe_/'+ops.dfp_id+'/'+slot.name+'_0')
						if(iobj2) {
                            onElementHeightChange(iobj2, function () {
                                iobj2.style.height = iobj2.contentWindow.document.body.scrollHeight + 'px';
                                iobj.style.height  = iobj.contentWindow.document.body.scrollHeight + 'px';
                            });
                        } else {
                            onElementHeightChange(iobj, function () {
                                iobj.style.height = iobj.contentWindow.document.body.scrollHeight + 'px';
                            });
                        }
					}
				}
			}

			// Set slot size
			slot.size = ad.size.split("x");
			slot.size[0] = parseInt(slot.size[0]);
			slot.size[1] = parseInt(slot.size[1]);

			//send confirmation to our tracker
			page.log.mylog("displayed! ("+slot.name+", bidder="+ad.bidder+", size="+ad.size+", price="+ad.price+")");

			// update auction time
			var auction_ms = slot.calcAuctionMs();

			// Fix the price
			var corrected_price = validateValue(ad.price, {'type': (ad.bidder == 'a9') ? 'string' : 'number', 'max':999, 'max_len':15});

			// data for report ad tool
			page.log.saved_data[slot.name] = { bidder: ad.bidder, cpm: corrected_price, size: ad.size, slot: slot.name, request_url: ad.request_url, request_response: ad.response, adcode: ad.adcode, ad_details: ad.ad_details };

			// bid data
			page.log.bid_data.ad_slots[slot.name] = {
				slot_name          : validateValue(slot.name, {'type':'string','max_len':50}),
				bidder             : validateValue(ad.bidder, {'type':'string','max_len':30}),
				gross              : validateValue(ad.gross, {'type': (ad.bidder == 'a9') ? 'string' : 'number', 'max':999, 'max_len':15}),
				price              : corrected_price,
				size               : validateValue(ad.size, {'type':'string','max_len':10}),
				refresh_cnt        : validateValue(slot.refresh_cnt, {'type':'number','max':999}),
				line_item_id       : "",
				response_ms        : validateValue(ad.response_ms, {'type':'number','max':999999}),
				auction_duration   : validateValue(auction_ms, {'type':'number','max':999999}),
				precent_bids_ready : validateValue(slot.precent_bids_ready, {'type':'number','max':100}),
				tag_id             : validateValue(ad.tag_id, {'type':'string','max_len':50})
			};

			dispatchEvent({
				type: 'slot:filled',
				slot: slot.name,
				size: ad.size,
				price: ad.price,
				bidder: ad.bidder
			});

			proper_inview(0, page.page_number, slot.name, ad.size.split("x"), 0, 0, 0);

		} else {
			log_unfilled(slot);
		}

		// track data after 500ms (wait for more ad units to finish)
		clearTimeout(page.log.tracker_timeout); page.log.tracker_timeout = null;
		page.log.tracker_timeout = properSetTimeout.setTimeout.call(page, function() { page.log.proper_tracker(); }, page.log.tracker_wait);

	}

	// DFP order won over bidder
	function proper_render_dfp(page_number, slot_name, size, advertiserId, lineItemId, yieldGroupIds) {

		//get page and slot
		var page = ProperMedia.utils.getPageObjectByIndex(pages, page_number);
		var slot = ProperMedia.utils.getSlotFromPageObject(page, slot_name);

		if(!page && !slot) {
			return;
		}

		//resize iframe
		var iobj = window.top.document.getElementById(slot.div_id+"-iframe");
		if(iobj) {
			iobj.style.width  = formatCssSize(size[0]);
			iobj.style.height = formatCssSize(size[1]);
		}

		//parse size
		var creative_size = size[0]+"x"+size[1];

		//parse bidder
		var tagId  = advertiserId;
        var bidder = "dfp";
        if(advertiserId == ops.amazon_advertiser) {
            bidder = "a9";
        } else if(advertiserId == ops.adsense_advertiser) { 
            bidder = "adsense";
        } else if(advertiserId == ops.google_advertiser || advertiserId == 1 || advertiserId == null || yieldGroupIds != null) { 
            bidder = "adx";
        }
        slot.advertiserId = advertiserId;

		//parse price
		var cpm = 0.00;
		if(bidder == "a9") { //header
			cpm = (typeof slot.bids.a9 !== 'undefined' && typeof slot.bids.a9.responses !== 'undefined' && typeof slot.bids.a9.responses['amznbid'] !== 'undefined' ) ? slot.bids.a9.responses['amznbid'] : '';
		} else if(bidder == "adx" || bidder=="adsense") { //dynamic allocation
			var floor = (slot.floors.sizes.hasOwnProperty(creative_size) && slot.floors.sizes[creative_size] > slot.floors.backup_floor) ? round_floor(slot.floors.sizes[creative_size]) : round_floor(slot.floors.backup_floor);
			if(typeof slot.winning_ad !== "undefined" && typeof slot.winning_ad.dfp_price !== "undefined" && slot.winning_ad.dfp_price > floor) {
				cpm = parseFloat(slot.winning_ad.dfp_price) + 0.01;
			} else {
				cpm = parseFloat(floor) + 0.01; // if not winning ad, it must have beat the floor at least
			}
		}

		// Set slot size
		slot.size = size;

		//send confirmation to our tracker
		page.log.mylog("displayed! DFP ("+slot.name+", bidder="+bidder+", size="+creative_size+", price: "+cpm+")");

		//track time to win ad
		var auction_ms = slot.calcAuctionMs();

		// track ads in db (used for old mysql version)
		//page.log.tracker_data.push( { bidder: bidder, cpm: cpm, size: creative_size, slot: slot.name, auction_ms: auction_ms, precent_bids_ready: slot.precent_bids_ready, website: ops.site_name, device: window.device.device_type, os: window.device.os_group, browser: window.device.browser_group, tag_id: tagId, use_ssl: page.use_ssl, is_mobile: page.is_mobile, split_version: ops.split_version } );

		// bid data
		page.log.bid_data.ad_slots[slot.name] = {
			slot_name         : validateValue(slot.name, {'type':'string','max_len':50}),
			bidder            : validateValue(bidder, {'type':'string','max_len':30}),
			price             : validateValue(cpm, {'type': (bidder == 'a9') ? 'string' : 'number', 'max':1000, 'max_len':15}),
			gross             : validateValue(cpm, {'type': (bidder == 'a9') ? 'string' : 'number', 'max':1000, 'max_len':15}),
			size              : validateValue(creative_size, {'type':'string','max_len':10}),
			refresh_cnt       : validateValue(slot.refresh_cnt, {'type':'number','max':999}),
			line_item_id      : validateValue(lineItemId, {'type':'string','max_len':15}),
			response_ms       : validateValue(auction_ms, {'type':'number','max':999999}),
			auction_duration  : validateValue(auction_ms, {'type':'number','max':999999}),
			precent_bids_ready: validateValue(slot.precent_bids_ready, {'type':'number','max':100}),
			tag_id            : validateValue(tagId, {'type':'string','max_len':50})
		};

		// data for report ad tool
		page.log.saved_data[slot.name] = { bidder: bidder, cpm: cpm, size: creative_size, slot: slot.name, request_url: "", request_response: "", adcode: "", ad_details: {} };

		dispatchEvent({
			type: 'slot:filled',
			slot: slot.name,
			size: creative_size,
			price: cpm,
			bidder: bidder
		});

		// track data after 500ms (wait for more ad units to finish)
		clearTimeout(page.log.tracker_timeout); page.log.tracker_timeout = null;
		page.log.tracker_timeout = properSetTimeout.setTimeout.call(page, function() { page.log.proper_tracker(); }, 500);

	}


	// Run Secondary Auction
	function proper_secondary(doc, id) {

		// if secondary auction is enabled
		if(typeof ops.secondary_auction !== 'undefined' && ops.secondary_auction == 1) {

			if(typeof id === 'string' && id.indexOf('|') >= 0) {
				var d = id.split("|");  // page number | slot number
				var page_number = d[0];
				var slot_number = d[1];
			} else {
				var page_number = 1;
				var slot_number = id;
			}

			var page = ProperMedia.utils.getPageObjectByIndex(pages, page_number);

			if(!page) {
				return;
			}

			var slot = page.getSlotByNumber(slot_number, 'display');

			slot.auction_num++;

			// check if new bid came in
			slot.getWinningBid();
			if(typeof slot.winning_ad.price !== 'undefined') {
				showWinningAd(slot); return; // show winning ad
			}

			page.log.mylog("Running secondary auction: "+slot.name);

			// remove refresh timeout until secondary auction finishes
			slot.removeRefreshTimeout();

			slot.bids = {}; slot.bids_ready = 0; slot.wait_count = 0; slot.displayed = 0;

			// resend auction to secondary bidders
			// get enabled bidders
			var data = ops.enabled_bidders[slot.auction_num] || {};

			var slots = {};
			slots[slot.name] = slot;
			setupBids(slots, data);

			// send bids out for this slot
			sendBids(slot, 'slot', data);

		}
	}


	//remnant passbacks!
	function proper_remnant(doc, id) {

		//parse ID to get page/slot info
		if(typeof id === 'string' && id.indexOf('|') >= 0) {
			var d = id.split("|"); // page number | slot number
			var page_number = d[0];
			var slot_number = d[1];
		} else {
			var page_number = 1;
			var slot_number = id;
		}

		var page  = pages[page_number - 1];
		var slot  = page.getSlotByNumber(slot_number, 'display');
		var ad_id = slot.div_id;

		//stickies should never have remnant ads
		if(slot.sticky || slot.no_remnant_ads === 1) { 
			log_unfilled(slot); 
			return; 
		}

		// build remnant code
		var isBackupAd = build_remnant_code(slot, slot.default_size);
		if(isBackupAd == false) { 
			log_unfilled(slot); 
			return; 
		}

		//display ad
		var id = (slot.page.page_number > 1) ? slot.page.page_number+"|"+slot.number : slot.number;
		var doc = slot.iframe_window ?
			slot.iframe_window.document :
			slot.iframe_id ?
			top.document.getElementById(slot.iframe_id).contentDocument :
			top.document.getElementById(slot.div_id+"-iframe") ?
			top.document.getElementById(slot.div_id+"-iframe").contentDocument :
			top.document;
		proper_render(doc.getElementById(slot.div_id), id, 1);
	}


	function bangerang(slot_number, page_number, loop_number) {

		var page = ProperMedia.utils.getPageObjectByIndex(pages, page_number);

		if(!page) {
			return;
		}

		var slot = page.getSlotByNumber(slot_number, 'display');

		//create DFP request
		slot.google_tag.cmd.push(function() {

			if(page.isolated == 0 && typeof slot !== 'undefined') {

				// slot.google_tag.destroySlots([slot.dfp_slot]);

				// Get winning bid
				slot.banger_loop = loop_number;
				if(slot.banger_loop == 1) slot.getWinningBid();

				// Get Slot Sizes
				// var sizes = [[1,1]];
				// if( slot.sizes !== 'undefined') {
				//  for(size in slot.sizes) {
				//      if(size == '1x1') continue; // exclude 1x1
				//      var w_h = size.split('x');
				//      w_h[0] = parseInt(w_h[0]);
				//      w_h[1] = parseInt(w_h[1]);
				//      sizes.push(w_h);
				//  }
				// }

				// var loop_name = slot.name+'_L'+loop_number;

				// slot.dfp_slot = slot.google_tag.defineSlot('/'+ops.dfp_id+'/'+loop_name, sizes, slot.div_id).addService(slot.google_tag.pubads());

				// slot.dfp_slot.setTargeting("proper_slot", slot.number);
				// slot.dfp_slot.setTargeting("proper_page", page.page_number);

				// check if there is a winning bid
				if(typeof slot.winning_ad.dfp_price !== 'undefined') {
					// set targeting for proper_bidder
					slot.dfp_slot.setTargeting("proper_bid", slot.winning_ad.dfp_price);
				}

				slot.page.log.mylog("(Banger Loop: "+loop_number+" slot: "+slot.name+")");

				slot.dfp_slot.setTargeting("bang_loop", loop_number.toString());

				slot.google_tag.pubads().refresh([slot.dfp_slot]);

			}
		});
	}

	// disable refresh for slot
	function disableSlotRefresh(slot_number, page_number) {
		var page = ProperMedia.utils.getPageObjectByIndex(pages, page_number);

		if(!page) {
			return;
		}

		var slot = page.getSlotByNumber(slot_number, 'display');

		if(slot) {
			slot.refresh = 0;
			slot.removeRefreshTimeout();
		}
	}

	//Setup sticky transition
	function onStickyLoad(el) {
		el.addClass("open");

		/* Modernizr function */
		function whichTransitionEvent(){
			var t;
			var f = document.createElement('fakeelement');
			var transitions = {
			  'transition':'transitionend',
			  'OTransition':'oTransitionEnd',
			  'MozTransition':'transitionend',
			  'WebkitTransition':'webkitTransitionEnd'
			}

			for(t in transitions){
				if( f.style[t] !== undefined ){
					return transitions[t];
				}
			}
		}

		var transitionEvent = whichTransitionEvent();
		if(transitionEvent) {
			el.on(transitionEvent, function(e) {
				if (el.hasClass('open')) { el.addClass('isOpen'); el.removeClass('open'); }
				else if (el.hasClass('close')) { el.addClass('isClosed'); el.removeClass('close'); }
			});
		}
	}

	function build_remnant_code(slot,size) {

		var backupAd = {};
		var code = "";
		var bidder = "remnant_rubicon";

		//remnant - adsense
		if(typeof ops.site_ids['remnant_adsense'] !== "undefined" && typeof slot.bids['remnant_adsense'] !== 'undefined' && typeof slot.bids['remnant_adsense'].requests !== 'undefined' && slot.page.isolated!=1) {

			//loop through and grab smallest size that we have an ID for
			if(typeof slot.bids['remnant_adsense'].requests[size] === 'undefined'){
				var min = 0;
				// Loop through sizes
				for(var tmpSize in slot.bids['remnant_adsense'].requests) {
					var s = tmpSize.split('x');
					if((s[0]*s[1]) < min || min == 0) {
						size = tmpSize;
						min = s[0]*s[1];
					}
				}
			}

			//override mobile unit with 300x250 if it exists
			if(size == "320x50" && typeof slot.bids['remnant_adsense'].requests["300x250"] != 'undefined') size = "300x250";


			bidder = "remnant_adsense";
			var site_id = ops.site_ids['remnant_adsense'];
			var slot_id = slot.bids['remnant_adsense'].requests[size];
			var s       = size.split("x");

			code += "<script async src='//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js'></script>";
			code += "<!-- adsense remnant -->";
			code += "<ins class='adsbygoogle' style='display:inline-block;width:"+s[0]+"px;height:"+s[1]+"px' data-ad-client='ca-pub-"+site_id+"' data-ad-slot='"+slot_id+"'></ins>";
			code += "<script>";
			code += "(adsbygoogle = window.adsbygoogle || []).push({});";
			if (gdprConsent.noPersonalization) {
				// disable personalized ads
				code += "window.adsbygoogle.requestNonPersonalizedAds=1;";
			}
			code += "</script>";

		}
		//remnant - rubicon
		else if(typeof ops.site_ids['remnant_rubicon'] !== "undefined" && typeof slot.bids['remnant_rubicon'] !== 'undefined' && typeof slot.bids['remnant_rubicon'].requests !== 'undefined' && (special_ops.remnant_rubicon_only_when_isolated !== 1 || slot.page.isolated === 1)) {

			//loop through and grab smallest size that we have an ID for
			if(typeof slot.bids['remnant_rubicon'].requests[size] === 'undefined'){
				var min = 0;
				// Loop through sizes
				for(var tmpSize in slot.bids['remnant_rubicon'].requests) {
					var s = tmpSize.split('x');
					if((s[0]*s[1]) < min || min == 0) {
						size = tmpSize;
						min = s[0]*s[1];
					}
				}
			}

			//override mobile unit with 300x250 if it exists
			if(size == "320x50" && typeof slot.bids['remnant_rubicon'].requests["300x250"] != 'undefined') size = "300x250";


			if(typeof slot.bids['remnant_rubicon'].requests[size] !== 'undefined') {

				var rp_site = ops.site_ids['remnant_rubicon'],
					rp_zonesize = slot.bids['remnant_rubicon'].requests[size];

				code += "<script language='JavaScript' type='text/javascript'>";
				code += "rp_account   = '8777';";
				code += "rp_site      = '"+rp_site+"';";
				code += "rp_zonesize  = '"+rp_zonesize+"';";
				code += "rp_adtype    = 'js';";
				code += "rp_smartfile = '[SMART FILE URL]';";
				code += "</script>";
				code += "<script type='text/javascript' src='"+document.location.protocol+"//ads.rubiconproject.com/ad/8777.js'></script>";


			}
		}
		//remnant - adx (always use unless an isolated page)
		else if(slot.page.isolated!=1) {

			bidder = "remnant_adx";
			var s = size.split("x");
			s[0] = parseInt(s[1]) || NaN;
			s[1] = parseInt(s[1]) || NaN;

			if(
                !isNaN(s[0]) &&
                !isNaN(s[1]) &&
                s[0] > 1 &&
                s[1] > 1
            ) {
				code += "<script type='text/javascript'><!--" + "\n";
				code += "google_ad_client = 'ca-pub-6897902191714833';" + "\n";
				code += "/* Remnant */" + "\n";
				code += "google_ad_slot = '5140430151';" + "\n";
				code += "google_ad_width = "+s[0]+";" + "\n";
				code += "google_ad_height = "+s[1]+";" + "\n";
				code += "//-->" + "\n";
				code += "</script>";
        		code += "<script type='text/javascript' src='//pagead2.googlesyndication.com/pagead/show_ads.js";
	        	if (gdprConsent.noPersonalization) {
	          		// disable personalized ads
	          		code += "?npa=1";
	        	}
			  	code += "'></script>";
      		}
		}
		//remnant - house ads
		else {
			// @todo: add house ads here
			return false;
		}


		//add code as winning ad
		backupAd = new adObj(slot);
		backupAd.bidder = bidder;
		backupAd.size   = size;
		backupAd.adcode = code;
		backupAd.price  = 0.01;
		backupAd.gross  = 0.01;

		slot.winning_ad = backupAd;

		return true;

	}

	// Load google tag script
	function load_google_tag(id) {



	}

	function proper_log(id, page_number) {

		id = id || "proper";
		page_number = page_number || "all";

		//output pages object
		if(id == "pages") {
			console.log(pages);
			return;
		}

		function getResponses() {

			var output = [];

			var slots = pages[0].slots;

			for(var slot_name in slots) {
				var slot = slots[slot_name];
				if(slot instanceof slotObj) {
					for (var ad_id = 0; ad_id < slot.ads.length; ad_id++) {
						var response = slot.ads[ad_id];
						var row = adObjToOutput(response);

                        if(ProperMedia.utils.indexOfObjectInArray(output, row) === -1) {
                            output.push(row);
                        }
					}
				}

				if(slot.winning_ad instanceof adObj) {
					var row = adObjToOutput(slot.winning_ad);

                    if(ProperMedia.utils.indexOfObjectInArray(output, row) === -1) {
                        output.push(row);
                    }
				}
			}

			return output;

			function adObjToOutput(response) {
				return {
					'slot_name'   : response.slot.name,
					'size'        : response.size,
					'bidder'      : response.bidder,
					'time'        : response.response_ms,
					'floor'       : response.floor,
					'cpm'         : response.price,
					'dfp_price'   : response.dfp_price,
					'gross'       : response.gross,
					'price'       : response.price,
					'tag_id'      : response.tag_id,
					'refresh_cnt' : response.slot.refresh_cnt,
					'displayed'   : response.displayed
				};
			}

		}

		//output bids table
		if(id == "bid_table") {
			var output = getResponses();

			if (output.length) {
				if (console.table) {
					console.table(output);
				} else {
					for (var j = 0; j < output.length; j++) {
						console.log(output[j]);
					}
				}
			} else {
				console.warn('No responses');
			}
			return;
		}

		//save bids table to csv
		if(id == "bid_table_csv") {
			var output = getResponses();

			if (output.length) {
				csv_output = "";

				header_keys = Object.keys(output[0]);
				for (var j = 0; j < header_keys.length; j++) {
					csv_output += '"' + header_keys[j] + '"' + (j < header_keys.length - 1 ? ',' : '');
				}
				for (var j = 0; j < output.length; j++) {
					csv_output += "\n" + '"' + Object.values(output[j]).join('","') + '"';
				}

				var element = document.createElement('a');
				element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(csv_output));
				element.setAttribute('download', "proper_bid_table_" + document.location.hostname + ".csv"); //filename

				element.style.display = 'none';
				document.body.appendChild(element);

				element.click();

				document.body.removeChild(element);
			} else {
				console.warn('No responses');
			}
			return;
		}

		//turn on console
		//logger.enableLogger();

		//cookie check
		if(id == "on") {

			id = "proper";

			//setup cookie to expire in 1 day
			var date  = new Date();
			var hours = 1; //expire in x hours
			date.setTime(date.getTime()+(hours*60*60*1000));

			document.cookie="proper_log=1; expires="+date.toGMTString()+"; path=/;";
			console.log("NOTICE: Turning on persistent logging. Run proper_log('off'); to turn off.");

		} else if(id == "off") {

			id = "proper";
			console.log("NOTICE: Turning off persistent logging.");
			document.cookie = "proper_log=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
			//logger.disableLogger();
			if(page_number !== "all" && typeof pages[page_number] !== 'undefined') {
				var page = pages[page_number];
				page.get_vars[id] = 0;
			} else {
				for (var i = 0; i < pages.length; i++) {
					pages[i].get_vars[id] = 0;
				}
			}
			return false;
		}

		//output saved log for (proper, sovrn, brealtime, aol, etc.)
		if(page_number !== "all" && typeof pages[page_number] !== 'undefined') {
			var page = pages[page_number];
			for(var x in page.log.log_lines[id]) {
				if(page.log.log_lines[id][x]) console.log(page.log.log_lines[id][x]);
				//turn on live console ouput for additional logs that come through after this
				page.get_vars[id] = 1;
			}
		} else {
			for (var i = 0; i < pages.length; i++) {
				for(var x in pages[i].log.log_lines[id]) {
					if(pages[i].log.log_lines[id][x]) console.log(pages[i].log.log_lines[id][x]);
				}
				//turn on live console ouput for additional logs that come through after this
				pages[i].get_vars[id] = 1;
			}
		}

		//turn off console
		//logger.disableLogger();

		return true;
	}

	/*
	 * Get slot's floor for bidder and size list. Includes rev_share
	 * @param sizeList 	string|array 	List of sizes
	 */
	function get_floor(bidder, slot, sizeList) {

		try {

			var floor = 0;
			// Get array of sizes
			var sizes = ((typeof sizeList === "string") ? sizeList.split(",") : ((sizeList instanceof Array) ? sizeList : []));

			// If there are sizes
			if(sizes.length > 0) {
				// Use lowest floor
				for(var x in sizes) {
					var size_floor = (slot.floors.sizes.hasOwnProperty(size)) ? slot.floors.sizes[size] : slot.floors.backup_floor;
					floor = (floor == 0 || size_floor < floor) ? size_floor : floor;
				}
			} else {
				floor = slot.floors.backup_floor;
			}

			// Add rev share
			if( ops.bidder_info[bidder] && ops.bidder_info[bidder].rev_share && ops.bidder_info[bidder].rev_share > 0) floor = parseFloat((floor / ops.bidder_info[bidder].rev_share).toFixed(2));

		} catch(e) {
			floor = ops.backup_floor;
			console.error(e);
			sendError(TraceKit.computeStackTrace(e));
		}

		// return floor
		return floor;
	}


	/*
	//round using this scale (these are the price floor tiers we have in our dynamic remnant DFP order)
	0.10
	0.25
	0.40
	0.50 (every 25 cents)
	0.75
	1.00
	1.25
	1.50
	1.75
	2.00 (every 50 cents)
	2.50
	3.00
	3.50
	4.00
	4.50
	5.00
	*/
	function round_floor(val) {

		val = parseFloat(val);

		//round based on scale
		if(!val || val=="") val=ops.backup_floor;
		else if(val <= 0.10) val = 0.10;
		else if(val <= 0.25) val = 0.25;
		else if(val <= 0.40) val = 0.40;
		else if(val <= 2.00) val = (Math.ceil(val * 4) / 4).toFixed(2); //every 25 cents (1/4 dollar)
		else if(val <= 5.00) val = (Math.ceil(val * 2) / 2).toFixed(2); //every 50 cents (1/2 dollar)
		else val = 5.00;

		return round(val,2);
	}

	function round(value, decimals) {
	  return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
	}

	//~~~~~~~~~~~~~~~~~~~~
	// HELPER FUNCTIONS

	function onElementHeightChange(elm, callback) {
        var lastHeight = elm.contentWindow.document.body.scrollHeight || 0,
            newHeight  = elm.contentWindow.document.body.scrollHeight || 0,
            count      = 0,
            max_count  = 10,
            iframe_def_height = 150;

        function runElementHeightChange() {
            newHeight = elm.contentWindow.document.body.scrollHeight || 0;
            if( (lastHeight != newHeight && newHeight != iframe_def_height) || count >= max_count) {
                if( elm.onElementHeightChangeTimer ){
                    clearTimeout(elm.onElementHeightChangeTimer);
                }
                callback();
                return;
            }
            lastHeight = newHeight;
            count++;

            if( elm.onElementHeightChangeTimer ){
                clearTimeout(elm.onElementHeightChangeTimer);
            }

            elm.onElementHeightChangeTimer = properSetTimeout.setTimeout(runElementHeightChange, 200);
        }
        runElementHeightChange();
    }

	function formatCssSize(size) {
		return (typeof size == "string" && (size.indexOf("%") !== -1 || size == 'auto')) ? size : size + "px";
	}

	function sortSizes(a,b) {
		var t1 = a.split("x");
		var t2 = b.split("x");
		a = parseInt(t1[0])+parseInt(t1[1]);
		b = parseInt(t2[0])+parseInt(t2[1]);
		return a>b;
	}

	//pulsepoint functions
	function getPosition(obj) {
	  var xPosition = 0;
	  var yPosition = 0;
	  var element = document.querySelector(obj);

	  while(element){
		xPosition += (element.offsetLeft - element.scrollLeft + element.clientLeft);
		yPosition += (element.offsetTop - element.scrollTop + element.clientTop);
		element = element.offsetParent;
	  }

	  return xPosition+","+yPosition;
	}

	function getPageUrl() {
		try { return window.top.location.href; }
		catch (e) {return window.location.href; }
	}

	function getPageDomain() {
		try { return window.location.hostname.replace(/^www\./,""); }
		catch (e) {return ""; }
	}

	function matchDomain(domain, url) {

		//parse domain from url
		if(url.indexOf('/') !== -1) {
			var a = url.split('/');
			if(typeof a[2] !== "undefined") url = a[2];
		}
		if(url.indexOf('?') !== -1) {
			var b = url.split('?');
			if(typeof b[0] !== "undefined") url = b[0];
		}

		//direct matches
		if(domain == url) return true;

		//subdomain check -> ends with (ie: .proper.io in local.proper.io)
		if(endsWith(domain, '.'+url)==true) return true;
		if(endsWith(url, '.'+domain)==true) return true;

		//no match
		return false;
	}

	function endsWith(str, suffix) {
		return str.indexOf(suffix, str.length - suffix.length) !== -1;
	}

	function getPagePath() {
		try { return window.top.location.pathname; }
		catch (e) {return window.location.pathname; }
	}

	function checkOutOfPage(ad_unit) {
		var suffix = "_oop";
		return ad_unit.toLowerCase().indexOf(suffix, ad_unit.length - suffix.length) !== -1;
	}

	function isIOS() {

		var iDevices = ['iPad Simulator', 'iPhone Simulator', 'iPod Simulator', 'iPad', 'iPhone', 'iPod'];
		if (!!navigator.platform) {
			while (iDevices.length) { if (navigator.platform === iDevices.pop()){ return true; } }
		}

		return false;
	}

	function getUrlParameters(url) {
		var data = decodeURIComponent(url).split('&');

		var res = {};
		for (var i = 0; i < data.length; i++) {
			var parm = data[i].split('=');
			res[parm[0]] = parm[1];
		}

		return res;
	}

	function getCookies() {
		var res = {};

		var data = document.cookie; if(typeof data === 'undefined') return res;

		data = data.split(';');
		for (var i = 0; i < data.length; i++) {
			var parm = data[i].split('=');
			if(parm.length > 1) res[parm[0].trim()] = parm[1].trim();
		}

		return res;
	}

	function getCookieValue(a) {
		var b = document.cookie.match('(^|;)\\s*' + a + '\\s*=\\s*([^;]+)');
		return b ? b.pop() : undefined;
	}

	// get timestamp in ms
	function getTimestampMs() {
		var d = new Date();
		return d.getTime();
	}

	function calcResponseMs(start,finish) {
		return (start > 0 && finish > 0 && finish > start) ? finish - start : -1;
	}

	function formatDate() {
		now    = new Date();
		year   = "" + now.getFullYear();
		month  = "" + (now.getMonth() + 1); if (month.length == 1) { month = "0" + month; }
		day    = "" + now.getDate(); if (day.length == 1) { day = "0" + day; }
		hour   = "" + now.getHours(); if (hour.length == 1) { hour = "0" + hour; }
		minute = "" + now.getMinutes(); if (minute.length == 1) { minute = "0" + minute; }
		second = "" + now.getSeconds(); if (second.length == 1) { second = "0" + second; }
		return year + "-" + month + "-" + day + " " + hour + ":" + minute + ":" + second;
	}

	function checkData(arr) {
		if(typeof arr == 'undefined' || (!(arr instanceof Array) && !(arr instanceof Object)) )  arr = [];
		return arr;
	}

	function generateUUID(){
		var d = new Date().getTime();
		if(window.performance && typeof window.performance.now === "function"){
			d += performance.now(); //use high-precision timer if available
		}
		var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
			var r = (d + Math.random()*16)%16 | 0;
			d = Math.floor(d/16);
			return (c=='x' ? r : (r&0x3|0x8)).toString(16);
		});
		return uuid;
	}

	// Validate values to be sent to reporting endpoint
	function validateValue(variable, validation_rules) {

		if(validation_rules['type'] === 'string') {
			var default_val = (typeof validation_rules['default_val'] === 'string') ? validation_rules['default_val'] : '';
			var max_len = (typeof validation_rules['max_len'] === 'number') ? validation_rules['max_len'] : 256;
			var min_len = (typeof validation_rules['min_len'] === 'number') ? validation_rules['min_len'] : 0;

			if(typeof variable === 'number') {
				variable = variable.toString();
			}

			if(typeof variable !== 'string') {
				variable = default_val;
			}

			if(variable.length > max_len) {
				variable = variable.substring(0, max_len);
			}

		} else if(validation_rules['type'] === 'number') {
			var default_val = (typeof validation_rules['default_val'] === 'number') ? validation_rules['default_val'] : 0;
			var max = (typeof validation_rules['max'] === 'number') ? validation_rules['max'] : 99999;
			var min = (typeof validation_rules['min'] === 'number') ? validation_rules['min'] : 0;

			if(typeof variable === 'string' && /^(\d+)?(\.\d+)$/.test(variable)) {
				variable = (variable.indexOf('.') > -1) ? parseFloat(variable) : parseInt(variable);
			}

			if(typeof variable !== 'number') {
				variable = default_val;
			}

			if(variable > max) {
				variable = max;
			}

			if(variable < min) {
				variable = min;
			}

		} else if(validation_rules['type'] === 'boolean') {
			var default_val = (typeof validation_rules['default_val'] === 'boolean') ? validation_rules['default_val'] : false;

			if(typeof variable === 'number') {
				if(variable === 0) {
					variable = false;
				} else if(variable === 1) {
					variable = true;
				}
			} else if(typeof variable === 'string') {
				if(variable === 'false' || variable === '0') {
					variable = false;
				} else if(variable === 'true' || variable === '1') {
					variable = true;
				}
			}

			if(typeof variable !== 'boolean') {
				variable = default_val;
			}
		}

		return variable;
	}

	// HELPER FUNCTIONS
	//~~~~~~~~~~~~~~~~~~~~

	// Get Data for Report Ad tool
	function getReportAdInfo(obj) {

		var retData = {};

		// get site name
		if(typeof obj.site_name !== 'undefined' && obj.site_name == 1) {
			retData.site_name = ops.site_name;
		}

		// get split version
		if(typeof obj.split_version !== 'undefined' && obj.split_version == 1) {
			retData.split_version = ops.split_version;
		}

		if(typeof obj.slot_id !== 'undefined') {
			var parts       = obj.slot_id.replace('proper-ad-','').split("-");
			var slot_name   = parts[0];
			var page_number = (parts.length > 3) ? parseInt(parts[3]) : 1;
			var page = ProperMedia.utils.getPageObjectByIndex(pages, page_number);

			if(page) {
				// autoplay html
				if(page.log.autoplay_html[obj.slot_id]) {
					retData.autoplay_html = page.log.autoplay_html[obj.slot_id];
				}

				// log lines
				if(typeof page.log.log_lines !== 'undefined') {
					retData.log_lines = page.log.log_lines;
				}

				// saved data
				if(typeof page.log.saved_data[slot_name] !== 'undefined') {
					retData.saved_data = page.log.saved_data[slot_name];
				}

				// saved data
				if(typeof page.log.ad_info[slot_name] !== 'undefined') {
					retData.ad_info = page.log.ad_info[slot_name];
				}
			}
		}
		return retData;
	}

	function logMatchingResponse(bidder, proper_uid, bidder_uid) {
		cookieMatching.logMatchingResponse(bidder, proper_uid, bidder_uid);
	}

	function getAdSlots() {
		return Object.keys(pages[0].slots);
	}

	function refreshSlotByName(slot_name, page_number) {
        // init page number
        if(!page_number) {
            var parts = ProperMedia.utils.extractSlotNameAndPageNumber(slot_name);
            slot_name = parts.slot_name;
            page_number = parts.page_number;
        }

        var page = ProperMedia.utils.getPageObjectByIndex(pages, page_number);
        if(page) {
            var slot = ProperMedia.utils.getSlotFromPageObject(page, slot_name);
            if(slot) {
                slot.removeRefreshTimeout();
                slot.refreshSlot();
            }
        }
    }

	function getOutstreamSettings() {
		return ops.outstream_settings;
	}

	function setVideoCallback(video_type, _callback) {

		// Outstream Video
		if(video_type == 'outstream' &&
			typeof ops.outstream_settings.slot_name !== 'undefined' &&
			typeof pages[0].slots[ops.outstream_settings.slot_name] !== 'undefined'
		) {
			slot = pages[0].slots[ops.outstream_settings.slot_name];
			slot._videoCallback = _callback;
			slot.checkVideoAuction();
		// Instream Video
		} else if(video_type == 'instream' &&
			typeof ops.instream_settings.slot_name !== 'undefined' &&
			typeof pages[0].slots[ops.instream_settings.slot_name] !== 'undefined'
		) {
			slot = pages[0].slots[ops.instream_settings.slot_name];
			slot._videoCallback = _callback;
			slot.checkVideoAuction();
		} else {
			_callback(false);
		}

	}

	//export funcitons
	return {
		'set_options'          : set_options,
		'proper_log'           : proper_log,
		'proper_display'       : proper_display,
		'_c1xResponse'         : _c1xResponse,
		'proper_render'        : proper_render,
		'proper_secondary'     : proper_secondary,
		'proper_remnant'       : proper_remnant,
		'bangerang'            : bangerang,
		'logMatchingResponse'  : logMatchingResponse,
		'disableSlotRefresh'   : disableSlotRefresh,
		'send_bidders'         : send_bidders,
		'getReportAdInfo'      : getReportAdInfo,
		'getAdSlots'           : getAdSlots,
		'refreshSlotByName'    : refreshSlotByName,
		'subscribeToEvents'    : subscribeToEvents,
		'setVideoCallback'     : setVideoCallback,
		'getOutstreamSettings' : getOutstreamSettings,
		'sendError'            : sendError
	}

})(window, document);


//make functions global
var proper_log          = ProperMedia.ad_project.proper_log;
var proper_display      = ProperMedia.ad_project.proper_display;
var proper_render       = ProperMedia.ad_project.proper_render;
var proper_secondary    = ProperMedia.ad_project.proper_secondary;
var proper_remnant      = ProperMedia.ad_project.proper_remnant;
var disableSlotRefresh  = ProperMedia.ad_project.disableSlotRefresh;
var logMatchingResponse = ProperMedia.ad_project.logMatchingResponse;
var bangerang           = ProperMedia.ad_project.bangerang;
var _c1xResponse        = ProperMedia.ad_project._c1xResponse; //c1x callback

ProperMedia.report_ad = (function ($, properSetTimeout) {

  //global variables
  var ad_id = "";

  //listen for post messages from iframe
  if (window.addEventListener) addEventListener("message", TraceKit.wrap(listener), false);
  else attachEvent("onmessage", TraceKit.wrap(listener));

  function listener(event){
   
    //process message from main window
    if(typeof event == 'undefined' || typeof event.data == 'undefined') return false; 
    var msg = event.data.toString();
    var data = [];

    if(msg!="" && msg.indexOf('|')>=0) {
      data = msg.split("|");
      msg = data[0];
    }

    if(msg=="SubmitAdReport") submit(data[1], data[2]);
    else if(msg=="CloseAdReport") close();
  }


  //"Report Advertisement" link
  if (document.addEventListener) document.addEventListener( "click", TraceKit.wrap(someListener) );
  else document.attachEvent("onclick", TraceKit.wrap(someListener));

  function someListener(e){

    var eventReference = (typeof e !== "undefined")? e : event
    var element = eventReference.target;
    var found = 0;

    if(typeof element !== 'undefined') {
      //check if our button was clicked
      if(document.documentElement.classList) { //modern browsers
        if(element.classList.contains("report-ad")) found=1;
      }
      else if(typeof element.className !== 'undefined' && element.className.indexOf("report-ad") > -1) found=1;
    }


    if(found==1) {

      e.preventDefault();

      //highlight ad unit
      ad_id = element.getAttribute("data-aid");
      $('#'+ad_id).addClass('active-highlight');

      //create/show modal
      if(typeof $('#ProperMediaAdModal').obj === 'undefined') {

        // get site_name from ad_project
        var retData = ProperMedia.ad_project.getReportAdInfo( {'site_name' : 1, 'split_version' : 1} );
        var site_name = (typeof retData.site_name !== 'undefined') ? retData.site_name : '';
        var split_version = (typeof retData.split_version !== 'undefined') ? retData.split_version : '';

        var iframe = document.createElement('iframe');
        iframe.src = 'https://proper.io/adproject/report.php?pub='+site_name+'&split_version='+split_version;
        iframe.id = "ProperMediaAdModal";
        iframe.style.width = "100%";
        iframe.style.height = "100%";
        iframe.style.position = "fixed";
        iframe.style.display = "block";
        iframe.style.zIndex = 2147483647;
        iframe.style.top = 0;
        iframe.style.left = 0;
        iframe.style.right = 0;
        iframe.style.bottom = 0;
        iframe.frameBorder = 0;

        //keep iframe to 100% of window
        if (iframe.attachEvent) {
            iframe.attachEvent("onload", resizeIframe);
        } else {
            iframe.onload=resizeIframe;
        }

        window.onresize = resizeIframe;
        document.body.appendChild(iframe);
      }
      else {
        document.getElementById('ProperMediaAdModal').contentWindow.postMessage("showForm","*");
        $('#ProperMediaAdModal').show();
      }

    }

  }

  function resizeIframe() {
    var height = window.innerHeight;
    height = (height < 0) ? 0 : height;
    document.getElementById('ProperMediaAdModal').style.height = height + 'px';
  }

  function pageY(elem) {
      return elem.offsetParent ? (elem.offsetTop + pageY(elem.offsetParent)) : elem.offsetTop;
  }


  //close form
  function close() {
      $('#ProperMediaAdModal').hide();
      $('#'+ad_id).removeClass('active-highlight');
  }

  // Prepare report post data
  function prepareReportData(issue,comment) {
    //fixing escape character
    comment = comment.replace("[proper-separator]","|");

    //get user's browser size
    var resolution = $(window).width()+"x"+$(window).height(); 

    //attempt to get ad's div html
    var div_html = "";
    try{ 
      div_html = $('#'+ad_id+' div iframe').contents().find("html").html(); 
    } catch(e) { 
      div_html = $('#'+ad_id).html(); 
    }

    // get data from ad_project
    var retData = ProperMedia.ad_project.getReportAdInfo( {'slot_id' : ad_id, 'site_name' : 1} );
    var site_name = (typeof retData.site_name !== 'undefined') ? retData.site_name : '';

    //add on html from autoplay block
    if(typeof retData.autoplay_html !== 'undefined' && retData.autoplay_html != '') div_html += retData.autoplay_html;
    unit_name = ad_id.replace("proper-ad-","");

    //parse ad displayed from bidder
    var log_lines  = (typeof retData.log_lines  !== 'undefined') ? retData.log_lines  : { 'proper' : '' }; 

    var saved_data = {}; var source = "dfp";
    if(typeof retData.saved_data !== 'undefined') {
      var saved_data = retData.saved_data;
      var source     = "bidder";
    }

    var bidder           = (typeof saved_data.bidder           !== 'undefined') ? saved_data.bidder           : "";
    var size             = (typeof saved_data.size             !== 'undefined') ? saved_data.size             : "";
    var request_url      = (typeof saved_data.request_url      !== 'undefined') ? saved_data.request_url      : "";
    var request_response = (typeof saved_data.request_response !== 'undefined') ? saved_data.request_response : "";
    var adcode           = (typeof saved_data.adcode           !== 'undefined') ? saved_data.adcode           : "";

    //parse DFP info
    var ad_info      = (typeof retData.ad_info      !== 'undefined') ? retData.ad_info      : {};
    var line_item_id = (typeof ad_info.line_item_id !== 'undefined') ? ad_info.line_item_id : "";
    var creative_id  = (typeof ad_info.creative_id  !== 'undefined') ? ad_info.creative_id  : "";

    if(source == "dfp" && typeof ad_info.size !== 'undefined') size = ad_info.size;

    //prepare post data
    return { 'ajax':1, 'website':site_name, 'ad_id': unit_name, 'source':source, 'bidder': bidder, 'request_url':request_url, 'request_response':request_response, 'adcode':adcode, 'size':size, 'line_item_id':line_item_id, 'creative_id':creative_id, 'comment':comment, 'issue':issue, 'resolution':resolution, 'os':window.device.os, 'os_group':window.device.os_group, 'browser':window.device.browser, 'browser_group':window.device.browser_group, 'log':log_lines['proper'], 'div_html':div_html };
  }

  //Submit Report Ad
  //If silent is set to true, the report will be sent programatically without user interaction
  function submit(issue,comment) {

    var post_data = prepareReportData(issue,comment);

    //send request
    $.ajax({
      url: 'https://proper.io/ajax/adreport.php', 
      method: "POST",
      data: JSON.stringify(post_data),
      success: function(resp) {

          console.log("ad report sent!");

          //send success message to iframe
          document.getElementById('ProperMediaAdModal').contentWindow.postMessage("success","*");
        },
        error: function(resp) {

          console.log('ajax error');

        }
    });

  }

  if (window.location.search.includes('proper_log_redirects=1')) {
    var _wasUnloadLogged = false;
    function logPageUnload()
    {
        if (!_wasUnloadLogged &&
          !document.activeElement.href &&
          document.activeElement.nodeName != 'IFRAME' &&
          document.activeElement.nodeName != 'BUTTON')
        {
          _wasUnloadLogged = true;

          //Record the original ad_id in case someone hit a report button somehow before the redirect
          var original_ad_id = ad_id;

          ProperMedia.ad_project.getAdSlots().forEach(function(el){
            
            ad_id = el;
            var post_data = prepareReportData('redirect','Automatically generated');
            
            if (typeof navigator.sendBeacon == 'function') {
                console.log('Proper Redirect Sent (beacon)');
                navigator.sendBeacon('https://proper.io/ajax/adreport.php', JSON.stringify(post_data));
            } else {
                console.log('Proper Redirect Sent (xhr)');
                var request = new XMLHttpRequest();
                request.open('POST', 'https://proper.io/ajax/adreport.php', false);  // `false` makes the request synchronous
                request.send(JSON.stringify(post_data));
            }

          });

          ad_id = original_ad_id;
        }
    }

    window.onbeforeunload = function (e) {
        //this will work only for Chrome
        logPageUnload();
    };

    window.onunload = function (e) {
        //this will work for other browsers
        logPageUnload();
    };

    var pagebeforehideHandler;
    window.addEventListener("pagebeforehide", pagebeforehideHandler = TraceKit.wrap(function(evt){
        //iOS Safari
        logPageUnload();
    }), false);

    var pagehideHandler;
    window.addEventListener("pagehide", pagehideHandler = TraceKit.wrap(function(evt){
        //iOS Safari
        logPageUnload();
    }), false);

    properSetTimeout.setTimeout(function(){
      window.onbeforeunload = null;
      window.onunload = null;
      window.removeEventListener("pagebeforehide", pagebeforehideHandler, false);
      window.removeEventListener("pagehide", pagehideHandler, false);
    }, 8000);
  }

  //export funcitons
  return {
    'submit' : submit,
    'close' : close,
  }

})(ProperMedia.utils.jquery, ProperMedia.utils.properSetTimeout);


//setup special options
var special_ops = special_ops || {};

special_ops.optional_ads = ["sitepoint_overlay_1","sitepoint_overlay_2","sitepoint_overlay_bottom_1","sitepoint_overlay_bottom_2","sitepoint_overlay_bottom_3","sitepoint_overlay_top"];

//Set Options
ProperMedia.ad_project.set_options({
ad_retry_max : 6,
autoplay_block : 0,
backup_floor : 0.51,
backup_stickies : 0,
blocker_sample_data : 0,
blocker_sample_rate : 0,
capture_blocked_html : 0,
confiant : 0,
desktop_adx_bid_mod : 1.1,
desktop_floor : 0.10,
domain : "sitepoint.com",
domain_protection : 0,
exclude_dfp_refresh : 0,
exclude_google_refresh : 0,
facebook_detection : 0,
full_refresh : 1,
gdpr_consent : 1,
inview_refresh_interval : 30000,
isolated : 0,
isolated_urls : special_ops.isolated_urls,
member : 0,
member_sticky_desktop : "0",
member_sticky_mobile : "0",
mobile_ad_retry_max : 6,
mobile_adx_bid_mod : 1.1,
mobile_floor : 0.10,
mobile_resolution : 768,
native_blocker : 0,
native_blocker_desktop : 0,
page_type : 0,
possible_ads : 0,
post_id : 0,
refresh : 1,
refresh_interval : 60000,
refresh_max : 10,
refresh_points : [],
remove_sticky_close : "no",
report_ads : 1,
rtp_file_revision : "1.62.1",
sandbox_iframe : 1,
sandbox_options : "allow-pointer-lock allow-popups allow-same-origin allow-scripts",
secondary_auction : 0,
site_name : "sitepoint",
split_version : 11864,
sticky_brand : "yes",
sticky_slot : 18,
sticky_slot_pos : "left",
tags : 0,
viewable_ad_refresh : 0,
optional_ads : special_ops.optional_ads,
ad_slot_options : special_ops.ad_slot_options,
outstream_settings : {
    "outstream": 0,
    "slot_name": "",
    "exclude_dfp": 1,
    "sound_on_hover": 0,
    "expand_collapse": 0,
    "placement_selector": ""
},
ad_slot_settings : {
    "sitepoint_main_1": {
        "inview_ad_refresh": 1,
        "inview_refresh_interval": 10000,
        "refresh_interval": 20000
    },
    "sitepoint_side_3": {
        "inview_refresh_interval": 10000,
        "refresh_interval": 20000
    }
},
ad_pools : [
    [
        "sitepoint_home_1",
        "sitepoint_home_2",
        "sitepoint_home_3",
        "sitepoint_home_4"
    ],
    [
        "sitepoint_content_1",
        "sitepoint_content_2",
        "sitepoint_content_3"
    ],
    [
        "sitepoint_side_1",
        "sitepoint_side_2",
        "sitepoint_side_3",
        "sitepoint_sponsor_1"
    ]
],
ast_settings : {
    "appnexus": 1,
    "districtm": 1
},
site_ids : {
    "rubicon": 208370,
    "gumgum_s2s": "7lonx3hj",
    "conversant": 125147
},
floors : {
    "728x90": "",
    "300x250": "",
    "320x50": "",
    "336x280": "",
    "160x600": "",
    "300x600": 1,
    "970x250": 4,
    "1x1": "",
    "320x100": ""
},
sticky_floors : {
    "320x50": 0.5,
    "728x90": 0.5,
    "160x600": 0.5
},
ad_slots : {
    display : {
        "sitepoint_billboard" : { 
            1001 : [],
            1000 : ["728x90","970x250"],
            768 : ["728x90"]
        },
        "sitepoint_sponsor_1" : { 
            768 : ["160x600","1x1","300x250","300x600"],
            0 : []
        },
        "sitepoint_overlay_bottom_3" : { 
            768 : ["1x1","300x250"],
            0 : []
        },
        "sitepoint_overlay_bottom_2" : { 
            768 : ["970x250"],
            0 : []
        },
        "sitepoint_overlay_bottom_1" : { 
            768 : ["728x90"],
            0 : []
        },
        "sitepoint_overlay_top" : { 
            768 : ["1x1","300x250"],
            0 : []
        },
        "sitepoint_overlay_2" : { 
            768 : ["1x1","300x250","300x600"],
            0 : []
        },
        "sitepoint_overlay_1" : { 
            768 : ["1x1","300x250"],
            0 : ["1x1","300x250"]
        },
        "sitepoint_home_4" : { 
            768 : ["300x250"],
            0 : []
        },
        "sitepoint_content_3" : { 
            768 : ["300x250","336x280","728x90"],
            0 : ["300x250","320x50","336x280"]
        },
        "sitepoint_content_2" : { 
            768 : ["300x250","336x280","728x90"],
            0 : ["300x250","320x50","336x280"]
        },
        "sitepoint_side_3" : { 
            768 : ["160x600","1x1","300x250","300x600"],
            0 : []
        },
        "sitepoint_side_2" : { 
            768 : ["160x600","1x1","300x250","300x600"],
            0 : []
        },
        "sitepoint_side_1" : { 
            768 : ["160x600","1x1","300x250","300x600"],
            0 : []
        },
        "sitepoint_home_1" : { 
            768 : ["728x90"],
            0 : ["300x250","320x50","336x280"]
        },
        "sitepoint_home_2" : { 
            768 : ["728x90"],
            0 : ["300x250","320x50","336x280"]
        },
        "sitepoint_home_3" : { 
            768 : ["728x90"],
            0 : ["300x250","320x50","336x280"]
        },
        "sitepoint_main_1" : { 
            1490 : ["160x600"],
            768 : ["728x90"],
            0 : ["320x50"]
        },
        "sitepoint_content_1" : { 
            768 : ["1x1","728x90","fluid"],
            0 : ["1x1","300x250","320x50","336x280","fluid"]
        },
        "sitepoint_sticky_1" : { 
            1220 : ["160x600","1x1"],
            0 : ["1x1","320x100","320x50"]
        },
        "sitepoint_community_home" : { 
            768 : ["728x90"],
            0 : ["300x250","320x50","336x280"]
        },
        "sitepoint_community_1" : { 
            768 : ["300x250","336x280","728x90"],
            0 : ["300x250","320x50","336x280"]
        },
    },
},
ad_pos : {
    "sitepoint_billboard": "atf",
    "sitepoint_sponsor_1": "atf",
    "sitepoint_overlay_bottom_3": "atf",
    "sitepoint_overlay_bottom_2": "atf",
    "sitepoint_overlay_bottom_1": "atf",
    "sitepoint_overlay_top": "atf",
    "sitepoint_overlay_2": "atf",
    "sitepoint_overlay_1": "atf",
    "sitepoint_home_4": "atf",
    "sitepoint_content_3": "atf",
    "sitepoint_content_2": "btf",
    "sitepoint_side_3": "btf",
    "sitepoint_side_2": "atf",
    "sitepoint_side_1": "atf",
    "sitepoint_home_1": "atf",
    "sitepoint_home_2": "atf",
    "sitepoint_home_3": "atf",
    "sitepoint_main_1": "atf",
    "sitepoint_content_1": "atf",
    "sitepoint_sticky_1": "btf",
    "sitepoint_community_home": "atf",
    "sitepoint_community_1": "atf"
},
ad_ids : {
    "sitepoint_billboard@728x90": {
        "a9": "1",
        "appnexus": "15764214",
        "criteo": "1334741",
        "openx": "540718186",
        "pubmatic": "1",
        "rubicon": "1268856",
        "districtm": "15938004",
        "index": "368966",
        "emx": "57373",
        "districtmdmx": "365352",
        "aol": "5084803",
        "conversant": "1"
    },
    "sitepoint_billboard@970x250": {
        "a9": "1",
        "appnexus": "15764214",
        "criteo": "1334743",
        "openx": "540718186",
        "pubmatic": "1",
        "rubicon": "1268856",
        "districtm": "15938004",
        "index": "368967",
        "emx": "57373",
        "districtmdmx": "365352",
        "aol": "5084801",
        "conversant": "1"
    },
    "sitepoint_community_1@300x250": {
        "index": "292665-281",
        "pubmatic": "1",
        "districtm": "13808831",
        "appnexus": "13833290",
        "openx": "540227187",
        "rubicon": "1025552",
        "aol": "4932642",
        "mantis": "1",
        "criteo": "1334735",
        "districtmdmx": "238679",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_community_1@336x280": {
        "criteo": "1334740"
    },
    "sitepoint_community_1@728x90": {
        "index": "292666-282",
        "pubmatic": "1",
        "districtm": "13808831",
        "appnexus": "13833290",
        "openx": "540227187",
        "rubicon": "1025552",
        "aol": "4932661",
        "mantis": "1",
        "criteo": "1334741",
        "districtmdmx": "238679",
        "lockerdome": "11391537129161574",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_community_home@728x90": {
        "index": "292667-283",
        "pubmatic": "1",
        "districtm": "13808832",
        "appnexus": "13833287",
        "openx": "540227188",
        "rubicon": "1025556",
        "aol": "5084799",
        "mantis": "1",
        "criteo": "1334741",
        "districtmdmx": "238680",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_content_1@728x90": {
        "index": "292669-285",
        "pubmatic": "1",
        "districtm": "13808833",
        "appnexus": "13833289",
        "openx": "540227189",
        "rubicon": "1025560",
        "aol": "4932657",
        "sharethrough": "xzM7KQRND3zjEpeyPQ6SZLaG",
        "mantis": "1",
        "criteo": "1334741",
        "districtmdmx": "238681",
        "a9": "1",
        "teads": "109063-100750",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_content_2@300x250": {
        "rubicon": "1034960",
        "pubmatic": "1",
        "districtm": "13849695",
        "index": "296069-400",
        "aol": "4932650",
        "appnexus": "13833282",
        "openx": "540255303",
        "mantis": "1",
        "criteo": "1334735",
        "districtmdmx": "241377",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_content_2@336x280": {
        "criteo": "1334740"
    },
    "sitepoint_content_2@728x90": {
        "appnexus": "13833295",
        "openx": "540255303",
        "rubicon": "1034960",
        "pubmatic": "1",
        "districtm": "13849695",
        "index": "296070-401",
        "aol": "4932654",
        "mantis": "1",
        "criteo": "1334741",
        "districtmdmx": "241377",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_content_3@300x250": {
        "rubicon": "1034964",
        "pubmatic": "1",
        "districtm": "13849696",
        "index": "296071-402",
        "aol": "4932645",
        "appnexus": "13833283",
        "openx": "540255304",
        "mantis": "1",
        "criteo": "1334735",
        "districtmdmx": "241378",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_content_3@336x280": {
        "criteo": "1334740"
    },
    "sitepoint_content_3@728x90": {
        "appnexus": "13833296",
        "openx": "540255304",
        "rubicon": "1034964",
        "pubmatic": "1",
        "districtm": "13849696",
        "index": "296072-403",
        "aol": "4932659",
        "mantis": "1",
        "criteo": "1334741",
        "districtmdmx": "241378",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_home_1@728x90": {
        "index": "292670-286",
        "pubmatic": "1",
        "districtm": "13808834",
        "appnexus": "13833284",
        "openx": "540227190",
        "rubicon": "1025564",
        "aol": "4932649",
        "mantis": "1",
        "criteo": "1334741",
        "districtmdmx": "238682",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_home_2@728x90": {
        "index": "292671-287",
        "pubmatic": "1",
        "districtm": "13808835",
        "appnexus": "13833288",
        "openx": "540227191",
        "rubicon": "1025568",
        "aol": "4932643",
        "mantis": "1",
        "criteo": "1334741",
        "districtmdmx": "238683",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_home_3@728x90": {
        "index": "292672-288",
        "pubmatic": "1",
        "districtm": "13808836",
        "appnexus": "13833291",
        "openx": "540227192",
        "rubicon": "1025572",
        "aol": "4932660",
        "mantis": "1",
        "criteo": "1334741",
        "districtmdmx": "238684",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_home_4@300x250": {
        "appnexus": "13850576",
        "openx": "540268965",
        "rubicon": "1039222",
        "aol": "4949565",
        "pubmatic": "1",
        "districtm": "13984704",
        "mantis": "1",
        "criteo": "1334735",
        "districtmdmx": "248638",
        "a9": "1",
        "index": "302414",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_main_1@160x600": {
        "a9": "1",
        "districtm": "13808837",
        "mantis": "1",
        "pubmatic": "1",
        "rubicon": "1025576",
        "openx": "540227193",
        "appnexus": "13809688",
        "criteo": "1334734",
        "index": "368969",
        "emx": "57373",
        "aol": "5084802",
        "conversant": "1"
    },
    "sitepoint_main_1@728x90": {
        "index": "292673-289",
        "pubmatic": "1",
        "districtm": "13808837",
        "appnexus": "13833285",
        "openx": "540227193",
        "rubicon": "1025576",
        "aol": "4932644",
        "mantis": "1",
        "criteo": "1334741",
        "districtmdmx": "238685",
        "lockerdome": "11391538068685670",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_overlay_1@300x250": {
        "criteo": "1334735",
        "aol": "5034554",
        "lockerdome": "11566011619196262",
        "sharethrough": "dSY3CVEkAskCB7hpDSA6GzPL",
        "districtm": "14870715",
        "a9": "1",
        "emx": "57373",
        "districtmdmx": "320008",
        "conversant": "1"
    },
    "sitepoint_overlay_2@300x250": {
        "criteo": "1334735",
        "aol": "5034554",
        "lockerdome": "11566011619196262",
        "sharethrough": "dSY3CVEkAskCB7hpDSA6GzPL",
        "districtm": "14870715",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_overlay_2@300x600": {
        "criteo": "1334736",
        "aol": "5034553",
        "lockerdome": "11566023631682918",
        "districtm": "14870717",
        "a9": "1",
        "emx": "57373",
        "districtmdmx": "320010",
        "conversant": "1"
    },
    "sitepoint_overlay_bottom_1@728x90": {
        "criteo": "1334741",
        "aol": "5034552",
        "lockerdome": "11566020209130854",
        "districtm": "14870723",
        "a9": "1",
        "emx": "57373",
        "districtmdmx": "320012",
        "conversant": "1"
    },
    "sitepoint_overlay_bottom_2@970x250": {
        "criteo": "1334743",
        "aol": "5034555",
        "lockerdome": "11566021014437222",
        "districtm": "14870725",
        "a9": "1",
        "emx": "57373",
        "districtmdmx": "320013",
        "conversant": "1"
    },
    "sitepoint_overlay_bottom_3@300x250": {
        "criteo": "1334735",
        "aol": "5034551",
        "lockerdome": "11566021752634726",
        "sharethrough": "Q2E6R3T4k2CRCwRhnqsxQTTu",
        "districtm": "14870726",
        "a9": "1",
        "emx": "57373",
        "districtmdmx": "320014",
        "conversant": "1"
    },
    "sitepoint_overlay_top@300x250": {
        "criteo": "1334735",
        "aol": "5034556",
        "lockerdome": "11566024436989286",
        "sharethrough": "Mrf7NH2LEpUDAcAuS7pxZs1z",
        "districtm": "14870721",
        "a9": "1",
        "emx": "57373",
        "districtmdmx": "320011",
        "conversant": "1"
    },
    "sitepoint_side_1@160x600": {
        "appnexus": "13833293",
        "openx": "540245957",
        "rubicon": "1034014",
        "districtm": "13849669",
        "aol": "5084797",
        "pubmatic": "1",
        "mantis": "1",
        "criteo": "1334734",
        "districtmdmx": "241354",
        "a9": "1",
        "index": "302415",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_side_1@300x250": {
        "index": "293713-300",
        "appnexus": "13833293",
        "openx": "540245957",
        "rubicon": "1034014",
        "pubmatic": "1",
        "districtm": "13849669",
        "aol": "5084804",
        "mantis": "1",
        "criteo": "1334735",
        "districtmdmx": "241354",
        "lockerdome": "11391537196276070",
        "sharethrough": "4HbyfcfAHYdtxztBFSGw2R5H",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_side_1@300x600": {
        "index": "293714-301",
        "appnexus": "13833293",
        "openx": "540245957",
        "rubicon": "1034014",
        "pubmatic": "1",
        "districtm": "13849669",
        "aol": "5084800",
        "mantis": "1",
        "criteo": "1334736",
        "districtmdmx": "241354",
        "lockerdome": "11391534713248102",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_side_2@160x600": {
        "appnexus": "13833294",
        "openx": "540245958",
        "rubicon": "1034018",
        "districtm": "13849673",
        "aol": "4949563",
        "pubmatic": "1",
        "mantis": "1",
        "criteo": "1334734",
        "districtmdmx": "241355",
        "a9": "1",
        "index": "302425",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_side_2@300x250": {
        "index": "293716-302",
        "appnexus": "13833294",
        "openx": "540245958",
        "rubicon": "1034018",
        "pubmatic": "1",
        "districtm": "13849673",
        "aol": "4932653",
        "sharethrough": "yfrWn1uJ1o7Vy8XjksvBJh1f",
        "mantis": "1",
        "criteo": "1334735",
        "districtmdmx": "241355",
        "lockerdome": "11391533941496166",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_side_2@300x600": {
        "index": "293717-303",
        "appnexus": "13833294",
        "openx": "540245958",
        "rubicon": "1034018",
        "pubmatic": "1",
        "districtm": "13849673",
        "aol": "4932658",
        "mantis": "1",
        "criteo": "1334736",
        "districtmdmx": "241355",
        "lockerdome": "11391533136189798",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_side_3@160x600": {
        "index": "293718-304",
        "appnexus": "13833292",
        "openx": "540245959",
        "rubicon": "1034022",
        "pubmatic": "1",
        "districtm": "13849674",
        "aol": "4932652",
        "mantis": "1",
        "criteo": "1334734",
        "districtmdmx": "241356",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_side_3@300x250": {
        "index": "293719-305",
        "appnexus": "13833292",
        "openx": "540245959",
        "rubicon": "1034022",
        "pubmatic": "1",
        "districtm": "13849674",
        "aol": "4932651",
        "sharethrough": "ztRYQNd1XFRdvaY2LN1XhZ7A",
        "mantis": "1",
        "criteo": "1334735",
        "districtmdmx": "241356",
        "lockerdome": "11391532330883430",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_side_3@300x600": {
        "index": "293720-306",
        "appnexus": "13833292",
        "openx": "540245959",
        "rubicon": "1034022",
        "pubmatic": "1",
        "districtm": "13849674",
        "aol": "4932648",
        "mantis": "1",
        "criteo": "1334736",
        "districtmdmx": "241356",
        "lockerdome": "11391531190032742",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_sponsor_1@160x600": {
        "appnexus": "14952816",
        "openx": "540601492",
        "mantis": "1",
        "pubmatic": "1",
        "rubicon": "1196544",
        "criteo": "1334734",
        "districtm": "14966568",
        "index": "342211",
        "a9": "1",
        "aol": "5053118",
        "emx": "57373",
        "districtmdmx": "323569",
        "conversant": "1"
    },
    "sitepoint_sponsor_1@300x250": {
        "appnexus": "14952816",
        "openx": "540601492",
        "mantis": "1",
        "pubmatic": "1",
        "rubicon": "1196544",
        "criteo": "1334735",
        "sharethrough": "ZoLVVQgPY2hTMhiSdWem8yci",
        "districtm": "14966568",
        "index": "342212",
        "a9": "1",
        "aol": "5053117",
        "emx": "57373",
        "districtmdmx": "323569",
        "conversant": "1"
    },
    "sitepoint_sponsor_1@300x600": {
        "appnexus": "14952816",
        "openx": "540601492",
        "mantis": "1",
        "pubmatic": "1",
        "rubicon": "1196544",
        "criteo": "1334736",
        "districtm": "14966568",
        "index": "342213",
        "a9": "1",
        "aol": "5053116",
        "emx": "57373",
        "districtmdmx": "323569",
        "conversant": "1"
    },
    "sitepoint_sticky_1@160x600": {
        "index": "292674-290",
        "pubmatic": "1",
        "districtm": "13808838",
        "appnexus": "13833286",
        "openx": "540227194",
        "rubicon": "1025580",
        "aol": "4932646",
        "mantis": "1",
        "criteo": "1334734",
        "districtmdmx": "238686",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_sticky_1@1x1": {
        "s2s": "1"
    }
},
mobile_ids : {
    "sitepoint_community_1@300x250": {
        "index": "292675-291",
        "pubmatic": "1",
        "districtm": "13808839",
        "appnexus": "13833290",
        "openx": "540227195",
        "rubicon": "1025554",
        "aol": "4932632",
        "mantis": "1",
        "criteo": "1334735",
        "districtmdmx": "238687",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_community_1@320x50": {
        "appnexus": "13775788",
        "openx": "540227195",
        "index": "292676-292",
        "pubmatic": "1",
        "districtm": "13808839",
        "rubicon": "1025554",
        "aol": "4932630",
        "mantis": "1",
        "criteo": "1334737",
        "districtmdmx": "238687",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_community_1@336x280": {
        "appnexus": "13833290",
        "openx": "540227195",
        "rubicon": "1025554",
        "criteo": "1334740"
    },
    "sitepoint_community_home@300x250": {
        "appnexus": "13775782",
        "openx": "540227196",
        "index": "292677-293",
        "pubmatic": "1",
        "districtm": "13808840",
        "rubicon": "1025558",
        "aol": "4932626",
        "mantis": "1",
        "criteo": "1334735",
        "districtmdmx": "238688",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_community_home@320x50": {
        "appnexus": "13775782",
        "openx": "540227196",
        "index": "292678-294",
        "pubmatic": "1",
        "districtm": "13808840",
        "rubicon": "1025558",
        "mantis": "1",
        "criteo": "1334737",
        "districtmdmx": "238688",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_community_home@336x280": {
        "rubicon": "1025558",
        "criteo": "1334740"
    },
    "sitepoint_content_1@300x250": {
        "index": "292679-295",
        "pubmatic": "1",
        "districtm": "13808841",
        "appnexus": "13833289",
        "openx": "540227197",
        "rubicon": "1025562",
        "sharethrough": "SknMrEB72kSx92VRPJBmCxDp",
        "mantis": "1",
        "criteo": "1334735",
        "districtmdmx": "238689",
        "a9": "1",
        "teads": "109063-100750",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_content_1@320x50": {
        "appnexus": "13775786",
        "openx": "540227197",
        "index": "292680-296",
        "pubmatic": "1",
        "districtm": "13808841",
        "rubicon": "1025562",
        "aol": "4932639",
        "mantis": "1",
        "criteo": "1334737",
        "districtmdmx": "238689",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_content_1@336x280": {
        "appnexus": "13833289",
        "openx": "540227197",
        "rubicon": "1025562",
        "criteo": "1334740"
    },
    "sitepoint_content_2@300x250": {
        "rubicon": "1034962",
        "pubmatic": "1",
        "districtm": "13849697",
        "index": "296073-404",
        "aol": "4932634",
        "appnexus": "13833295",
        "openx": "540313348",
        "mantis": "1",
        "criteo": "1334735",
        "districtmdmx": "241379",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_content_2@320x50": {
        "pubmatic": "1",
        "districtm": "13849697",
        "index": "296074-405",
        "aol": "4932629",
        "appnexus": "13833295",
        "openx": "540313348",
        "rubicon": "1034962",
        "mantis": "1",
        "criteo": "1334737",
        "districtmdmx": "241379",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_content_2@336x280": {
        "rubicon": "1034962",
        "criteo": "1334740"
    },
    "sitepoint_content_3@300x250": {
        "rubicon": "1034966",
        "pubmatic": "1",
        "districtm": "13849698",
        "index": "296075-406",
        "aol": "4932623",
        "appnexus": "13833296",
        "openx": "540313349",
        "mantis": "1",
        "criteo": "1334735",
        "districtmdmx": "241380",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_content_3@320x50": {
        "pubmatic": "1",
        "districtm": "13849698",
        "index": "296076-407",
        "aol": "4932641",
        "appnexus": "13833296",
        "openx": "540313349",
        "rubicon": "1034966",
        "mantis": "1",
        "criteo": "1334737",
        "districtmdmx": "241380",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_content_3@336x280": {
        "rubicon": "1034966",
        "criteo": "1334740"
    },
    "sitepoint_home_1@300x250": {
        "appnexus": "13775776",
        "openx": "540227198",
        "index": "292681-297",
        "pubmatic": "1",
        "districtm": "13808842",
        "rubicon": "1025566",
        "aol": "5084674",
        "mantis": "1",
        "criteo": "1334735",
        "districtmdmx": "238690",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_home_1@320x50": {
        "appnexus": "13775776",
        "openx": "540227198",
        "index": "292682-298",
        "pubmatic": "1",
        "districtm": "13808842",
        "rubicon": "1025566",
        "aol": "5084673",
        "mantis": "1",
        "criteo": "1334737",
        "districtmdmx": "238690",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_home_1@336x280": {
        "rubicon": "1025566",
        "criteo": "1334740"
    },
    "sitepoint_home_2@300x250": {
        "appnexus": "13775784",
        "openx": "540227199",
        "index": "292683-299",
        "pubmatic": "1",
        "districtm": "13808843",
        "rubicon": "1025570",
        "aol": "5084671",
        "mantis": "1",
        "criteo": "1334735",
        "districtmdmx": "238691",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_home_2@320x50": {
        "appnexus": "13775784",
        "openx": "540227199",
        "index": "292684-300",
        "pubmatic": "1",
        "districtm": "13808843",
        "rubicon": "1025570",
        "aol": "5084672",
        "mantis": "1",
        "criteo": "1334737",
        "districtmdmx": "238691",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_home_2@336x280": {
        "rubicon": "1025570",
        "criteo": "1334740"
    },
    "sitepoint_home_3@300x250": {
        "appnexus": "13775790",
        "openx": "540227200",
        "index": "292685-301",
        "pubmatic": "1",
        "districtm": "13808844",
        "rubicon": "1025574",
        "aol": "4932636",
        "mantis": "1",
        "criteo": "1334735",
        "districtmdmx": "238692",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_home_3@320x50": {
        "appnexus": "13775790",
        "openx": "540227200",
        "index": "292686-302",
        "pubmatic": "1",
        "districtm": "13808844",
        "rubicon": "1025574",
        "aol": "4932638",
        "mantis": "1",
        "criteo": "1334737",
        "districtmdmx": "238692",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_home_3@336x280": {
        "rubicon": "1025574",
        "criteo": "1334740"
    },
    "sitepoint_main_1@320x50": {
        "appnexus": "13775778",
        "openx": "540227201",
        "index": "292688-304",
        "pubmatic": "1",
        "districtm": "13808845",
        "rubicon": "1025578",
        "aol": "4932628",
        "mantis": "1",
        "criteo": "1334737",
        "districtmdmx": "238693",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    },
    "sitepoint_overlay_1@300x250": {
        "lockerdome": "11566012357393766",
        "criteo": "1334735",
        "mantis": "1",
        "aol": "5034557",
        "districtm": "14870716",
        "a9": "1",
        "emx": "57373",
        "districtmdmx": "320009",
        "conversant": "1"
    },
    "sitepoint_sticky_1@1x1": {
        "s2s": "1"
    },
    "sitepoint_sticky_1@320x100": {
        "rubicon": "1025582",
        "criteo": "1334738"
    },
    "sitepoint_sticky_1@320x50": {
        "appnexus": "13775780",
        "openx": "540227202",
        "index": "292689-305",
        "pubmatic": "1",
        "districtm": "13808846",
        "rubicon": "1025582",
        "aol": "4932633",
        "mantis": "1",
        "criteo": "1334737",
        "districtmdmx": "238694",
        "a9": "1",
        "emx": "57373",
        "conversant": "1"
    }
}
});

/******* CALL BIDDERS *********/
ProperMedia.ad_project.send_bidders([
    {
        "rubicon": 1,
        "aol": 1,
        "appnexus": 1,
        "pubmatic": 1,
        "index": 1,
        "districtm": 1,
        "openx": 1,
        "a9": 1,
        "sharethrough": 1,
        "mantis": 1,
        "criteo": 1,
        "conversant": 1,
        "s2s": 1,
        "districtmdmx": 1,
        "lockerdome": 1,
        "teads": 1,
        "emx": 1
    }
]);
} catch (e) {
	console.error(e);
	if(typeof TraceKit !== "undefined") {
		TraceKit.report(e); //error with stack trace gets normalized and sent to subscriber
	}
}
